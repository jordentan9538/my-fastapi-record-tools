<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>放贷记录后台</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600&display=swap');
        :root {
            --color-bg: #f7f9fb;
            --color-surface: #ffffff;
            --color-surface-alt: #eef3fb;
            --color-primary: #2b7de9;
            --color-primary-contrast: #ffffff;
            --color-muted: #51657d;
            --color-border: #c3cfe2;
            --shadow-soft: 0 2px 6px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            background: var(--color-bg);
            color: #1f3b57;
            min-height: 100vh;
            position: relative;
            line-height: 1.5;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(195, 208, 248, 0.9);
            border: 1px solid #e0e6f0;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: 0 6px 18px rgba(15,23,42,0.08);
        }
        .top-bar strong { font-size: 1.05rem; }
        .top-bar-user { display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap; }
        .top-bar-prefix { font-size: 0.9rem; color: var(--color-muted); }
        .role-tag {
            display: inline-flex;
            margin-left: 0.5rem;
            padding: 0.1rem 0.65rem;
            border-radius: 999px;
            background: #e3edff;
            font-size: 0.8rem;
            color: #1f3b57;
        }
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .top-bar-actions a {
            text-decoration: none;
            color: #1976d2;
            font-weight: 600;
        }
        .top-bar-actions form {
            margin: 0;
        }
        .top-bar-actions button {
            border: none;
            background: #f44336;
            color: #fff;
            padding: 0.5rem 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-image: linear-gradient(135deg, rgba(43,125,233,0.12), rgba(255,255,255,0.45)), url('https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1800&q=60');
            background-size: cover;
            background-position: center;
            opacity: 0.25;
            z-index: -2;
        }
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, rgba(247,249,251,0.95), rgba(247,249,251,0.98));
            z-index: -1;
        }
        h1 { color: #1f3b57; margin-top: 0; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: #16263c; color: #fff; padding: 2rem 1rem; box-shadow: 2px 0 8px rgba(0,0,0,0.15); position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
        .sidebar h2 { font-size: 1.1rem; margin-bottom: 1rem; }
        .menu-btn { width: 100%; padding: 0.65rem 1rem; margin-bottom: 0.5rem; border: none; border-radius: 8px; background: transparent; color: #dbe6ff; text-align: left; cursor: pointer; transition: background 0.2s; box-shadow: none; font-weight: 500; }
        .menu-btn:hover { background: rgba(255,255,255,0.1); }
        .menu-btn.active { background: #2b7de9; color: #fff; }
        .content { flex: 1; padding: 2rem 3rem; width: 100%; }
        section { background: rgba(255,255,255,0.96); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 16px; box-shadow: 0 12px 32px rgba(15,23,42,0.08); backdrop-filter: blur(4px); }
        form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; }
        label { display: flex; flex-direction: column; font-size: 0.9rem; color: #1f3b57; }
        input, textarea, select { padding: 0.55rem 0.75rem; border: 1px solid rgba(82,106,146,0.18); border-radius: 12px; background: #fff; font-size: 0.95rem; }
        button { padding: 0.6rem 1.2rem; border: none; border-radius: 12px; background: #2b7de9; color: #fff; cursor: pointer; font-weight: 600; box-shadow: 0 5px 15px rgba(43,125,233,0.25); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
        button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(43,125,233,0.35); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.5rem; border-bottom: 1px solid #e0e6ef; text-align: left; font-size: 0.9rem; }
        th { background: #f0f4fa; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .records-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .records-grid h3 { margin-top: 0; }
        .records-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; margin-bottom: 0.75rem; }
        .records-filter label { display: flex; flex-direction: column; font-size: 0.85rem; font-weight: 600; color: #1f3b57; }
        .records-filter input { min-width: 180px; }
        .customer-transactions-date-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; margin: 0.5rem 0 1rem; }
        .customer-transactions-date-filter label { display: flex; flex-direction: column; font-size: 0.85rem; font-weight: 600; color: #1f3b57; }
        .customer-transactions-date-filter input { min-width: 180px; }
        .records-status { min-height: 1.25rem; font-size: 0.9rem; margin-bottom: 0.75rem; color: #1f3b57; }
        .records-status.error { color: #b32020; }
        .records-status.success { color: #1a7a1a; }
        .records-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card { background: #fff; border-radius: 18px; padding: 1rem; border: 1px solid rgba(26,54,93,0.08); box-shadow: 0 12px 30px rgba(31,59,87,0.08); position: relative; overflow: hidden; }
        .stat-card::before { content: ""; position: absolute; inset: 0; border-radius: inherit; background: radial-gradient(circle at top right, rgba(43,125,233,0.08), transparent 45%); z-index: 0; }
        .stat-card * { position: relative; z-index: 1; }
        .stat-card h4 { margin: 0 0 0.35rem; font-size: 0.95rem; color: #8392a6; letter-spacing: 0.01em; }
        .stat-card p { margin: 0; font-size: 1.5rem; font-weight: 700; color: #1f3b57; }
        .stat-subtext { margin-top: 0.25rem; font-size: 0.8rem; color: #6d7a91; }
        .overall-report-section { background: transparent; padding: 0; box-shadow: none; }
        .overall-report-shell { background: rgba(255,255,255,0.98); border-radius: 26px; padding: 1.75rem; box-shadow: 0 18px 40px rgba(31,59,87,0.15); border: 1px solid rgba(26,54,93,0.08); margin-top: 0.75rem; }
        .overall-filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .overall-filter-actions { display: flex; flex-wrap: wrap; gap: 0.6rem; align-items: flex-end; }
        .overall-filter-actions button { border-radius: 999px; box-shadow: none; padding: 0.5rem 1.2rem; }
        .overall-quick-row { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-start; margin-top: 1rem; }
        .overall-status-bar { margin-top: 1rem; background: #f2f5fb; border-radius: 999px; padding: 0.45rem 1.25rem; font-size: 0.9rem; color: #5c6a82; display: inline-flex; align-items: center; gap: 0.5rem; }
        .overall-status-bar::before { content: ""; width: 8px; height: 8px; border-radius: 50%; background: #2b7de9; box-shadow: 0 0 0 4px rgba(43,125,233,0.2); }
        .overall-report-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .overall-quick-row .range-btn { flex: 0 1 auto; }
        .report-quick-range { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; width: 100%; flex: 1 1 100%; }
        .range-btn { border: 1px solid rgba(43,125,233,0.35); background: rgba(43,125,233,0.08); color: #1f3b57; padding: 0.4rem 1rem; border-radius: 999px; font-size: 0.85rem; cursor: pointer; font-weight: 600; transition: background 0.2s, color 0.2s, transform 0.2s; box-shadow: none; }
        .range-btn.active, .range-btn:hover { background: #2b7de9; color: #fff; transform: translateY(-1px); }
        .photo-preview { grid-column: 1 / -1; display: flex; flex-direction: column; gap: 0.5rem; }
        .photo-preview img { max-height: 160px; border-radius: 6px; border: 1px solid #c3cfe2; object-fit: cover; display: none; }
        .customer-actions { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .inline-btn { font-size: 0.82rem; padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(43,125,233,0.35); background: #fff; color: #2b7de9; cursor: pointer; box-shadow: none; }
        .inline-btn:hover { background: #2b7de9; color: #fff; }
        .danger-btn { border-color: #c0392b; color: #fff; }
        .danger-btn:hover { background: #c0392b; color: #fff; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: var(--color-surface); border-radius: 8px; padding: 1.5rem; width: min(480px, 92%); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
        .modal-card h3 { margin-top: 0; }
        .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; }
        .modal-grid label.full-width { grid-column: 1 / -1; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
        .secondary-btn { background: #e3e9fb; color: #1f3b57; border: 1px solid #c3cfe2; }
        .secondary-btn:hover { background: #d3e0ff; }
        .hidden { display: none !important; }
        .customer-transactions { display: none; }
        .customer-transactions.active { display: block; }
        .transactions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .customer-photo-cell img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 1px solid #c3cfe2; display: block; }
        .photo-modal-preview img { width: 100%; max-height: 240px; object-fit: cover; border-radius: 6px; border: 1px solid #c3cfe2; }
        .customer-totals { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .total-card { background: #eef3fb; border: 1px solid #cfd8ef; border-radius: 6px; padding: 0.75rem; }
        .total-card h4 { margin: 0 0 0.25rem; font-size: 0.85rem; color: #51657d; }
        .total-card p { margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f3b57; }
        .timeline-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
        .timeline-date-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; margin: 0.5rem 0 1rem; }
        .timeline-date-filter label { display: flex; flex-direction: column; font-size: 0.85rem; font-weight: 600; color: #1f3b57; }
        .timeline-date-filter input { min-width: 160px; }
        .loan-timeline-panel { margin-top: 1rem; border: 1px solid #d5deef; border-radius: 8px; padding: 1rem; background: #f8faff; }
        .loan-timeline-panel.hidden { display: none; }
        .loan-timeline-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
        .loan-timeline-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .loan-timeline-table th, .loan-timeline-table td { border-bottom: 1px solid #e3eaf5; padding: 0.4rem; font-size: 0.85rem; }
        .loan-timeline-table th { background: #eef3fb; font-weight: 600; color: #51657d; }
        .loan-timeline-table tr:last-child td { border-bottom: none; }
        .loan-timeline-note { font-size: 0.8rem; color: #6d7a91; }
        .log-action { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .log-action.create { background: #e1f5ed; color: #0f7b4f; }
        .log-action.update { background: #fff3cd; color: #856404; }
        .log-action.delete { background: #fdecea; color: #a1260f; }
        .log-action.default { background: #e5e9f2; color: #1f3b57; }
        .log-metadata { font-size: 0.85rem; color: #51657d; white-space: pre-wrap; }
        .language-switcher { margin-bottom: 1.5rem; font-size: 0.85rem; color: #dbe6ff; }
        .language-switcher label { display: block; margin-bottom: 0.4rem; font-weight: 600; }
        .language-switcher select { width: 100%; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid rgba(255,255,255,0.4); background: rgba(0,0,0,0.2); color: #fff; }
        .language-switcher select option { color: #1f3b57; }
        .pagination-controls { display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .pagination-controls button { min-width: 90px; }
        .pagination-status { font-size: 0.85rem; color: #51657d; }
        .admin-access-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem; margin-top: 1.25rem; }
        .admin-card { background: rgba(255,255,255,0.98); border-radius: 20px; padding: 1.25rem 1.5rem; border: 1px solid rgba(26,54,93,0.08); box-shadow: 0 18px 36px rgba(15,23,42,0.08); display: flex; flex-direction: column; }
        .admin-card h3 { margin-top: 0; }
        .admin-card form { display: flex; flex-direction: column; gap: 0.85rem; height: 100%; }
        .admin-form-stack { flex: 1; display: flex; flex-direction: column; gap: 0.85rem; }
        .admin-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.85rem; }
        .admin-permission-grid { margin-top: 1rem; display: grid; gap: 0.85rem; }
        .admin-permission-group { border: 1px solid rgba(195,207,226,0.9); border-radius: 12px; padding: 0.75rem 1rem; background: #f9fbff; }
        .admin-permission-group h4 { margin: 0 0 0.35rem; font-size: 0.95rem; color: #1f3b57; }
        .admin-permission-item { display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 0.35rem; }
        .admin-permission-item:last-child { margin-bottom: 0; }
        .admin-permission-item label { font-size: 0.85rem; color: #1f3b57; }
        .admin-permission-item small { display: block; color: #6d7a91; font-size: 0.75rem; }
        .admin-user-list { display: flex; flex-direction: column; gap: 0.65rem; max-height: 520px; overflow-y: auto; padding-right: 0.4rem; }
        .admin-user-pill { border: 1px solid rgba(195,207,226,0.9); border-radius: 14px; padding: 0.85rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
        .admin-user-pill.active { border-color: var(--color-primary); background: rgba(43,125,233,0.08); }
        .admin-user-meta { display: flex; flex-direction: column; gap: 0.15rem; }
        .admin-user-arrow { color: var(--color-primary); font-weight: 600; }
        .admin-tag { display: inline-flex; padding: 0.1rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: rgba(31,59,87,0.08); color: #1f3b57; }
        .admin-tag.inactive { background: rgba(244,67,54,0.15); color: #b71c1c; }
        .admin-empty { text-align: center; padding: 1.5rem 0.75rem; color: #6d7a91; font-size: 0.9rem; }
        .admin-role-note { font-size: 0.85rem; color: #6d7a91; margin-top: 0.2rem; }
        .admin-button-row { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; margin-top: auto; }
        .admin-button-row button { min-width: 130px; }
        .admin-status { margin-top: 0.6rem; font-size: 0.85rem; color: #6d7a91; }
        .admin-status.error { color: #c62828; }
        .admin-status.success { color: #1b5e20; }

        .page-hero { background: linear-gradient(135deg, #fdfdff, #e7efff); border-radius: 24px; padding: 1.75rem 2.25rem; margin-bottom: 1.75rem; box-shadow: 0 25px 60px rgba(43,125,233,0.18); display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap: 1.5rem; align-items: center; position: relative; overflow: hidden; }
        .page-hero::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 20% 20%, rgba(43,125,233,0.15), transparent 55%); z-index: 0; }
        .page-hero > * { position: relative; z-index: 1; }
        .page-hero h1 { margin-bottom: 0.35rem; }
        .hero-subtitle { color: var(--color-muted); margin: 0; font-size: 0.95rem; }
        .hero-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .chip { display: inline-flex; align-items: center; padding: 0.15rem 0.65rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: #e4edff; color: #1f3b57; border: 1px solid #c6d5ff; }
        .hero-metrics { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
        .metric-card { flex: 1 1 120px; background: var(--color-surface-alt); border-radius: 8px; padding: 0.85rem; border: 1px solid #d9e2f3; min-width: 150px; }
        .metric-card span { display: block; font-size: 0.8rem; color: var(--color-muted); margin-bottom: 0.25rem; }
        .metric-card strong { font-size: 1.4rem; font-weight: 700; color: #1f3b57; }
        .hero-actions { display: flex; flex-direction: column; gap: 0.75rem; }
        .quick-nav-label { font-size: 0.85rem; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .quick-nav { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .quick-pill { border: 1px solid rgba(43,125,233,0.35); border-radius: 999px; padding: 0.4rem 0.9rem; background: rgba(43,125,233,0.08); color: #1f3b57; cursor: pointer; font-size: 0.85rem; transition: background 0.2s, transform 0.2s; box-shadow: none; }
        .quick-pill:hover { background: rgba(43,125,233,0.18); transform: translateY(-1px); }
        .hero-btn { width: 100%; padding: 0.7rem 1rem; border-radius: 12px; border: 1px solid rgba(43,125,233,0.2); background: #fff; color: #1f3b57; font-weight: 600; box-shadow: 0 8px 20px rgba(31,59,87,0.12); }
        .hero-btn:hover { background: #f4f8ff; }
        .hero-btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .hero-btn-group .hero-btn { flex: 1 1 180px; width: auto; }

        .section-heading { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
        .section-heading p { margin: 0; color: var(--color-muted); font-size: 0.9rem; }
        .bank-ledger-chip { display: flex; flex-direction: column; align-items: flex-end; background: var(--color-surface-alt); padding: 0.6rem 0.9rem; border-radius: 12px; border: 1px solid rgba(26,54,93,0.08); min-width: 180px; }
        .bank-ledger-chip span { font-size: 0.8rem; color: var(--color-muted); }
        .bank-ledger-chip strong { font-size: 1.4rem; margin-top: 0.15rem; color: #0c3c78; }
        .bank-ledger-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; align-items: stretch; }
        .bank-ledger-summary { background: linear-gradient(135deg, #eef4ff, #dce9ff); border-radius: 18px; padding: 1.2rem; border: 1px solid rgba(26,54,93,0.08); box-shadow: 0 12px 36px rgba(15,23,42,0.08); display: flex; flex-direction: column; gap: 0.35rem; }
        .bank-ledger-summary-label { margin: 0; font-size: 0.85rem; letter-spacing: 0.05em; color: var(--color-muted); text-transform: uppercase; }
        .bank-ledger-balance { margin: 0; font-size: 2.4rem; font-weight: 700; color: #0c3c78; }
        .bank-ledger-summary-note { margin: 0; color: #4b5972; font-size: 0.9rem; }
        .bank-ledger-badges { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.5rem; }
        .bank-ledger-badges span { font-size: 0.75rem; padding: 0.2rem 0.65rem; border-radius: 999px; background: #fff; border: 1px solid rgba(26,54,93,0.15); color: #1f3b57; font-weight: 600; }
        .bank-ledger-form { background: #fff; border-radius: 18px; padding: 1rem; border: 1px solid rgba(26,54,93,0.08); box-shadow: 0 12px 24px rgba(15,23,42,0.06); display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; }
        .bank-ledger-form label { margin: 0; }
        .bank-ledger-note-field { grid-column: 1 / -1; }
        .bank-ledger-form-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; grid-column: 1 / -1; }
        .bank-ledger-controls {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .bank-ledger-controls label {
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1f3b57;
        }
        .bank-ledger-controls input {
            min-width: 170px;
        }
        .bank-ledger-search-field {
            flex: 1 1 240px;
        }
        .bank-ledger-quick-range {
            flex: 1 1 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .table-scroll { overflow-x: auto; }
        .bank-ledger-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .bank-ledger-table th, .bank-ledger-table td { border-bottom: 1px solid #e3eaf5; padding: 0.55rem 0.65rem; font-size: 0.9rem; }
        .bank-ledger-table th { background: #f3f6fb; color: #4b5972; font-weight: 600; }
        .bank-ledger-amount-positive { color: #127a46; font-weight: 600; }
        .bank-ledger-amount-negative { color: #b32727; font-weight: 600; }
        .bank-ledger-type-pill { display: inline-flex; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(26,54,93,0.12); background: #fff; color: #1f3b57; }

        @media (max-width: 1100px) {
            .page-hero { grid-template-columns: 1fr; }
            .hero-actions { flex-direction: row; flex-wrap: wrap; }
            .hero-btn { flex: 1 1 200px; }
        }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; box-shadow: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .content { padding: 1.5rem; }
            .menu-btn { text-align: center; }
        }

        @media (max-width: 600px) {
            .content { padding: 1rem; }
            form { grid-template-columns: 1fr; }
            .records-filter, .customer-transactions-date-filter, .timeline-date-filter { flex-direction: column; align-items: stretch; }
            .report-quick-range { justify-content: flex-start; }
            .hero-metrics { flex-direction: column; }
            .metric-card { width: 100%; }
            .overall-filter-actions { flex-direction: column; align-items: stretch; }
            .overall-status-bar { width: 100%; border-radius: 16px; justify-content: center; }
        }
    </style>
    <script>
        let APP_PERMISSIONS = {};
        const isoDate = (value) => {
            const trimmed = (value ?? "").toString().trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                return trimmed;
            }
            const parsed = new Date(trimmed);
            if (!Number.isNaN(parsed.valueOf())) {
                return parsed.toISOString().slice(0, 10);
            }
            return "";
        };

        const toIsoDateTime = (value) => {
            const trimmed = (value ?? "").toString().trim();
            if (!trimmed) {
                return "";
            }
            const parsed = new Date(trimmed);
            if (Number.isNaN(parsed.valueOf())) {
                return "";
            }
            return parsed.toISOString();
        };

        const MY_TIMEZONE = "Asia/Kuala_Lumpur";
        const formatMytDateTime = (value) => {
            if (!value) return "-";
            const parsed = new Date(value);
            if (Number.isNaN(parsed.valueOf())) {
                return value;
            }
            const formatter = new Intl.DateTimeFormat("en-CA", {
                timeZone: MY_TIMEZONE,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            });
            return formatter
                .format(parsed)
                .replace(",", "")
                .replace(/\u202f/g, " ")
                .trim();
        };

        const formatMyKad = (value) => {
            const digits = (value ?? "").toString().replace(/\D/g, "");
            if (digits.length !== 12) {
                return (value ?? "").trim();
            }
            return `${digits.slice(0, 6)}-${digits.slice(6, 8)}-${digits.slice(8)}`;
        };

        const toLocalInputValue = (value) => {
            if (!value) return "";
            const parsed = new Date(value);
            if (Number.isNaN(parsed.valueOf())) {
                return "";
            }
            const offsetMinutes = parsed.getTimezoneOffset();
            const localTime = new Date(parsed.getTime() - offsetMinutes * 60000);
            return localTime.toISOString().slice(0, 16);
        };

        const formatDateForInput = (value) => {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.valueOf())) {
                return "";
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        };

        const formatDateTimeForInput = (value) => {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.valueOf())) {
                return "";
            }
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${formatDateForInput(date)}T${hours}:${minutes}`;
        };

        const computeDatePresetRange = (key) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const clampToToday = (date) => {
                const candidate = new Date(date);
                candidate.setHours(0, 0, 0, 0);
                return candidate.getTime() > today.getTime() ? new Date(today) : candidate;
            };
            let start = new Date(today);
            let end = new Date(today);
            switch (key) {
                case "today":
                    break;
                case "this_week": {
                    const dayOfWeek = today.getDay();
                    const offsetToMonday = (dayOfWeek + 6) % 7;
                    start.setDate(today.getDate() - offsetToMonday);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    break;
                }
                case "this_month": {
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                }
                case "last_week": {
                    const dayOfWeek = today.getDay();
                    const offsetToMonday = (dayOfWeek + 6) % 7;
                    end = new Date(today);
                    end.setDate(today.getDate() - offsetToMonday - 1);
                    start = new Date(end);
                    start.setDate(end.getDate() - 6);
                    break;
                }
                case "last_month": {
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                }
                default:
                    return null;
            }
            end = clampToToday(end);
            start.setHours(0, 0, 0, 0);
            if (start.getTime() > end.getTime()) {
                start = new Date(end);
            }
            return { start, end };
        };

        const setupQuickRangeControls = (container, { startInput, endInput, onApplyRange } = {}) => {
            if (!container || !startInput || !endInput) {
                return null;
            }
            const buttons = container.querySelectorAll("[data-range-key]");
            if (!buttons.length) {
                return null;
            }
            let activeButton = null;
            const setActive = (button) => {
                if (activeButton && activeButton !== button) {
                    activeButton.classList.remove("active");
                }
                activeButton = button || null;
                if (activeButton) {
                    activeButton.classList.add("active");
                }
            };
            const applyRangeByKey = (key, button, options = {}) => {
                if (!key) return;
                const { triggerCallback = true, setActiveState = true } = options;
                const range = computeDatePresetRange(key);
                if (!range) {
                    return;
                }
                startInput.value = formatDateForInput(range.start);
                endInput.value = formatDateForInput(range.end);
                if (setActiveState) {
                    const target = button || container.querySelector(`[data-range-key="${key}"]`);
                    setActive(target || null);
                }
                if (triggerCallback && typeof onApplyRange === "function") {
                    onApplyRange({ key, range });
                }
            };
            buttons.forEach((button) => {
                button.addEventListener("click", () => applyRangeByKey(button.dataset.rangeKey || "", button));
            });
            return {
                clearActive: () => {
                    if (activeButton) {
                        activeButton.classList.remove("active");
                        activeButton = null;
                    }
                },
                applyRangeByKey: (key, options = {}) => applyRangeByKey(key, null, options),
            };
        };

        const isFutureDateTime = (value) => {
            if (!value) return false;
            const target = new Date(value);
            if (Number.isNaN(target.valueOf())) {
                return false;
            }
            return target.getTime() > Date.now();
        };

        const LANGUAGE_TO_LOCALE = { zh: "zh-CN", en: "en", ms: "ms" };
        const TRANSLATIONS = {
            zh: {
                "language.label": "界面语言",
                "language.option.zh": "华语",
                "language.option.en": "英文",
                "language.option.ms": "马来语",
                "menu.title": "功能菜单",
                "menu.add_customer": "添加顾客",
                "menu.customer_list": "顾客列表",
                "menu.add_loan": "添加借贷",
                "menu.add_repayment": "添加还款",
                "menu.records": "借/还贷记录",
                "menu.bank_ledger": "银行进出款",
                "menu.operation_logs": "操作日志",
                "menu.summary": "顾客总览",
                "menu.overall_report": "报表总览",
                "topbar.current_user_prefix": "当前登录：",
                "topbar.logout": "退出登录",
                "menu.admin_access": "管理员管理",
                "page.title": "放贷记录管理后台",
                "page.hero.subtitle": "集中查看借出与还款概况，并一键跳转到常用操作。",
                "page.hero.timezone": "基于马来西亚时区 (UTC+8)",
                "page.hero.quick_nav": "快速导航",
                "page.hero.primary_action": "查看最新借还记录",
                "page.hero.secondary_action": "快速添加借贷",
                "hero.metric.customers": "顾客总数",
                "hero.metric.loans": "借贷次数",
                "hero.metric.repayments": "还款次数",
                "section.add_customer": "添加顾客",
                "section.customer_list": "顾客列表",
                "section.customer_transactions": "顾客借还记录",
                "section.add_loan": "添加借贷",
                "section.add_repayment": "添加还款",
                "section.records": "借/还贷记录",
                "section.bank_ledger": "银行进出款记录",
                "section.bank_ledger_desc": "集中查看银行余额，并支持手动调整或追踪每一条借出/回款流水。",
                "section.summary": "顾客总览",
                "section.operation_logs": "操作日志",
                "section.overall_report": "报表总览",
                "section.operation_logs_note": "记录所有顾客、借贷、还款等操作，方便追踪每次调整。",
                "form.customer.customer_code": "顾客编号",
                "placeholder.customer_code": "如 CUST-XXXXXX",
                "form.customer.name": "姓名",
                "form.customer.phone": "电话",
                "form.customer.id_card": "身份证",
                "placeholder.customer_id_card": "例如 880101-14-5678",
                "form.customer.address": "地址",
                "form.customer.note": "备注",
                "form.customer.photo": "顾客照片",
                "label.photo_preview": "照片预览",
                "button.save_customer": "保存顾客",
                "table.customers.no": "No.",
                "table.customers.code": "顾客编号",
                "table.customers.name": "姓名",
                "table.customers.phone": "电话",
                "table.customers.id_card": "身份证",
                "table.customers.address": "地址",
                "table.customers.photo": "照片",
                "table.customers.note": "备注",
                "table.customers.created": "添加时间",
                "table.customers.actions": "操作",
                "table.empty": "暂无数据",
                "button.profile": "资料",
                "button.phone": "电话",
                "button.address": "地址",
                "button.balance": "余额",
                "button.photo": "照片",
                "button.transactions": "交易",
                "button.load_overall_report": "加载报表",
                "button.loading": "加载中...",
                "customer.transactions.placeholder": "请选择顾客查看借还记录。",
                "button.view_balance_timeline": "查看复利余额记录流水",
                "button.view_repayment_timeline": "查看所有还款流水",
                "button.view_all_timeline": "查看全部流水",
                "button.refresh": "刷新",
                "customer.transactions.title": "{name} ({code}) 的借还记录",
                "customer.transactions.loan_table": "借贷记录",
                "customer.transactions.repayment_table": "还款记录",
                "customer.transactions.date_filter.label": "日期范围",
                "customer.transactions.date_filter.start": "开始日期",
                "customer.transactions.date_filter.end": "结束日期",
                "customer.transactions.date_filter.reset": "清除日期",
                "report.overall.description": "按日期汇总借出/还款与盈利情况。",
                "report.overall.start_date": "开始日期",
                "report.overall.end_date": "结束日期",
                "report.overall.status.ready": "请选择日期后点击“加载报表”。",
                "report.overall.status.loading": "正在加载报表...",
                "report.overall.status.loaded": "报表已更新。",
                "report.overall.status.error": "加载报表失败：{message}",
                "report.overall.total_loan_amount": "总借出",
                "report.overall.loan_count": "总借出笔数",
                "report.overall.total_repayment_amount": "总还款",
                "report.overall.repayment_count": "总还款笔数",
                "report.overall.fee_income": "手续费总收入",
                "report.overall.interest_profit": "利息总盈利",
                "report.overall.net_profit": "总盈利 (总还款 - 总借出)",
                "report.overall.total_customers": "总用户",
                "report.overall.new_customers": "新增用户",
                "date.range.today": "今天",
                "date.range.this_week": "本周",
                "date.range.this_month": "本月",
                "date.range.last_week": "上周",
                "date.range.last_month": "上月",
                "report.overall.range.today": "今天",
                "report.overall.range.yesterday": "昨天",
                "report.overall.range.last_week": "上周",
                "report.overall.range.last_month": "上月",
                "table.customer_loans.index": "记录No.",
                "table.customer_loans.code": "借贷编号",
                "table.customer_loans.amount": "借贷金额",
                "table.customer_loans.fee": "手续费",
                "table.customer_loans.date": "借出日期",
                "table.customer_loans.note": "备注",
                "table.customer_loans.actions": "操作",
                "table.customer_repayments.index": "记录No.",
                "table.customer_repayments.loan_code": "借贷编号",
                "table.customer_repayments.amount": "还款金额",
                "table.customer_repayments.date": "还款日期",
                "table.customer_repayments.note": "备注",
                "table.customer_repayments.actions": "操作",
                "button.edit_amount": "编辑金额",
                "button.edit_date": "编辑日期",
                "button.view_timeline": "查看流水",
                "button.delete": "删除",
                "button.close": "关闭",
                "totals.total_loan": "总借出",
                "totals.total_repayment": "总还款",
                "totals.interest_profit": "利息总盈利",
                "totals.fee_income": "手续费总收入",
                "totals.total_profit": "总盈利 (总还款 - 总借出)",
                "form.loan.customer_code": "顾客编号",
                "form.loan.amount": "金额",
                "form.loan.fee": "借贷手续费",
                "form.loan.date": "借出日期时间",
                "form.loan.rate": "利率(%)",
                "form.loan.type": "计息方式",
                "form.loan.note": "备注",
                "option.interest_type.monthly": "月息",
                "option.interest_type.daily": "日息",
                "button.save_loan": "保存借贷",
                "form.repayment.customer_code": "顾客编号",
                "form.repayment.loan_code": "借贷编号",
                "form.repayment.amount": "金额",
                "form.repayment.date": "还款日期时间",
                "form.repayment.note": "备注",
                "button.save_repayment": "保存还款",
                "bank.ledger.current_balance": "当前余额",
                "bank.ledger.summary.title": "账户总览",
                "bank.ledger.summary.note": "借贷发放会自动扣减，回款会自动入账。",
                "bank.ledger.badge.auto": "自动同步",
                "bank.ledger.badge.manual": "支持手动调整",
                "bank.ledger.filter.search": "搜索银行流水",
                "bank.ledger.filter.search_placeholder": "输入类型、备注、顾客编号或ID",
                "bank.ledger.form.amount": "调整金额",
                "bank.ledger.form.direction": "调整方向",
                "bank.ledger.form.direction.deposit": "手动入账 (+)",
                "bank.ledger.form.direction.withdrawal": "手动扣除 (-)",
                "bank.ledger.form.note": "备注 (可选)",
                "bank.ledger.form.submit": "保存调整",
                "bank.ledger.limit": "显示数量",
                "bank.ledger.table.time": "时间",
                "bank.ledger.table.type": "类型",
                "bank.ledger.table.reference": "关联对象",
                "bank.ledger.table.amount": "金额",
                "bank.ledger.table.balance": "余额",
                "bank.ledger.table.note": "备注",
                "bank.ledger.status.loading": "正在加载银行记录...",
                "bank.ledger.status.error": "加载失败：{message}",
                "bank.ledger.status.empty": "暂无银行流水",
                "bank.ledger.form.success": "调整已保存",
                "bank.ledger.form.error": "保存失败：{message}",
                "bank.ledger.type.loan_disbursement": "借贷发放",
                "bank.ledger.type.loan_adjustment": "借贷调整",
                "bank.ledger.type.loan_reversal": "借贷回退",
                "bank.ledger.type.repayment_receipt": "还款入账",
                "bank.ledger.type.repayment_adjustment": "还款调整",
                "bank.ledger.type.repayment_reversal": "还款回退",
                "bank.ledger.type.manual_deposit": "手动入账",
                "bank.ledger.type.manual_withdrawal": "手动扣除",
                "records.start_date": "开始日期",
                "records.end_date": "结束日期",
                "button.load_records": "加载记录",
                "stat.loan_count": "借贷笔数",
                "stat.loan_amount": "借贷总额",
                "stat.repay_count": "还款笔数",
                "stat.repay_amount": "还款总额",
                "records.loan_table_title": "借贷记录",
                "records.repayment_table_title": "还贷记录",
                "table.loans.code": "借贷编号",
                "table.loans.id": "记录ID",
                "table.loans.customer_code": "顾客编号",
                "table.loans.date": "借出日期",
                "table.loans.amount": "金额",
                "table.loans.fee": "手续费",
                "table.loans.rate": "利率(%)",
                "table.loans.type": "计息方式",
                "table.loans.note": "备注",
                "table.loans.created": "录入时间",
                "table.repayments.id": "ID",
                "table.repayments.customer_code": "顾客编号",
                "table.repayments.loan_code": "借贷编号",
                "table.repayments.date": "还款日期",
                "table.repayments.amount": "金额",
                "table.repayments.note": "备注",
                "table.repayments.created": "录入时间",
                "records.empty.loans": "暂无借贷记录",
                "records.empty.repayments": "暂无还贷记录",
                "records.status.select_range": "请先选择开始和结束日期",
                "records.status.loading": "正在加载...",
                "records.status.loaded": "成功加载 {total} 条记录",
                "records.status.none": "所选日期区间暂无记录",
                "records.status.future_not_allowed": "不能选择晚于今天的日期",
                "records.status.error": "加载失败：{message}",
                "records.search.label": "记录搜索",
                "records.search.placeholder": "输入顾客编号或借贷编号",
                "records.view_filter.label": "记录类型",
                "records.view_filter.option.all": "全部记录",
                "records.view_filter.option.loans": "借贷记录",
                "records.view_filter.option.repayments": "还贷记录",
                "table.summary.customer_code": "顾客编号",
                "table.summary.name": "姓名",
                "table.summary.phone": "电话",
                "table.summary.loan_total": "总借出",
                "table.summary.repayment_total": "总还款",
                "table.summary.fee_total": "手续费",
                "table.summary.projected": "复利余额",
                "table.summary.next_compound": "下次结息",
                "table.summary.last_update": "最后更新",
                "table.summary.created": "顾客添加时间",
                "logs.limit": "显示数量",
                "logs.type": "对象类型",
                "logs.type.all": "全部",
                "logs.type.loan": "借贷",
                "logs.type.repayment": "还款",
                "logs.type.customer": "顾客",
                "button.refresh_logs": "刷新",
                "logs.table.time": "时间",
                "logs.table.entity": "对象",
                "logs.table.customer_code": "顾客编号",
                "logs.table.entity_id": "记录ID",
                "logs.table.action": "动作",
                "logs.table.description": "说明",
                "logs.table.metadata": "详细",
                "logs.date_filter.start": "开始日期",
                "logs.date_filter.end": "结束日期",
                "logs.status.empty": "暂无日志记录",
                "logs.status.loading": "加载中...",
                "logs.status.showing": "显示最近 {total} 条日志",
                "logs.status.invalid_range": "开始日期不能晚于结束日期",
                "logs.status.error": "加载日志失败：{message}",
                "log.loan.create": "创建借贷，金额 {amount}，手续费 {fee}",
                "log.loan.delete": "删除借贷，冲销金额 {amount}",
                "log.loan.update.amount": "借贷金额 {old}→{new}",
                "log.loan.update.loan_date": "更新借出日期 {old}→{new}",
                "log.loan.update.processing_fee": "更新手续费 {old}→{new}",
                "log.loan.update.interest_rate": "更新利率 {old}→{new}",
                "log.loan.update.interest_type": "更新计息方式 {old}→{new}",
                "log.loan.update.note": "更新备注 {old}→{new}",
                "log.repayment.create": "新增还款，金额 {amount}",
                "log.repayment.delete": "删除还款，回退金额 {amount}",
                "log.repayment.update.amount": "还款金额 {old}→{new}",
                "log.repayment.update.date": "更新还款日期 {old}→{new}",
                "log.repayment.update.note": "更新备注 {old}→{new}",
                "log.customer.create": "创建顾客 {code}",
                "log.customer.update.customer_code": "更新顾客编号 {old}→{new}",
                "log.customer.update.name": "更新姓名 {old}→{new}",
                "log.customer.update.phone": "更新电话 {old}→{new}",
                "log.customer.update.address": "更新地址 {old}→{new}",
                "log.customer.update.id_card": "更新身份证 {old}→{new}",
                "log.customer.update.note": "更新备注 {old}→{new}",
                "log.customer.photo.update": "更新顾客照片",
                "log.customer.balance.adjust": "调整复利余额 {amount}",
                "log.customer.balance.set": "设置新的复利余额 {amount}",
                "log.customer.balance.next_compound": "更新下次结息时间",
                "logs.entity.loan": "借贷",
                "logs.entity.repayment": "还款",
                "logs.entity.customer": "顾客",
                "logs.entity.other": "其他",
                "loan.timeline.title": "借款流水",
                "loan.timeline.subtitle": "{code} 借款流水",
                "loan.timeline.close": "关闭流水",
                "loan.timeline.status.loading": "正在加载流水...",
                "loan.timeline.status.error": "加载流水失败：{message}",
                "loan.timeline.status.empty": "暂无流水记录",
                "loan.timeline.table.time": "时间",
                "loan.timeline.table.action": "动作",
                "loan.timeline.table.change": "变动金额",
                "loan.timeline.table.balance": "剩余金额",
                "loan.timeline.table.note": "说明",
                "loan.timeline.event.principal": "借款本金",
                "loan.timeline.event.compound_initial": "复利初始增额",
                "loan.timeline.event.compound": "复利增长",
                "loan.timeline.event.initial_interest": "初始利息",
                "loan.timeline.event.processing_fee": "手续费",
                "loan.timeline.event.interest_cycle": "利息结算",
                "loan.timeline.event.repayment": "还款",
                "loan.timeline.description.interest": "{base} + {rate}% = {result}",
                "loan.timeline.description.repayment": "还款 {amount}",
                "timeline.view.balance": "复利余额记录流水",
                "timeline.view.repayments": "还款流水",
                "timeline.view.all": "全部流水",
                "timeline.panel.title": "{name} ({code}) - {view}",
                "timeline.projected_balance": "当前复利余额：{amount}",
                "timeline.status.loading": "正在加载流水...",
                "timeline.status.error": "加载流水失败：{message}",
                "timeline.status.empty": "暂无流水记录",
                "timeline.table.time": "时间",
                "timeline.table.type": "事件",
                "timeline.table.loan_code": "借贷编号",
                "timeline.table.change": "变动金额",
                "timeline.table.balance": "复利余额",
                "timeline.table.note": "说明",
                "timeline.event.loan_disbursement": "借贷入账",
                "timeline.event.loan_adjustment": "借贷调整",
                "timeline.event.loan_writeoff": "借贷删除",
                "timeline.event.repayment": "还款",
                "timeline.event.repayment_adjustment": "还款调整",
                "timeline.event.repayment_reversal": "还款删除",
                "timeline.event.compound_growth": "复利增长",
                "timeline.event.manual_adjust": "手动调整",
                "timeline.event.manual_override": "手动设定",
                "timeline.event.baseline": "初始余额",
                "timeline.note.compound": "{base} + {rate}% = {result}",
                "timeline.note.repayment": "还款 {amount}",
                "timeline.note.repayment_with_balance": "还款 {amount}，还款前复利余额 {previous}",
                "timeline.note.repayment_adjustment": "还款 {old}→{new}",
                "timeline.note.repayment_reversal": "回退还款 {amount}",
                "timeline.note.loan_disbursement": "借贷 {loan} 计入 {compounded}",
                "timeline.note.loan_adjustment": "借贷有效金额 {old}→{new}",
                "timeline.note.loan_writeoff": "冲销借贷 {amount}",
                "timeline.note.manual_adjust": "先前余额 {previous}",
                "timeline.note.manual_override": "设定余额 {target}",
                "timeline.note.baseline": "期初余额 {amount}",
                "button.cancel": "取消",
                "button.save": "保存",
                "button.save_balance": "保存调整",
                "button.upload": "上传",
                "button.loading": "加载中...",
                "button.refreshing": "刷新中...",
                "button.clear": "清除",
                "customer.search.label": "搜索顾客",
                "customer.search.placeholder": "输入顾客编号、姓名、电话、身份证、备注或地址",
                "summary.search.label": "概览搜索",
                "summary.search.placeholder": "输入顾客编号、姓名、电话、身份证、备注或地址",
                "pagination.prev": "上一页",
                "pagination.next": "下一页",
                "pagination.status": "第 {page}/{totalPages} 页 · 显示 {start}-{end} / {total} 条",
                "table.loading": "加载中...",
                "modal.balance.title": "手动调整复利余额",
                "modal.balance.current": "当前复利余额：",
                "modal.balance.loan_code": "关联借贷（必填）",
                "modal.balance.loan_code_placeholder": "请选择借贷编号",
                "modal.balance.remaining_prefix": "剩余：",
                "modal.balance.adjust_amount": "调整金额 (可为负数)",
                "modal.balance.new_balance": "或设置新的复利余额",
                "modal.balance.next_compound": "下次结息时间 (可选)",
                "modal.balance.tip": "若填写“新的复利余额”，系统将直接使用该值；否则会在当前复利余额基础上加上“调整金额”。",
                "placeholder.balance_new": "留空则使用调整金额",
                "summary.empty": "暂无记录",
                "modal.customer.profile": "顾客资料",
                "modal.customer.phone": "电话号码",
                "modal.customer.address": "地址",
                "modal.photo.title": "上传顾客照片",
                "modal.photo.select_image": "选择图片",
                "label.photo_modal_preview": "预览",
                "prompt.new_loan_amount": "输入新的借贷金额",
                "prompt.new_repayment_amount": "输入新的还款金额",
                "prompt.new_loan_date": "输入新的借贷日期时间 (YYYY-MM-DD HH:MM)",
                "prompt.new_repayment_date": "输入新的还款日期时间 (YYYY-MM-DD HH:MM)",
                "confirm.delete_loan": "确定删除该借贷记录吗？",
                "confirm.delete_repayment": "确定删除该还款记录吗？",
                "alert.loan_delete_success": "借贷记录已删除",
                "alert.repayment_delete_success": "还款记录已删除",
                "alert.delete_failed": "删除失败：{message}",
                "error.amount_non_negative": "金额必须为非负数字",
                "alert.loan_update_success": "借贷金额已更新",
                "alert.repayment_update_success": "还款金额已更新",
                "alert.loan_date_update_success": "借贷日期已更新",
                "alert.repayment_date_update_success": "还款日期已更新",
                "alert.update_failed": "更新失败：{message}",
                "alert.submit_failed": "提交失败：{detail}",
                "alert.customer_not_found": "未找到该顾客",
                "alert.no_changes": "没有可更新的内容",
                "alert.customer_update_success": "顾客信息已更新",
                "alert.photo_required": "请先选择图片",
                "alert.photo_update_success": "照片已更新",
                "alert.upload_failed": "上传失败：{message}",
                "alert.date_range_invalid": "结束日期不能早于开始日期",
                "error.balance_new_numeric": "新的复利余额必须为数字",
                "error.balance_new_non_negative": "新的复利余额不能为负数",
                "error.adjust_amount_numeric": "调整金额必须为数字",
                "error.balance_loan_required": "请选择一笔借贷编号",
                "error.balance_loan_no_remaining": "所选借贷的复利余额已为 0，无法调整",
                "alert.balance_value_required": "请填写调整金额或新的复利余额",
                "alert.balance_no_loans": "该顾客暂无借贷记录，无法调整复利余额",
                "alert.balance_no_active_loans": "该顾客所有借贷余额均为 0，无法调整复利余额",
                "error.next_compound_invalid": "下次结息时间格式不正确",
                "error.datetime_invalid": "日期时间格式不正确，请使用 YYYY-MM-DD HH:MM",
                "error.datetime_future": "日期时间不能超过当前时间",
                "alert.balance_update_success": "复利余额已更新"
            },
            en: {
                "language.label": "Interface Language",
                "language.option.zh": "Chinese",
                "language.option.en": "English",
                "language.option.ms": "Malay",
                "menu.title": "Menu",
                "menu.add_customer": "Add Customer",
                "menu.customer_list": "Customer List",
                "menu.add_loan": "Add Loan",
                "menu.add_repayment": "Add Repayment",
                "menu.records": "Loan/Repayment Records",
                "menu.bank_ledger": "Bank Ledger",
                "menu.operation_logs": "Operation Logs",
                "menu.summary": "Customer Summary",
                "menu.overall_report": "Report Summary",
                "topbar.current_user_prefix": "Signed in as:",
                "topbar.logout": "Sign Out",
                "menu.admin_access": "Admin Access",
                "page.title": "Loan Record Dashboard",
                "page.hero.subtitle": "Review lending activity at a glance and jump to common workflows.",
                "page.hero.timezone": "Operating in MYT (UTC+8)",
                "page.hero.quick_nav": "Quick Navigation",
                "page.hero.primary_action": "View latest records",
                "page.hero.secondary_action": "Add a new loan",
                "hero.metric.customers": "Customers",
                "hero.metric.loans": "Loan Records",
                "hero.metric.repayments": "Repayment Records",
                "section.add_customer": "Add Customer",
                "section.customer_list": "Customer List",
                "section.customer_transactions": "Customer Transactions",
                "section.add_loan": "Add Loan",
                "section.add_repayment": "Add Repayment",
                "section.records": "Loan/Repayment Records",
                "section.bank_ledger": "Bank Ledger",
                "section.bank_ledger_desc": "Track the company bank balance, manual adjustments, and every auto-posted disbursement or repayment.",
                "section.summary": "Customer Summary",
                "section.operation_logs": "Operation Logs",
                "section.overall_report": "Report Summary",
                "section.operation_logs_note": "Tracks every customer, loan, and repayment action so you can audit adjustments.",
                "form.customer.customer_code": "Customer Code",
                "placeholder.customer_code": "e.g. CUST-XXXXXX",
                "form.customer.name": "Name",
                "form.customer.phone": "Phone",
                "form.customer.id_card": "ID Number",
                "placeholder.customer_id_card": "e.g. 880101-14-5678",
                "form.customer.address": "Address",
                "form.customer.note": "Note",
                "form.customer.photo": "Customer Photo",
                "label.photo_preview": "Photo Preview",
                "button.save_customer": "Save Customer",
                "table.customers.no": "No.",
                "table.customers.code": "Customer Code",
                "table.customers.name": "Name",
                "table.customers.phone": "Phone",
                "table.customers.id_card": "ID Number",
                "table.customers.address": "Address",
                "table.customers.photo": "Photo",
                "table.customers.note": "Note",
                "table.customers.created": "Created At",
                "table.customers.actions": "Actions",
                "table.empty": "No data",
                "button.profile": "Profile",
                "button.phone": "Phone",
                "button.address": "Address",
                "button.balance": "Balance",
                "button.photo": "Photo",
                "button.transactions": "Transactions",
                "button.load_overall_report": "Load Report",
                "button.loading": "Loading...",
                "button.view_balance_timeline": "View Balance Timeline",
                "button.view_repayment_timeline": "View Repayment Timeline",
                "button.view_all_timeline": "View All Timeline",
                "button.refresh": "Refresh",
                "customer.transactions.placeholder": "Select a customer to view transactions.",
                "customer.transactions.title": "{name} ({code}) transactions",
                "customer.transactions.loan_table": "Loan Records",
                "customer.transactions.repayment_table": "Repayment Records",
                "customer.transactions.date_filter.label": "Date Range",
                "customer.transactions.date_filter.start": "Start Date",
                "customer.transactions.date_filter.end": "End Date",
                "customer.transactions.date_filter.reset": "Clear Dates",
                "report.overall.description": "View aggregate loan and repayment totals for a date range.",
                "report.overall.start_date": "Start Date",
                "report.overall.end_date": "End Date",
                "report.overall.status.ready": "Choose a date range and load the report.",
                "report.overall.status.loading": "Loading report...",
                "report.overall.status.loaded": "Report updated.",
                "report.overall.status.error": "Failed to load report: {message}",
                "report.overall.total_loan_amount": "Total Loaned",
                "report.overall.loan_count": "Loan Count",
                "report.overall.total_repayment_amount": "Total Repaid",
                "report.overall.repayment_count": "Repayment Count",
                "report.overall.fee_income": "Fee Income",
                "report.overall.interest_profit": "Interest Profit",
                "report.overall.net_profit": "Net Profit (Repay - Loan)",
                "report.overall.total_customers": "Total Customers",
                "report.overall.new_customers": "New Customers",
                "date.range.today": "Today",
                "date.range.this_week": "This Week",
                "date.range.this_month": "This Month",
                "date.range.last_week": "Last Week",
                "date.range.last_month": "Last Month",
                "report.overall.range.today": "Today",
                "report.overall.range.yesterday": "Yesterday",
                "report.overall.range.last_week": "Last Week",
                "report.overall.range.last_month": "Last Month",
                "table.customer_loans.index": "Record No.",
                "table.customer_loans.code": "Loan Code",
                "table.customer_loans.amount": "Loan Amount",
                "table.customer_loans.fee": "Processing Fee",
                "table.customer_loans.date": "Loan Date",
                "table.customer_loans.note": "Note",
                "table.customer_loans.actions": "Actions",
                "table.customer_repayments.index": "Record No.",
                "table.customer_repayments.loan_code": "Loan Code",
                "table.customer_repayments.amount": "Repayment Amount",
                "table.customer_repayments.date": "Repayment Date",
                "table.customer_repayments.note": "Note",
                "table.customer_repayments.actions": "Actions",
                "button.edit_amount": "Edit Amount",
                "button.edit_date": "Edit Date",
                "button.view_timeline": "View Timeline",
                "button.delete": "Delete",
                "button.close": "Close",
                "totals.total_loan": "Total Loaned",
                "totals.total_repayment": "Total Repaid",
                "totals.interest_profit": "Interest Profit",
                "totals.fee_income": "Fee Income",
                "totals.total_profit": "Net Profit (Repay - Loan)",
                "form.loan.customer_code": "Customer Code",
                "form.loan.amount": "Amount",
                "form.loan.fee": "Processing Fee",
                "form.loan.date": "Loan Date & Time",
                "form.loan.rate": "Interest Rate (%)",
                "form.loan.type": "Interest Type",
                "form.loan.note": "Note",
                "option.interest_type.monthly": "Monthly",
                "option.interest_type.daily": "Daily",
                "button.save_loan": "Save Loan",
                "form.repayment.customer_code": "Customer Code",
                "form.repayment.loan_code": "Loan Code",
                "form.repayment.amount": "Amount",
                "form.repayment.date": "Repayment Date & Time",
                "form.repayment.note": "Note",
                "button.save_repayment": "Save Repayment",
                "bank.ledger.current_balance": "Current Balance",
                "bank.ledger.summary.title": "Account Overview",
                "bank.ledger.summary.note": "Loan disbursements deduct automatically, repayments add back in.",
                "bank.ledger.badge.auto": "Auto Sync",
                "bank.ledger.badge.manual": "Manual Adjust",
                "bank.ledger.filter.search": "Search Transactions",
                "bank.ledger.filter.search_placeholder": "Type, note, customer code or ID",
                "bank.ledger.form.amount": "Adjustment Amount",
                "bank.ledger.form.direction": "Direction",
                "bank.ledger.form.direction.deposit": "Manual Deposit (+)",
                "bank.ledger.form.direction.withdrawal": "Manual Withdrawal (-)",
                "bank.ledger.form.note": "Note (optional)",
                "bank.ledger.form.submit": "Save Adjustment",
                "bank.ledger.limit": "Display Count",
                "bank.ledger.table.time": "Time",
                "bank.ledger.table.type": "Type",
                "bank.ledger.table.reference": "Reference",
                "bank.ledger.table.amount": "Amount",
                "bank.ledger.table.balance": "Balance",
                "bank.ledger.table.note": "Note",
                "bank.ledger.status.loading": "Loading bank transactions...",
                "bank.ledger.status.error": "Failed to load: {message}",
                "bank.ledger.status.empty": "No bank transactions yet",
                "bank.ledger.form.success": "Adjustment saved",
                "bank.ledger.form.error": "Adjustment failed: {message}",
                "bank.ledger.type.loan_disbursement": "Loan Disbursement",
                "bank.ledger.type.loan_adjustment": "Loan Adjustment",
                "bank.ledger.type.loan_reversal": "Loan Reversal",
                "bank.ledger.type.repayment_receipt": "Repayment Receipt",
                "bank.ledger.type.repayment_adjustment": "Repayment Adjustment",
                "bank.ledger.type.repayment_reversal": "Repayment Reversal",
                "bank.ledger.type.manual_deposit": "Manual Deposit",
                "bank.ledger.type.manual_withdrawal": "Manual Withdrawal",
                "records.start_date": "Start Date",
                "records.end_date": "End Date",
                "button.load_records": "Load Records",
                "stat.loan_count": "Loan Count",
                "stat.loan_amount": "Total Loan Amount",
                "stat.repay_count": "Repayment Count",
                "stat.repay_amount": "Total Repayment Amount",
                "records.loan_table_title": "Loan Records",
                "records.repayment_table_title": "Repayment Records",
                "table.loans.code": "Loan Code",
                "table.loans.id": "Record ID",
                "table.loans.customer_code": "Customer Code",
                "table.loans.date": "Loan Date",
                "table.loans.amount": "Amount",
                "table.loans.fee": "Processing Fee",
                "table.loans.rate": "Interest Rate (%)",
                "table.loans.type": "Interest Type",
                "table.loans.note": "Note",
                "table.loans.created": "Created At",
                "table.repayments.id": "ID",
                "table.repayments.customer_code": "Customer Code",
                "table.repayments.loan_code": "Loan Code",
                "table.repayments.date": "Repayment Date",
                "table.repayments.amount": "Amount",
                "table.repayments.note": "Note",
                "table.repayments.created": "Created At",
                "records.empty.loans": "No loan records",
                "records.empty.repayments": "No repayment records",
                "records.status.select_range": "Please choose start and end dates",
                "records.status.loading": "Loading...",
                "records.status.loaded": "Loaded {total} records",
                "records.status.none": "No records in this range",
                "records.status.future_not_allowed": "Dates cannot be later than today",
                "records.status.error": "Failed to load: {message}",
                "records.search.label": "Search Records",
                "records.search.placeholder": "Search by customer or loan code",
                "records.view_filter.label": "Record Type",
                "records.view_filter.option.all": "All Records",
                "records.view_filter.option.loans": "Loans Only",
                "records.view_filter.option.repayments": "Repayments Only",
                "table.summary.customer_code": "Customer Code",
                "table.summary.name": "Name",
                "table.summary.phone": "Phone",
                "table.summary.loan_total": "Total Loaned",
                "table.summary.repayment_total": "Total Repaid",
                "table.summary.fee_total": "Fees",
                "table.summary.projected": "Projected Balance",
                "table.summary.next_compound": "Next Compound",
                "table.summary.last_update": "Last Update",
                "table.summary.created": "Customer Created",
                "logs.limit": "Display Count",
                "logs.type": "Entity Type",
                "logs.type.all": "All",
                "logs.type.loan": "Loan",
                "logs.type.repayment": "Repayment",
                "logs.type.customer": "Customer",
                "button.refresh_logs": "Refresh",
                "logs.table.time": "Time",
                "logs.table.entity": "Entity",
                "logs.table.customer_code": "Customer Code",
                "logs.table.entity_id": "Record ID",
                "logs.table.action": "Action",
                "logs.table.description": "Description",
                "logs.table.metadata": "Details",
                "logs.date_filter.start": "Start Date",
                "logs.date_filter.end": "End Date",
                "logs.status.empty": "No log entries",
                "logs.status.loading": "Loading...",
                "logs.status.showing": "Showing latest {total} logs",
                "logs.status.invalid_range": "End date cannot be before start date",
                "logs.status.error": "Failed to load logs: {message}",
                "log.loan.create": "Created loan, amount {amount}, fee {fee}",
                "log.loan.delete": "Deleted loan, reversed {amount}",
                "log.loan.update.amount": "Loan amount {old}→{new}",
                "log.loan.update.loan_date": "Loan date {old}→{new}",
                "log.loan.update.processing_fee": "Processing fee {old}→{new}",
                "log.loan.update.interest_rate": "Interest rate {old}→{new}",
                "log.loan.update.interest_type": "Interest type {old}→{new}",
                "log.loan.update.note": "Note {old}→{new}",
                "log.repayment.create": "Recorded repayment, amount {amount}",
                "log.repayment.delete": "Deleted repayment, restored {amount}",
                "log.repayment.update.amount": "Repayment amount {old}→{new}",
                "log.repayment.update.date": "Repayment date {old}→{new}",
                "log.repayment.update.note": "Note {old}→{new}",
                "log.customer.create": "Created customer {code}",
                "log.customer.update.customer_code": "Customer code {old}→{new}",
                "log.customer.update.name": "Name {old}→{new}",
                "log.customer.update.phone": "Phone {old}→{new}",
                "log.customer.update.address": "Address {old}→{new}",
                "log.customer.update.id_card": "ID number {old}→{new}",
                "log.customer.update.note": "Note {old}→{new}",
                "log.customer.photo.update": "Customer photo updated",
                "log.customer.balance.adjust": "Adjusted projected balance by {amount}",
                "log.customer.balance.set": "Set projected balance to {amount}",
                "log.customer.balance.next_compound": "Next compound time updated",
                "logs.entity.loan": "Loan",
                "logs.entity.repayment": "Repayment",
                "logs.entity.customer": "Customer",
                "logs.entity.other": "Other",
                "loan.timeline.title": "Loan Timeline",
                "loan.timeline.subtitle": "Timeline for {code}",
                "loan.timeline.close": "Close Timeline",
                "loan.timeline.status.loading": "Loading timeline...",
                "loan.timeline.status.error": "Failed to load timeline: {message}",
                "loan.timeline.status.empty": "No timeline events",
                "loan.timeline.table.time": "Time",
                "loan.timeline.table.action": "Action",
                "loan.timeline.table.change": "Change",
                "loan.timeline.table.balance": "Balance",
                "loan.timeline.table.note": "Note",
                "loan.timeline.event.principal": "Principal",
                "loan.timeline.event.compound_initial": "Pertambahan Kompaun Awal",
                "loan.timeline.event.compound": "Pertumbuhan Kompaun",
                "loan.timeline.event.compound_initial": "Compound Bootstrap",
                "loan.timeline.event.compound": "Compound Growth",
                "loan.timeline.event.initial_interest": "Initial Interest",
                "loan.timeline.event.processing_fee": "Processing Fee",
                "loan.timeline.event.interest_cycle": "Interest Cycle",
                "loan.timeline.event.repayment": "Repayment",
                "loan.timeline.description.interest": "{base} + {rate}% = {result}",
                "loan.timeline.description.repayment": "Repayment {amount}",
                "timeline.view.balance": "Balance Timeline",
                "timeline.view.repayments": "Repayment Timeline",
                "timeline.view.all": "All Timeline",
                "timeline.panel.title": "{name} ({code}) · {view}",
                "timeline.projected_balance": "Current compounded balance: {amount}",
                "timeline.status.loading": "Loading timeline...",
                "timeline.status.error": "Failed to load timeline: {message}",
                "timeline.status.empty": "No timeline events",
                "timeline.table.time": "Time",
                "timeline.table.type": "Event",
                "timeline.table.loan_code": "Loan Code",
                "timeline.table.change": "Change",
                "timeline.table.balance": "Balance",
                "timeline.table.note": "Details",
                "timeline.event.loan_disbursement": "Loan Disbursement",
                "timeline.event.loan_adjustment": "Loan Adjustment",
                "timeline.event.loan_writeoff": "Loan Write-off",
                "timeline.event.repayment": "Repayment",
                "timeline.event.repayment_adjustment": "Repayment Adjustment",
                "timeline.event.repayment_reversal": "Repayment Reversal",
                "timeline.event.compound_growth": "Compound Growth",
                "timeline.event.manual_adjust": "Manual Adjust",
                "timeline.event.manual_override": "Manual Override",
                "timeline.event.baseline": "Opening Balance",
                "timeline.note.compound": "{base} + {rate}% = {result}",
                "timeline.note.repayment": "Repayment {amount}",
                "timeline.note.repayment_with_balance": "Repayment {amount} (balance before payment {previous})",
                "timeline.note.repayment_adjustment": "Repayment {old}→{new}",
                "timeline.note.repayment_reversal": "Reversed {amount}",
                "timeline.note.loan_disbursement": "Loan {loan} compounded to {compounded}",
                "timeline.note.loan_adjustment": "Effective loan {old}→{new}",
                "timeline.note.loan_writeoff": "Write-off {amount}",
                "timeline.note.manual_adjust": "Previous balance {previous}",
                "timeline.note.manual_override": "Target balance {target}",
                "timeline.note.baseline": "Opening balance {amount}",
                "button.cancel": "Cancel",
                "button.save": "Save",
                "button.save_balance": "Save Adjustment",
                "button.upload": "Upload",
                "button.loading": "Loading...",
                "button.refreshing": "Refreshing...",
                "button.clear": "Clear",
                "customer.search.label": "Search Customers",
                "customer.search.placeholder": "Search by code, name, phone, ID, note, or address",
                "summary.search.label": "Summary Search",
                "summary.search.placeholder": "Search by code, name, phone, ID, note, or address",
                "pagination.prev": "Previous",
                "pagination.next": "Next",
                "pagination.status": "Page {page}/{totalPages} · Showing {start}-{end} of {total}",
                "table.loading": "Loading...",
                "modal.balance.title": "Adjust Projected Balance",
                "modal.balance.current": "Current projected balance:",
                "modal.balance.loan_code": "Linked loan (required)",
                "modal.balance.loan_code_placeholder": "Select a loan code",
                "modal.balance.remaining_prefix": "Remaining: ",
                "modal.balance.adjust_amount": "Adjustment amount (can be negative)",
                "modal.balance.new_balance": "Or set a new projected balance",
                "modal.balance.next_compound": "Next compound time (optional)",
                "modal.balance.tip": "If you set a new projected balance it overrides the adjustment value; otherwise the adjustment is applied on top of the current balance.",
                "placeholder.balance_new": "Leave blank to use the adjustment",
                "summary.empty": "No records",
                "modal.customer.profile": "Customer Profile",
                "modal.customer.phone": "Phone Number",
                "modal.customer.address": "Address",
                "modal.photo.title": "Upload Customer Photo",
                "modal.photo.select_image": "Select Image",
                "label.photo_modal_preview": "Preview",
                "prompt.new_loan_amount": "Enter the new loan amount",
                "prompt.new_repayment_amount": "Enter the new repayment amount",
                "prompt.new_loan_date": "Enter the new loan date & time (YYYY-MM-DD HH:MM)",
                "prompt.new_repayment_date": "Enter the new repayment date & time (YYYY-MM-DD HH:MM)",
                "confirm.delete_loan": "Delete this loan record?",
                "confirm.delete_repayment": "Delete this repayment record?",
                "alert.loan_delete_success": "Loan record deleted",
                "alert.repayment_delete_success": "Repayment record deleted",
                "alert.delete_failed": "Delete failed: {message}",
                "error.amount_non_negative": "Amount must be a non-negative number",
                "alert.loan_update_success": "Loan amount updated",
                "alert.repayment_update_success": "Repayment amount updated",
                "alert.loan_date_update_success": "Loan date updated",
                "alert.repayment_date_update_success": "Repayment date updated",
                "alert.update_failed": "Update failed: {message}",
                "alert.submit_failed": "Submission failed: {detail}",
                "alert.customer_not_found": "Customer not found",
                "alert.no_changes": "No changes to update",
                "alert.customer_update_success": "Customer information updated",
                "alert.photo_required": "Please select an image first",
                "alert.photo_update_success": "Photo updated",
                "alert.upload_failed": "Upload failed: {message}",
                "alert.date_range_invalid": "End date cannot be before start date",
                "error.balance_new_numeric": "New projected balance must be a number",
                "error.balance_new_non_negative": "New projected balance cannot be negative",
                "error.adjust_amount_numeric": "Adjustment amount must be a number",
                "error.balance_loan_required": "Please choose a loan code",
                "error.balance_loan_no_remaining": "The selected loan already has a 0 remaining balance",
                "alert.balance_value_required": "Provide either an adjustment amount or a new projected balance",
                "alert.balance_no_loans": "This customer has no loans, so the balance cannot be adjusted",
                "alert.balance_no_active_loans": "All loans for this customer are fully repaid; balance cannot be adjusted",
                "error.next_compound_invalid": "Next compound time format is invalid",
                "error.datetime_invalid": "Invalid date/time format. Use YYYY-MM-DD HH:MM",
                "error.datetime_future": "Date/time cannot be in the future",
                "alert.balance_update_success": "Projected balance updated",
            },
            ms: {
                "language.label": "Bahasa Antaramuka",
                "language.option.zh": "Bahasa Cina",
                "language.option.en": "Bahasa Inggeris",
                "language.option.ms": "Bahasa Melayu",
                "menu.title": "Menu Fungsi",
                "menu.add_customer": "Tambah Pelanggan",
                "menu.customer_list": "Senarai Pelanggan",
                "menu.add_loan": "Tambah Pinjaman",
                "menu.add_repayment": "Tambah Bayaran Balik",
                "menu.records": "Rekod Pinjaman/Bayaran",
                "menu.bank_ledger": "Ledger Bank",
                "menu.operation_logs": "Log Operasi",
                "menu.summary": "Ringkasan Pelanggan",
                "menu.overall_report": "Laporan Keseluruhan",
                "topbar.current_user_prefix": "Log masuk sebagai:",
                "topbar.logout": "Log Keluar",
                "menu.admin_access": "Pengurusan Admin",
                "page.title": "Papan Rekod Pinjaman",
                "page.hero.subtitle": "Semak pinjaman dan bayaran secara ringkas serta lompat ke tugasan utama.",
                "page.hero.timezone": "Beroperasi dalam MYT (UTC+8)",
                "page.hero.quick_nav": "Navigasi Pantas",
                "page.hero.primary_action": "Lihat rekod terkini",
                "page.hero.secondary_action": "Tambah pinjaman baharu",
                "hero.metric.customers": "Jumlah Pelanggan",
                "hero.metric.loans": "Rekod Pinjaman",
                "hero.metric.repayments": "Rekod Bayaran",
                "section.add_customer": "Tambah Pelanggan",
                "section.customer_list": "Senarai Pelanggan",
                "section.customer_transactions": "Transaksi Pelanggan",
                "section.add_loan": "Tambah Pinjaman",
                "section.add_repayment": "Tambah Bayaran Balik",
                "section.records": "Rekod Pinjaman/Bayaran",
                "section.bank_ledger": "Ledger Bank",
                "section.bank_ledger_desc": "Pantau baki bank, laras manual dan jejak setiap transaksi pinjaman atau bayaran balik.",
                "section.summary": "Ringkasan Pelanggan",
                "section.operation_logs": "Log Operasi",
                "section.overall_report": "Laporan Keseluruhan",
                "section.operation_logs_note": "Merekod setiap tindakan pelanggan, pinjaman dan bayaran untuk tujuan audit.",
                "form.customer.customer_code": "Kod Pelanggan",
                "placeholder.customer_code": "cth. CUST-XXXXXX",
                "form.customer.name": "Nama",
                "form.customer.phone": "Telefon",
                "form.customer.id_card": "No. Kad Pengenalan",
                "placeholder.customer_id_card": "cth. 880101-14-5678",
                "form.customer.address": "Alamat",
                "form.customer.note": "Catatan",
                "form.customer.photo": "Gambar Pelanggan",
                "label.photo_preview": "Pratonton Foto",
                "button.save_customer": "Simpan Pelanggan",
                "table.customers.no": "No.",
                "table.customers.code": "Kod Pelanggan",
                "table.customers.name": "Nama",
                "table.customers.phone": "Telefon",
                "table.customers.id_card": "No. Kad Pengenalan",
                "table.customers.address": "Alamat",
                "table.customers.photo": "Foto",
                "table.customers.note": "Catatan",
                "table.customers.created": "Tarikh Ditambah",
                "table.customers.actions": "Tindakan",
                "table.empty": "Tiada data",
                "button.profile": "Profil",
                "button.phone": "Telefon",
                "button.address": "Alamat",
                "button.balance": "Baki",
                "button.photo": "Foto",
                "button.transactions": "Transaksi",
                "button.load_overall_report": "Muat Laporan",
                "button.loading": "Sedang dimuat...",
                "button.view_balance_timeline": "Lihat Aliran Baki",
                "button.view_repayment_timeline": "Lihat Aliran Bayaran",
                "button.view_all_timeline": "Lihat Semua Aliran",
                "button.refresh": "Segar Semula",
                "customer.transactions.placeholder": "Pilih pelanggan untuk melihat transaksi.",
                "customer.transactions.title": "Transaksi {name} ({code})",
                "customer.transactions.loan_table": "Rekod Pinjaman",
                "customer.transactions.repayment_table": "Rekod Bayaran",
                "customer.transactions.date_filter.label": "Julat Tarikh",
                "customer.transactions.date_filter.start": "Tarikh Mula",
                "customer.transactions.date_filter.end": "Tarikh Tamat",
                "customer.transactions.date_filter.reset": "Kosongkan Tarikh",
                "report.overall.description": "Lihat jumlah pinjaman dan bayaran keseluruhan mengikut tarikh.",
                "report.overall.start_date": "Tarikh Mula",
                "report.overall.end_date": "Tarikh Tamat",
                "report.overall.status.ready": "Pilih julat tarikh dan muat laporan.",
                "report.overall.status.loading": "Sedang memuat laporan...",
                "report.overall.status.loaded": "Laporan dikemas kini.",
                "report.overall.status.error": "Gagal memuat laporan: {message}",
                "report.overall.total_loan_amount": "Jumlah Pinjaman",
                "report.overall.loan_count": "Bilangan Pinjaman",
                "report.overall.total_repayment_amount": "Jumlah Bayaran",
                "report.overall.repayment_count": "Bilangan Bayaran",
                "report.overall.fee_income": "Pendapatan Yuran",
                "report.overall.interest_profit": "Keuntungan Faedah",
                "report.overall.net_profit": "Untung Bersih (Bayar - Pinjam)",
                "report.overall.total_customers": "Jumlah Pelanggan",
                "report.overall.new_customers": "Pelanggan Baharu",
                "date.range.today": "Hari Ini",
                "date.range.this_week": "Minggu Ini",
                "date.range.this_month": "Bulan Ini",
                "date.range.last_week": "Minggu Lalu",
                "date.range.last_month": "Bulan Lalu",
                "report.overall.range.today": "Hari Ini",
                "report.overall.range.yesterday": "Semalam",
                "report.overall.range.last_week": "Minggu Lalu",
                "report.overall.range.last_month": "Bulan Lalu",
                "table.customer_loans.index": "No. Rekod",
                "table.customer_loans.code": "Kod Pinjaman",
                "table.customer_loans.amount": "Jumlah Pinjaman",
                "table.customer_loans.fee": "Yuran Proses",
                "table.customer_loans.date": "Tarikh Pinjaman",
                "table.customer_loans.note": "Catatan",
                "table.customer_loans.actions": "Tindakan",
                "table.customer_repayments.index": "No. Rekod",
                "table.customer_repayments.loan_code": "Kod Pinjaman",
                "table.customer_repayments.amount": "Jumlah Bayaran",
                "table.customer_repayments.date": "Tarikh Bayaran",
                "table.customer_repayments.note": "Catatan",
                "table.customer_repayments.actions": "Tindakan",
                "button.edit_amount": "Ubah Jumlah",
                "button.edit_date": "Ubah Tarikh",
                "button.view_timeline": "Lihat Aliran",
                "button.delete": "Padam",
                "button.close": "Tutup",
                "totals.total_loan": "Jumlah Pinjaman",
                "totals.total_repayment": "Jumlah Bayaran",
                "totals.interest_profit": "Keuntungan Faedah",
                "totals.fee_income": "Pendapatan Yuran",
                "totals.total_profit": "Untung Bersih (Bayar - Pinjam)",
                "form.loan.customer_code": "Kod Pelanggan",
                "form.loan.amount": "Jumlah",
                "form.loan.fee": "Yuran Pinjaman",
                "form.loan.date": "Tarikh & Masa Pinjaman",
                "form.loan.rate": "Kadar Faedah (%)",
                "form.loan.type": "Jenis Faedah",
                "form.loan.note": "Catatan",
                "option.interest_type.monthly": "Bulanan",
                "option.interest_type.daily": "Harian",
                "button.save_loan": "Simpan Pinjaman",
                "form.repayment.customer_code": "Kod Pelanggan",
                "form.repayment.loan_code": "Kod Pinjaman",
                "form.repayment.amount": "Jumlah",
                "form.repayment.date": "Tarikh & Masa Bayaran",
                "form.repayment.note": "Catatan",
                "button.save_repayment": "Simpan Bayaran",
                "bank.ledger.current_balance": "Baki Semasa",
                "bank.ledger.summary.title": "Ringkasan Akaun",
                "bank.ledger.summary.note": "Pinjaman akan tolak automatik dan bayaran balik akan tambah semula.",
                "bank.ledger.badge.auto": "Auto Sync",
                "bank.ledger.badge.manual": "Laras Manual",
                "bank.ledger.filter.search": "Cari Transaksi",
                "bank.ledger.filter.search_placeholder": "Jenis, catatan, kod pelanggan atau ID",
                "bank.ledger.form.amount": "Jumlah Larasan",
                "bank.ledger.form.direction": "Arah",
                "bank.ledger.form.direction.deposit": "Tambah Tunai (+)",
                "bank.ledger.form.direction.withdrawal": "Tolak Tunai (-)",
                "bank.ledger.form.note": "Catatan (pilihan)",
                "bank.ledger.form.submit": "Simpan Larasan",
                "bank.ledger.limit": "Jumlah Paparan",
                "bank.ledger.table.time": "Masa",
                "bank.ledger.table.type": "Jenis",
                "bank.ledger.table.reference": "Rujukan",
                "bank.ledger.table.amount": "Jumlah",
                "bank.ledger.table.balance": "Baki",
                "bank.ledger.table.note": "Catatan",
                "bank.ledger.status.loading": "Sedang memuatkan transaksi bank...",
                "bank.ledger.status.error": "Gagal dimuat: {message}",
                "bank.ledger.status.empty": "Tiada transaksi bank",
                "bank.ledger.form.success": "Larasan berjaya disimpan",
                "bank.ledger.form.error": "Gagal simpan: {message}",
                "bank.ledger.type.loan_disbursement": "Pengeluaran Pinjaman",
                "bank.ledger.type.loan_adjustment": "Pelaras Pinjaman",
                "bank.ledger.type.loan_reversal": "Pembalikan Pinjaman",
                "bank.ledger.type.repayment_receipt": "Bayaran Masuk",
                "bank.ledger.type.repayment_adjustment": "Pelaras Bayaran",
                "bank.ledger.type.repayment_reversal": "Pembalikan Bayaran",
                "bank.ledger.type.manual_deposit": "Tambah Tunai Manual",
                "bank.ledger.type.manual_withdrawal": "Tolak Tunai Manual",
                "records.start_date": "Tarikh Mula",
                "records.end_date": "Tarikh Tamat",
                "button.load_records": "Muat Rekod",
                "stat.loan_count": "Bilangan Pinjaman",
                "stat.loan_amount": "Jumlah Pinjaman",
                "stat.repay_count": "Bilangan Bayaran",
                "stat.repay_amount": "Jumlah Bayaran",
                "records.loan_table_title": "Rekod Pinjaman",
                "records.repayment_table_title": "Rekod Bayaran",
                "table.loans.code": "Kod Pinjaman",
                "table.loans.id": "ID Rekod",
                "table.loans.customer_code": "Kod Pelanggan",
                "table.loans.date": "Tarikh Pinjaman",
                "table.loans.amount": "Jumlah",
                "table.loans.fee": "Yuran Proses",
                "table.loans.rate": "Kadar Faedah (%)",
                "table.loans.type": "Jenis Faedah",
                "table.loans.note": "Catatan",
                "table.loans.created": "Masa Didaftar",
                "table.repayments.id": "ID",
                "table.repayments.customer_code": "Kod Pelanggan",
                "table.repayments.loan_code": "Kod Pinjaman",
                "table.repayments.date": "Tarikh Bayaran",
                "table.repayments.amount": "Jumlah",
                "table.repayments.note": "Catatan",
                "table.repayments.created": "Masa Didaftar",
                "records.empty.loans": "Tiada rekod pinjaman",
                "records.empty.repayments": "Tiada rekod bayaran",
                "records.status.select_range": "Sila pilih tarikh mula dan tamat",
                "records.status.loading": "Sedang dimuat...",
                "records.status.loaded": "Berjaya memuat {total} rekod",
                "records.status.none": "Tiada rekod dalam julat ini",
                "records.status.future_not_allowed": "Tarikh tidak boleh melebihi hari ini",
                "records.status.error": "Gagal dimuat: {message}",
                "records.search.label": "Carian Rekod",
                "records.search.placeholder": "Cari kod pelanggan atau pinjaman",
                "records.view_filter.label": "Jenis Rekod",
                "records.view_filter.option.all": "Semua Rekod",
                "records.view_filter.option.loans": "Hanya Pinjaman",
                "records.view_filter.option.repayments": "Hanya Bayaran",
                "table.summary.customer_code": "Kod Pelanggan",
                "table.summary.name": "Nama",
                "table.summary.phone": "Telefon",
                "table.summary.loan_total": "Jumlah Pinjaman",
                "table.summary.repayment_total": "Jumlah Bayaran",
                "table.summary.fee_total": "Yuran",
                "table.summary.projected": "Baki Terkumpul",
                "table.summary.next_compound": "Kompoun Seterusnya",
                "table.summary.last_update": "Kemaskini Terakhir",
                "table.summary.created": "Tarikh Ditambah",
                "logs.limit": "Jumlah Paparan",
                "logs.type": "Jenis Entiti",
                "logs.type.all": "Semua",
                "logs.type.loan": "Pinjaman",
                "logs.type.repayment": "Bayaran",
                "logs.type.customer": "Pelanggan",
                "button.refresh_logs": "Segar Semula",
                "logs.table.time": "Masa",
                "logs.table.entity": "Entiti",
                "logs.table.customer_code": "Kod Pelanggan",
                "logs.table.entity_id": "ID Rekod",
                "logs.table.action": "Tindakan",
                "logs.table.description": "Huraian",
                "logs.table.metadata": "Butiran",
                "logs.date_filter.start": "Tarikh Mula",
                "logs.date_filter.end": "Tarikh Tamat",
                "logs.status.empty": "Tiada log",
                "logs.status.loading": "Sedang dimuat...",
                "logs.status.showing": "Memaparkan {total} log terkini",
                "logs.status.invalid_range": "Tarikh tamat tidak boleh sebelum tarikh mula",
                "logs.status.error": "Gagal memuat log: {message}",
                "log.loan.create": "Cipta pinjaman, jumlah {amount}, yuran {fee}",
                "log.loan.delete": "Padam pinjaman, tolak {amount}",
                "log.loan.update.amount": "Jumlah pinjaman {old}→{new}",
                "log.loan.update.loan_date": "Tarikh pinjaman {old}→{new}",
                "log.loan.update.processing_fee": "Yuran proses {old}→{new}",
                "log.loan.update.interest_rate": "Kadar faedah {old}→{new}",
                "log.loan.update.interest_type": "Jenis faedah {old}→{new}",
                "log.loan.update.note": "Catatan {old}→{new}",
                "log.repayment.create": "Tambah bayaran balik, jumlah {amount}",
                "log.repayment.delete": "Padam bayaran balik, pulihkan {amount}",
                "log.repayment.update.amount": "Jumlah bayaran balik {old}→{new}",
                "log.repayment.update.date": "Tarikh bayaran {old}→{new}",
                "log.repayment.update.note": "Catatan {old}→{new}",
                "log.customer.create": "Cipta pelanggan {code}",
                "log.customer.update.customer_code": "Kod pelanggan {old}→{new}",
                "log.customer.update.name": "Nama {old}→{new}",
                "log.customer.update.phone": "Telefon {old}→{new}",
                "log.customer.update.address": "Alamat {old}→{new}",
                "log.customer.update.id_card": "Kad pengenalan {old}→{new}",
                "log.customer.update.note": "Catatan {old}→{new}",
                "log.customer.photo.update": "Foto pelanggan dikemas kini",
                "log.customer.balance.adjust": "Laras baki terkumpul sebanyak {amount}",
                "log.customer.balance.set": "Tetapkan baki terkumpul kepada {amount}",
                "log.customer.balance.next_compound": "Kemas kini masa kompaun seterusnya",
                "logs.entity.loan": "Pinjaman",
                "logs.entity.repayment": "Bayaran",
                "logs.entity.customer": "Pelanggan",
                "logs.entity.other": "Lain-lain",
                "loan.timeline.title": "Aliran Pinjaman",
                "loan.timeline.subtitle": "Aliran untuk {code}",
                "loan.timeline.close": "Tutup Aliran",
                "loan.timeline.status.loading": "Sedang memuat aliran...",
                "loan.timeline.status.error": "Gagal memuat aliran: {message}",
                "loan.timeline.status.empty": "Tiada peristiwa aliran",
                "loan.timeline.table.time": "Masa",
                "loan.timeline.table.action": "Tindakan",
                "loan.timeline.table.change": "Perubahan",
                "loan.timeline.table.balance": "Baki",
                "loan.timeline.table.note": "Catatan",
                "loan.timeline.event.principal": "Prinsipal",
                "loan.timeline.event.initial_interest": "Faedah Awal",
                "loan.timeline.event.processing_fee": "Yuran Proses",
                "loan.timeline.event.interest_cycle": "Kitaran Faedah",
                "loan.timeline.event.repayment": "Bayaran",
                "loan.timeline.description.interest": "{base} + {rate}% = {result}",
                "loan.timeline.description.repayment": "Bayaran {amount}",
                "timeline.view.balance": "Aliran Baki Kompaun",
                "timeline.view.repayments": "Aliran Bayaran Balik",
                "timeline.view.all": "Semua Aliran",
                "timeline.panel.title": "{name} ({code}) · {view}",
                "timeline.projected_balance": "Baki kompaun semasa: {amount}",
                "timeline.status.loading": "Sedang memuat aliran...",
                "timeline.status.error": "Gagal memuat aliran: {message}",
                "timeline.status.empty": "Tiada peristiwa aliran",
                "timeline.table.time": "Masa",
                "timeline.table.type": "Peristiwa",
                "timeline.table.loan_code": "Kod Pinjaman",
                "timeline.table.change": "Perubahan",
                "timeline.table.balance": "Baki",
                "timeline.table.note": "Catatan",
                "timeline.event.loan_disbursement": "Pinjaman Dikredit",
                "timeline.event.loan_adjustment": "Pelarasan Pinjaman",
                "timeline.event.loan_writeoff": "Padam Pinjaman",
                "timeline.event.repayment": "Bayaran",
                "timeline.event.repayment_adjustment": "Pelarasan Bayaran",
                "timeline.event.repayment_reversal": "Pembatalan Bayaran",
                "timeline.event.compound_growth": "Pertumbuhan Kompaun",
                "timeline.event.manual_adjust": "Pelarasan Manual",
                "timeline.event.manual_override": "Tetapan Manual",
                "timeline.event.baseline": "Baki Permulaan",
                "timeline.note.compound": "{base} + {rate}% = {result}",
                "timeline.note.repayment": "Bayaran {amount}",
                "timeline.note.repayment_with_balance": "Bayaran {amount}, baki sebelum {previous}",
                "timeline.note.repayment_adjustment": "Bayaran {old}→{new}",
                "timeline.note.repayment_reversal": "Batal bayaran {amount}",
                "timeline.note.loan_disbursement": "Pinjaman {loan} menjadi {compounded}",
                "timeline.note.loan_adjustment": "Pinjaman efektif {old}→{new}",
                "timeline.note.loan_writeoff": "Padam {amount}",
                "timeline.note.manual_adjust": "Baki terdahulu {previous}",
                "timeline.note.manual_override": "Tetapkan baki {target}",
                "timeline.note.baseline": "Baki permulaan {amount}",
                "button.cancel": "Batal",
                "button.save": "Simpan",
                "button.save_balance": "Simpan Pelarasan",
                "button.upload": "Muat Naik",
                "button.loading": "Sedang dimuat...",
                "button.refreshing": "Sedang segar semula...",
                "button.clear": "Kosongkan",
                "customer.search.label": "Carian Pelanggan",
                "customer.search.placeholder": "Cari kod, nama, telefon, IC, catatan atau alamat",
                "summary.search.label": "Carian Ringkasan",
                "summary.search.placeholder": "Cari kod, nama, telefon, IC, catatan atau alamat",
                "pagination.prev": "Sebelumnya",
                "pagination.next": "Seterusnya",
                "pagination.status": "Halaman {page}/{totalPages} · Papar {start}-{end} daripada {total}",
                "table.loading": "Sedang dimuat...",
                "modal.balance.title": "Laraskan Baki Terkumpul",
                "modal.balance.current": "Baki terkumpul semasa:",
                "modal.balance.loan_code": "Pinjaman berkaitan (wajib)",
                "modal.balance.loan_code_placeholder": "Pilih kod pinjaman",
                "modal.balance.remaining_prefix": "Baki: ",
                "modal.balance.adjust_amount": "Jumlah pelarasan (boleh negatif)",
                "modal.balance.new_balance": "Atau tetapkan baki terkumpul baharu",
                "modal.balance.next_compound": "Masa kompaun seterusnya (pilihan)",
                "modal.balance.tip": "Jika tetapkan baki terkumpul baharu, nilai itu akan digunakan dan pelarasan akan diabaikan.",
                "placeholder.balance_new": "Kosongkan untuk guna pelarasan",
                "summary.empty": "Tiada rekod",
                "modal.customer.profile": "Profil Pelanggan",
                "modal.customer.phone": "Nombor Telefon",
                "modal.customer.address": "Alamat",
                "modal.photo.title": "Muat Naik Foto Pelanggan",
                "modal.photo.select_image": "Pilih Gambar",
                "label.photo_modal_preview": "Pratonton",
                "prompt.new_loan_amount": "Masukkan jumlah pinjaman baharu",
                "prompt.new_repayment_amount": "Masukkan jumlah bayaran baharu",
                "prompt.new_loan_date": "Masukkan tarikh & masa pinjaman baharu (YYYY-MM-DD HH:MM)",
                "prompt.new_repayment_date": "Masukkan tarikh & masa bayaran baharu (YYYY-MM-DD HH:MM)",
                "confirm.delete_loan": "Padam rekod pinjaman ini?",
                "confirm.delete_repayment": "Padam rekod bayaran ini?",
                "alert.loan_delete_success": "Rekod pinjaman dipadam",
                "alert.repayment_delete_success": "Rekod bayaran dipadam",
                "alert.delete_failed": "Gagal padam: {message}",
                "error.amount_non_negative": "Jumlah mesti bukan negatif",
                "alert.loan_update_success": "Jumlah pinjaman dikemas kini",
                "alert.repayment_update_success": "Jumlah bayaran dikemas kini",
                "alert.loan_date_update_success": "Tarikh pinjaman dikemas kini",
                "alert.repayment_date_update_success": "Tarikh bayaran dikemas kini",
                "alert.update_failed": "Gagal kemas kini: {message}",
                "alert.submit_failed": "Penyerahan gagal: {detail}",
                "alert.customer_not_found": "Pelanggan tidak ditemui",
                "alert.no_changes": "Tiada perubahan untuk dikemas kini",
                "alert.customer_update_success": "Maklumat pelanggan dikemas kini",
                "alert.photo_required": "Sila pilih gambar dahulu",
                "alert.photo_update_success": "Foto dikemas kini",
                "alert.upload_failed": "Muat naik gagal: {message}",
                "alert.date_range_invalid": "Tarikh tamat tidak boleh sebelum tarikh mula",
                "error.balance_new_numeric": "Baki terkumpul baharu mesti numerik",
                "error.balance_new_non_negative": "Baki terkumpul baharu tidak boleh negatif",
                "error.adjust_amount_numeric": "Jumlah pelarasan mesti numerik",
                "error.balance_loan_required": "Sila pilih kod pinjaman",
                "error.balance_loan_no_remaining": "Pinjaman yang dipilih mempunyai baki 0 dan tidak boleh dilaras",
                "alert.balance_value_required": "Isi jumlah pelarasan atau baki terkumpul baharu",
                "alert.balance_no_loans": "Pelanggan ini tiada rekod pinjaman, baki tidak boleh dilaras",
                "alert.balance_no_active_loans": "Semua pinjaman pelanggan ini telah habis dibayar; baki tidak boleh dilaras",
                "error.next_compound_invalid": "Format masa kompaun seterusnya tidak sah",
                "error.datetime_invalid": "Format tarikh/masa tidak sah. Gunakan YYYY-MM-DD HH:MM",
                "error.datetime_future": "Tarikh/masa tidak boleh selepas masa sekarang",
                "alert.balance_update_success": "Baki terkumpul dikemas kini"
            },
        };
        let currentLanguage = localStorage.getItem("appLanguage") || "en";
        const INTEREST_TYPE_KEY_MAP = {
            "月息": "option.interest_type.monthly",
            "日息": "option.interest_type.daily",
            monthly: "option.interest_type.monthly",
            daily: "option.interest_type.daily",
            "month": "option.interest_type.monthly",
            "day": "option.interest_type.daily"
        };
        const ENTITY_TYPE_KEY_MAP = {
            loan: "logs.entity.loan",
            repayment: "logs.entity.repayment",
            customer: "logs.entity.customer"
        };
        let customerTimelineCache = new Map();
        let currentTimelineCustomerId = null;
        let currentTimelineView = null;
        let overallReportData = null;
        let overallReportRenderer = null;
        let overallReportStatusState = { key: "report.overall.status.ready", replacements: {}, isError: false };

        function translate(key, replacements = {}) {
            const fallbackDict = TRANSLATIONS.zh || {};
            const dict = TRANSLATIONS[currentLanguage] || fallbackDict;
            const template = dict[key] ?? fallbackDict[key] ?? key;
            return template.replace(/\{(\w+)\}/g, (_, token) => {
                if (Object.prototype.hasOwnProperty.call(replacements, token)) {
                    return replacements[token];
                }
                return `{${token}}`;
            });
        }

        function resolveLanguagePreference(lang) {
            if (lang && Object.prototype.hasOwnProperty.call(TRANSLATIONS, lang)) {
                return lang;
            }
            return "en";
        }

        function applyStaticTranslations(context = document) {
            if (!context) {
                return;
            }
            context.querySelectorAll("[data-i18n]").forEach((el) => {
                const key = el.getAttribute("data-i18n");
                if (!key) {
                    return;
                }
                el.textContent = translate(key);
            });
            context.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
                const key = el.getAttribute("data-i18n-placeholder");
                if (!key) {
                    return;
                }
                el.setAttribute("placeholder", translate(key));
            });
            context.querySelectorAll("[data-i18n-alt]").forEach((el) => {
                const key = el.getAttribute("data-i18n-alt");
                if (!key) {
                    return;
                }
                el.setAttribute("alt", translate(key));
            });
        }

        function initLanguageSwitcher() {
            const select = document.getElementById("language-select");
            const preferred = resolveLanguagePreference(currentLanguage);
            currentLanguage = preferred;
            document.documentElement?.setAttribute("lang", preferred);
            applyStaticTranslations();
            if (!select) {
                return;
            }
            select.value = preferred;
            select.addEventListener("change", () => {
                const next = resolveLanguagePreference(select.value);
                if (next === currentLanguage) {
                    return;
                }
                localStorage.setItem("appLanguage", next);
                window.location.reload();
            });
        }

        function showConfirm(key, replacements = {}) {
            return window.confirm(translate(key, replacements));
        }

        function showPrompt(key, defaultValue = "", replacements = {}) {
            return window.prompt(translate(key, replacements), defaultValue);
        }

        function showAlert(key, replacements = {}) {
            window.alert(translate(key, replacements));
        }

        function translateInterestType(value) {
            if (!value && value !== 0) {
                return "-";
            }
            const trimmed = value.toString().trim();
            const normalized = trimmed.toLowerCase();
            const key = INTEREST_TYPE_KEY_MAP[trimmed] || INTEREST_TYPE_KEY_MAP[normalized];
            if (key) {
                return translate(key);
            }
            return trimmed || "-";
        }

        function refreshInterestTypeLabels(context = document) {
            context.querySelectorAll("[data-interest-type]").forEach((el) => {
                const raw = el.dataset.interestType;
                el.textContent = translateInterestType(raw);
            });
        }

        function translateEntityType(value) {
            if (!value && value !== 0) {
                return translate("logs.entity.other");
            }
            const normalized = value.toString().trim().toLowerCase();
            const key = ENTITY_TYPE_KEY_MAP[normalized];
            if (key) {
                return translate(key);
            }
            return translate("logs.entity.other");
        }

        function translateLedgerType(value) {
            if (!value && value !== 0) {
                return "-";
            }
            const normalized = value.toString().trim().toLowerCase();
            if (!normalized) {
                return "-";
            }
            const key = `bank.ledger.type.${normalized}`;
            const translated = translate(key);
            return translated === key ? normalized : translated;
        }

        function formatBankLedgerReference(entry) {
            if (!entry) {
                return "-";
            }
            const type = (entry.reference_type || "").toString().trim().toLowerCase();
            const id = entry.reference_id;
            if (!type) {
                return "-";
            }
            const labelKey = ENTITY_TYPE_KEY_MAP[type];
            const label = labelKey ? translate(labelKey) : type;
            if (id === 0) {
                return `${label} #0`;
            }
            if (id) {
                return `${label} #${id}`;
            }
            return label;
        }

        function refreshEntityTypeLabels(context = document) {
            context.querySelectorAll("[data-entity-type]").forEach((el) => {
                const raw = el.dataset.entityType || "";
                el.textContent = translateEntityType(raw);
            });
        }

        const DEFAULT_PAGE_SIZE = 20;
        const paginationRegistry = new Set();

        function refreshAllPaginators() {
            paginationRegistry.forEach((paginator) => {
                try {
                    paginator.refresh();
                } catch (error) {
                    /* noop */
                }
            });
        }

        let customerStore = new Map();
        let customersDataset = [];
        let customerSearchQuery = "";
        let loansStore = [];
        let repaymentsStore = [];
        let summaryStore = new Map();
        let summaryDataset = [];
        let summarySearchQuery = "";
        let operationLogsStore = [];
        let operationLogsRenderer = null;
        let customerListPaginator = null;
        let customerLoansPaginator = null;
        let customerRepaymentsPaginator = null;
        let recordsLoansPaginator = null;
        let recordsRepaymentsPaginator = null;
        let summaryPaginator = null;
        let operationLogsPaginator = null;
        let customerModalMode = "profile";
        let customerModalId = null;
        let photoModalCustomerId = null;
        let balanceModalCustomerId = null;
        let balanceModalLoanMap = new Map();
        let balanceModalFallbackBalance = 0;
        let customerTransactionsViewFilter = "all";
        let customerTransactionsDateRange = { start: "", end: "" };
        let timelineDateRange = { start: "", end: "" };
        let currentCustomerLoanRows = [];
        let currentCustomerRepaymentRows = [];
        let activeCustomerId = null;
        let activeCustomerInfo = null;
        const CUSTOMER_MODAL_FIELDS = {
            profile: ["name", "phone", "address", "id_card", "note"],
            phone: ["phone"],
            address: ["address"],
        };
        const CUSTOMER_MODAL_TITLES = {
            profile: "modal.customer.profile",
            phone: "modal.customer.phone",
            address: "modal.customer.address",
        };

        function sanitizeCustomersDataset(data) {
            const items = Array.isArray(data) ? data : [];
            const seenIds = new Set();
            return items
                .filter((item) => item && typeof item === "object")
                .filter((item) => {
                    const id = Number(item.id);
                    if (!Number.isFinite(id) || id <= 0) {
                        return false;
                    }
                    if (seenIds.has(id)) {
                        return false;
                    }
                    seenIds.add(id);
                    return true;
                })
                .map((item) => ({
                    ...item,
                    customer_code: (item.customer_code || "").toString().trim(),
                }));
        }

        function normalizeSearchValue(value) {
            return (value ?? "").toString().trim().toLowerCase();
        }

        function filterCustomersDataset() {
            const query = normalizeSearchValue(customerSearchQuery);
            if (!query) {
                return [...customersDataset];
            }
            return customersDataset.filter((customer) => {
                return ["customer_code", "name", "phone", "id_card", "address", "note"].some((field) => {
                    const fieldValue = normalizeSearchValue(customer?.[field]);
                    return fieldValue.includes(query);
                });
            });
        }

        function refreshCustomerListView(options = {}) {
            const filtered = filterCustomersDataset();
            customerListPaginator?.setItems(filtered, options);
        }

        async function refreshCustomersFromApi() {
            try {
                const response = await fetch("/api/customers");
                if (!response.ok) {
                    throw new Error(response.statusText || "HTTP error");
                }
                const payload = await response.json();
                const sanitized = sanitizeCustomersDataset(payload);
                if (!sanitized.length) {
                    return;
                }
                customersDataset = sanitized;
                customerStore = new Map(customersDataset.map((item) => [item.id, item]));
                refreshCustomerListView({ preservePage: true });
            } catch (error) {
                console.warn("Failed to refresh customers", error);
            }
        }

        function createPaginator({ controls, pageSize = DEFAULT_PAGE_SIZE, onPage }) {
            const controlsEl = typeof controls === "string" ? document.getElementById(controls) : controls;
            let items = [];
            let currentPage = 1;

            const getMeta = (page = currentPage) => {
                const total = items.length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                const safePage = Math.min(Math.max(1, page), totalPages);
                const start = total ? (safePage - 1) * pageSize : 0;
                const end = total ? Math.min(start + pageSize, total) : 0;
                return { page: safePage, totalPages, total, start, end, pageSize };
            };

            const renderControls = (meta) => {
                if (!controlsEl) return;
                const hasData = meta.total > 0;
                const prevDisabled = !hasData || meta.page <= 1;
                const nextDisabled = !hasData || meta.page >= meta.totalPages;
                const prevLabel = translate("pagination.prev");
                const nextLabel = translate("pagination.next");
                const startDisplay = hasData ? meta.start + 1 : 0;
                const endDisplay = hasData ? meta.end : 0;
                const statusText = hasData
                    ? translate("pagination.status", {
                        page: meta.page,
                        totalPages: meta.totalPages,
                        start: startDisplay,
                        end: endDisplay,
                        total: meta.total,
                    })
                    : translate("table.empty");
                controlsEl.innerHTML = `
                    <button type="button" class="inline-btn secondary-btn" data-page-action="prev" ${prevDisabled ? "disabled" : ""}>${escapeHtml(prevLabel)}</button>
                    <span class="pagination-status">${escapeHtml(statusText)}</span>
                    <button type="button" class="inline-btn secondary-btn" data-page-action="next" ${nextDisabled ? "disabled" : ""}>${escapeHtml(nextLabel)}</button>
                `;
            };

            const renderPage = (page) => {
                const meta = getMeta(page);
                currentPage = meta.page;
                const hasData = meta.total > 0;
                const rows = hasData ? items.slice(meta.start, meta.end) : [];
                if (typeof onPage === "function") {
                    onPage(rows, meta);
                }
                renderControls(meta);
            };

            controlsEl?.addEventListener("click", (event) => {
                const button = event.target.closest("[data-page-action]");
                if (!button) return;
                const action = button.dataset.pageAction;
                const meta = getMeta();
                if (action === "prev" && meta.page > 1) {
                    renderPage(meta.page - 1);
                }
                if (action === "next" && meta.page < meta.totalPages) {
                    renderPage(meta.page + 1);
                }
            });

            const api = {
                setItems(newItems, options = {}) {
                    items = Array.isArray(newItems) ? [...newItems] : [];
                    if (options?.preservePage) {
                        const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
                        currentPage = Math.min(currentPage, totalPages);
                    } else {
                        currentPage = 1;
                    }
                    renderPage(currentPage);
                },
                refresh() {
                    renderPage(currentPage);
                },
                getState() {
                    const meta = getMeta();
                    return { ...meta };
                },
            };

            paginationRegistry.add(api);
            return api;
        }

        function renderCustomerListRows(rows, meta = { start: 0 }) {
            const body = document.getElementById("customers-table-body");
            if (!body) return;
            if (!rows.length) {
                const emptyText = escapeHtml(translate("table.empty"));
                body.innerHTML = `<tr><td colspan="10" data-i18n="table.empty">${emptyText}</td></tr>`;
                return;
            }
            const profileLabel = escapeHtml(translate("button.profile"));
            const phoneLabel = escapeHtml(translate("button.phone"));
            const addressLabel = escapeHtml(translate("button.address"));
            const balanceLabel = escapeHtml(translate("button.balance"));
            const photoLabel = escapeHtml(translate("button.photo"));
            const transactionsLabel = escapeHtml(translate("button.transactions"));
            body.innerHTML = rows
                .map((customer, index) => {
                    const rowNumber = (meta?.start ?? 0) + index + 1;
                    const photoHtml = customer.photo_url
                        ? `<img src="${escapeHtml(customer.photo_url)}" alt="${escapeHtml(customer.name || customer.customer_code || '-')}">`
                        : "-";
                    return `
                    <tr data-customer-row="${customer.id}">
                        <td>${rowNumber}</td>
                        <td class="customer-code">${escapeHtml(customer.customer_code || '-')}</td>
                        <td data-field="name">${escapeHtml(customer.name || '-')}</td>
                        <td data-field="phone">${escapeHtml(customer.phone || '-')}</td>
                        <td data-field="id_card">${escapeHtml(customer.id_card || '-')}</td>
                        <td data-field="address">${escapeHtml(customer.address || '-')}</td>
                        <td data-field="note">${escapeHtml(customer.note || '-')}</td>
                        <td class="customer-photo-cell">${photoHtml}</td>
                        <td>${escapeHtml(formatMytDateTime(customer.created_at))}</td>
                        <td class="customer-actions">
                            <button type="button" class="inline-btn customer-action" data-action="profile" data-customer-id="${customer.id}" data-i18n="button.profile">${profileLabel}</button>
                            <button type="button" class="inline-btn customer-action" data-action="phone" data-customer-id="${customer.id}" data-i18n="button.phone">${phoneLabel}</button>
                            <button type="button" class="inline-btn customer-action" data-action="address" data-customer-id="${customer.id}" data-i18n="button.address">${addressLabel}</button>
                            <button type="button" class="inline-btn customer-action" data-action="balance" data-customer-id="${customer.id}" data-i18n="button.balance">${balanceLabel}</button>
                            <button type="button" class="inline-btn customer-action" data-action="photo" data-customer-id="${customer.id}" data-i18n="button.photo">${photoLabel}</button>
                            <button type="button" class="inline-btn customer-action" data-action="transactions" data-customer-id="${customer.id}" data-i18n="button.transactions">${transactionsLabel}</button>
                        </td>
                    </tr>`;
                })
                .join("");
        }

        function renderCustomerLoanRows(rows, meta = { start: 0 }) {
            const loansBody = document.getElementById("customer-loans-body");
            if (!loansBody) return;
            if (!rows.length) {
                const emptyText = escapeHtml(translate("records.empty.loans"));
                loansBody.innerHTML = `<tr><td colspan="7" data-i18n="records.empty.loans">${emptyText}</td></tr>`;
                return;
            }
            const editLabel = escapeHtml(translate("button.edit_amount"));
            const editDateLabel = escapeHtml(translate("button.edit_date"));
            loansBody.innerHTML = rows
                .map((loan, index) => {
                    const rowNumber = (meta?.start ?? 0) + index + 1;
                    return `
                    <tr>
                        <td>${rowNumber}</td>
                        <td>${escapeHtml(loan.loan_code || '-')}</td>
                        <td>${escapeHtml(formatAmount(loan.loan_amount))}</td>
                        <td>${escapeHtml(formatAmount(loan.processing_fee || 0))}</td>
                        <td>${escapeHtml(formatMytDateTime(loan.loan_date))}</td>
                        <td>${escapeHtml(loan.note || '-')}</td>
                        <td>
                            <button type="button" class="inline-btn" data-loan-id="${loan.id}" data-current-amount="${loan.loan_amount || 0}" data-i18n="button.edit_amount" onclick="editLoanAmount(this.dataset.loanId, this.dataset.currentAmount)">${editLabel}</button>
                            <button type="button" class="inline-btn" data-loan-id="${loan.id}" data-current-date="${escapeHtml(loan.loan_date || '')}" data-i18n="button.edit_date" onclick="editLoanDate(this.dataset.loanId, this.dataset.currentDate)">${editDateLabel}</button>
                        </td>
                    </tr>`;
                })
                .join("");
        }

        function renderCustomerRepaymentRows(rows, meta = { start: 0 }) {
            const repaymentsBody = document.getElementById("customer-repayments-body");
            if (!repaymentsBody) return;
            if (!rows.length) {
                const emptyText = escapeHtml(translate("records.empty.repayments"));
                repaymentsBody.innerHTML = `<tr><td colspan="6" data-i18n="records.empty.repayments">${emptyText}</td></tr>`;
                return;
            }
            const editLabel = escapeHtml(translate("button.edit_amount"));
            const editDateLabel = escapeHtml(translate("button.edit_date"));
            repaymentsBody.innerHTML = rows
                .map((item, index) => {
                    const rowNumber = (meta?.start ?? 0) + index + 1;
                    return `
                    <tr>
                        <td>${rowNumber}</td>
                        <td>${escapeHtml(item.loan_code || '-')}</td>
                        <td>${escapeHtml(formatAmount(item.repayment_amount))}</td>
                        <td>${escapeHtml(formatMytDateTime(item.repayment_date))}</td>
                        <td>${escapeHtml(item.note || '-')}</td>
                        <td>
                            <button type="button" class="inline-btn" data-repayment-id="${item.id}" data-current-amount="${item.repayment_amount || 0}" data-i18n="button.edit_amount" onclick="editRepaymentAmount(this.dataset.repaymentId, this.dataset.currentAmount)">${editLabel}</button>
                            <button type="button" class="inline-btn" data-repayment-id="${item.id}" data-current-date="${escapeHtml(item.repayment_date || '')}" data-i18n="button.edit_date" onclick="editRepaymentDate(this.dataset.repaymentId, this.dataset.currentDate)">${editDateLabel}</button>
                        </td>
                    </tr>`;
                })
                .join("");
        }

        function renderSummaryRows(rows) {
            const body = document.getElementById("summary-table-body");
            if (!body) return;
            if (!rows.length) {
                const emptyText = escapeHtml(translate("summary.empty"));
                body.innerHTML = `<tr><td colspan="11" data-i18n="summary.empty">${emptyText}</td></tr>`;
                return;
            }
            body.innerHTML = rows
                .map((row) => `
                <tr>
                    <td>${escapeHtml(row.customer_code || '-')}</td>
                    <td>${escapeHtml(row.name || '-')}</td>
                    <td>${escapeHtml(row.phone || '-')}</td>
                    <td>${escapeHtml(formatAmount(row.total_loan))}</td>
                    <td>${escapeHtml(formatAmount(row.total_repayment))}</td>
                    <td>${escapeHtml(formatAmount(row.total_fee))}</td>
                    <td>${escapeHtml(formatAmount(row.projected_balance))}</td>
                    <td>${escapeHtml(formatMytDateTime(row.next_compound_at))}</td>
                    <td>${escapeHtml(formatMytDateTime(row.last_update))}</td>
                    <td>${escapeHtml(formatMytDateTime(row.customer_created_at))}</td>
                </tr>`)
                .join("");
        }

        function filterSummaryDataset() {
            const query = normalizeSearchValue(summarySearchQuery);
            if (!query) {
                return [...summaryDataset];
            }
            return summaryDataset.filter((item) => {
                const fields = [item?.customer_code, item?.name, item?.phone, item?.id_card, item?.address, item?.note];
                return fields.some((value) => normalizeSearchValue(value).includes(query));
            });
        }

        function refreshSummaryView(options = {}) {
            const filtered = filterSummaryDataset();
            summaryPaginator?.setItems(filtered, options);
        }

        function buildPayload(form) {
            const formData = new FormData(form);
            const payload = {};
            for (const [key, value] of formData.entries()) {
                const field = form.elements.namedItem(key);
                if (field?.type === "file" || value instanceof File) {
                    continue;
                }
                const raw = (value ?? "").toString().trim();
                if (field?.dataset?.datetime === "true") {
                    const normalized = toIsoDateTime(raw);
                    if (!normalized) {
                        throw new Error(translate("error.datetime_invalid"));
                    }
                    if (["loan_date", "repayment_date"].includes(key) && isFutureDateTime(normalized)) {
                        throw new Error(translate("error.datetime_future"));
                    }
                    payload[key] = normalized;
                    continue;
                }
                if (key === "customer_code") {
                    const trimmed = raw.toUpperCase();
                    if (trimmed && !/^[A-Z0-9-]+$/.test(trimmed)) {
                        throw new Error("顾客编号只能包含字母、数字或 -");
                    }
                    payload[key] = trimmed;
                    continue;
                }
                if (key === "loan_code") {
                    const trimmed = raw.toUpperCase();
                    if (trimmed && !/^[A-Z0-9-]+$/.test(trimmed)) {
                        throw new Error("借贷编号只能包含字母、数字或 -");
                    }
                    payload[key] = trimmed;
                    continue;
                }
                if (key === "id_card") {
                    payload[key] = formatMyKad(raw);
                    continue;
                }
                if (key.toLowerCase().includes("date")) {
                    const normalized = isoDate(raw);
                    if (!normalized) {
                        throw new Error("日期格式必须为 YYYY-MM-DD");
                    }
                    payload[key] = normalized;
                    continue;
                }
                payload[key] = raw;
            }
            return payload;
        }

        async function handleSubmit(event, endpoint) {
            event.preventDefault();
            let payload;
            try {
                payload = buildPayload(event.target);
            } catch (error) {
                alert(error.message);
                return;
            }
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const data = await response.json().catch(() => ({ detail: "请求失败" }));
                showAlert("alert.submit_failed", { detail: data.detail || response.statusText });
                return;
            }
            window.location.reload();
        }

        async function editLoanAmount(loanId, currentAmount) {
            const id = Number(loanId);
            const initial = Number(currentAmount) || 0;
            if (!Number.isFinite(id) || id <= 0) return;
            const defaultValue = Number.isFinite(initial) ? initial.toFixed(2) : "";
            const input = showPrompt("prompt.new_loan_amount", defaultValue);
            if (input === null) return;
            const value = Number(input);
            if (!Number.isFinite(value) || value < 0) {
                showAlert("error.amount_non_negative");
                return;
            }
            try {
                const response = await fetch(`/api/loans/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ loan_amount: value })
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(data.detail || response.statusText);
                }
                showAlert("alert.loan_update_success");
                window.location.reload();
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        function normalizePromptDateTime(value) {
            const trimmed = (value ?? "").toString().trim();
            if (!trimmed) return "";
            const candidate = trimmed.includes("T") ? trimmed : trimmed.replace(" ", "T");
            return toIsoDateTime(candidate);
        }

        function toDateRangeTimestamp(value, isRangeEnd = false) {
            const iso = isoDate(value);
            if (!iso) return null;
            const base = new Date(`${iso}T00:00:00`);
            if (Number.isNaN(base.valueOf())) {
                return null;
            }
            if (isRangeEnd) {
                base.setHours(23, 59, 59, 999);
            }
            return base.getTime();
        }

        function filterItemsByDateRange(items, field, range) {
            const collection = Array.isArray(items) ? items : [];
            const startMs = range?.start ? toDateRangeTimestamp(range.start, false) : null;
            const endMs = range?.end ? toDateRangeTimestamp(range.end, true) : null;
            if (!startMs && !endMs) {
                return [...collection];
            }
            return collection.filter((item) => {
                const raw = item?.[field];
                if (!raw) return false;
                const timestamp = new Date(raw).getTime();
                if (Number.isNaN(timestamp)) {
                    return false;
                }
                if (startMs && timestamp < startMs) {
                    return false;
                }
                if (endMs && timestamp > endMs) {
                    return false;
                }
                return true;
            });
        }

        async function editLoanDate(loanId, currentDate) {
            const id = Number(loanId);
            if (!Number.isFinite(id) || id <= 0) return;
            const defaultValue = currentDate ? toLocalInputValue(currentDate) : "";
            const input = showPrompt("prompt.new_loan_date", defaultValue);
            if (input === null) return;
            const isoValue = normalizePromptDateTime(input);
            if (!isoValue) {
                showAlert("error.datetime_invalid");
                return;
            }
            if (isFutureDateTime(isoValue)) {
                showAlert("error.datetime_future");
                return;
            }
            try {
                const response = await fetch(`/api/loans/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ loan_date: isoValue })
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(data.detail || response.statusText);
                }
                showAlert("alert.loan_date_update_success");
                window.location.reload();
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        async function editRepaymentAmount(repaymentId, currentAmount) {
            const id = Number(repaymentId);
            const initial = Number(currentAmount) || 0;
            if (!Number.isFinite(id) || id <= 0) return;
            const defaultValue = Number.isFinite(initial) ? initial.toFixed(2) : "";
            const input = showPrompt("prompt.new_repayment_amount", defaultValue);
            if (input === null) return;
            const value = Number(input);
            if (!Number.isFinite(value) || value < 0) {
                showAlert("error.amount_non_negative");
                return;
            }
            try {
                const response = await fetch(`/api/repayments/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ repayment_amount: value })
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(data.detail || response.statusText);
                }
                showAlert("alert.repayment_update_success");
                window.location.reload();
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        async function editRepaymentDate(repaymentId, currentDate) {
            const id = Number(repaymentId);
            if (!Number.isFinite(id) || id <= 0) return;
            const defaultValue = currentDate ? toLocalInputValue(currentDate) : "";
            const input = showPrompt("prompt.new_repayment_date", defaultValue);
            if (input === null) return;
            const isoValue = normalizePromptDateTime(input);
            if (!isoValue) {
                showAlert("error.datetime_invalid");
                return;
            }
            if (isFutureDateTime(isoValue)) {
                showAlert("error.datetime_future");
                return;
            }
            try {
                const response = await fetch(`/api/repayments/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ repayment_date: isoValue })
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(data.detail || response.statusText);
                }
                showAlert("alert.repayment_date_update_success");
                window.location.reload();
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        async function uploadCustomerPhoto(customerId, file) {
            if (!file) return true;
            const formData = new FormData();
            formData.append("file", file);
            const response = await fetch(`/api/customers/${customerId}/photo`, {
                method: "POST",
                body: formData,
            });
            if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                const message = payload?.detail || response.statusText;
                throw new Error(`上传照片失败: ${message}`);
            }
            return true;
        }

        async function handleCustomerSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const photoInput = form.querySelector("input[name='photo']");
            const photoFile = photoInput?.files?.[0];
            let payload;
            try {
                payload = buildPayload(form);
            } catch (error) {
                alert(error.message);
                return;
            }
            const response = await fetch("/api/customers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const data = await response.json().catch(() => ({ detail: "请求失败" }));
                showAlert("alert.submit_failed", { detail: data.detail || response.statusText });
                return;
            }
            const customer = await response.json();
            if (photoFile) {
                try {
                    await uploadCustomerPhoto(customer.id, photoFile);
                } catch (error) {
                    alert(error.message);
                }
            }
            window.location.reload();
        }

        function initPhotoPreview() {
            const input = document.getElementById("customer-photo-input");
            const preview = document.getElementById("customer-photo-preview");
            if (!input || !preview) return;
            input.addEventListener("change", () => {
                const file = input.files?.[0];
                if (!file) {
                    preview.src = "";
                    preview.style.display = "none";
                    return;
                }
                const url = URL.createObjectURL(file);
                preview.src = url;
                preview.style.display = "block";
            });
        }

        const numberFormatterCache = {};

        function getActiveLocale() {
            return LANGUAGE_TO_LOCALE[currentLanguage] || "en";
        }

        function formatNumberDisplay(value, { minimumFractionDigits = 2, maximumFractionDigits = 2 } = {}) {
            const normalized = Number(value);
            const safeNumber = Number.isFinite(normalized) ? normalized : 0;
            const locale = getActiveLocale();
            const cacheKey = `${locale}-${minimumFractionDigits}-${maximumFractionDigits}`;
            if (!numberFormatterCache[cacheKey]) {
                numberFormatterCache[cacheKey] = new Intl.NumberFormat(locale, {
                    minimumFractionDigits,
                    maximumFractionDigits,
                });
            }
            return numberFormatterCache[cacheKey].format(safeNumber);
        }

        function formatAmount(value) {
            return formatNumberDisplay(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCount(value) {
            return formatNumberDisplay(value, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function parseJsonScript(id) {
            const script = document.getElementById(id);
            if (!script) return [];
            try {
                return JSON.parse(script.textContent || "[]");
            } catch (error) {
                console.error(`解析 ${id} 数据失败`, error);
                return [];
            }
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return "";
            return value
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function resolveLogActionClass(action) {
            const normalized = (action || "").toLowerCase();
            if (["create", "update", "delete"].includes(normalized)) {
                return normalized;
            }
            return "default";
        }

        function normalizeMetadataValue(value) {
            if (value === null || value === undefined) {
                return "";
            }
            if (typeof value === "object") {
                try {
                    return JSON.stringify(value);
                } catch (error) {
                    return String(value);
                }
            }
            return value;
        }

        function formatMetadataLines(metadata) {
            if (!metadata || typeof metadata !== "object") {
                return "-";
            }
            const entries = Object.entries(metadata).filter(([key]) => !key.startsWith("_i18n"));
            if (!entries.length) return "-";
            return entries
                .map(([key, value]) => `${escapeHtml(key)}: ${escapeHtml(normalizeMetadataValue(value))}`)
                .join("<br>");
        }

        function formatLogDescription(log) {
            if (!log) {
                return "-";
            }
            const metadata = log.metadata && typeof log.metadata === "object" ? log.metadata : {};
            const key = metadata._i18n_key;
            if (key) {
                const params = metadata._i18n_params || {};
                return escapeHtml(translate(key, params));
            }
            const list = Array.isArray(metadata._i18n_list) ? metadata._i18n_list : [];
            if (list.length) {
                const lines = list
                    .map((item) => {
                        if (!item || !item.key) return "";
                        const params = item.params || {};
                        return escapeHtml(translate(item.key, params));
                    })
                    .filter(Boolean);
                if (lines.length) {
                    return lines.join("<br>");
                }
            }
            if (log.description) {
                return escapeHtml(log.description);
            }
            return "-";
        }

        function resolveCustomerFromDom(customerId) {
            const row = document.querySelector(`[data-customer-row="${customerId}"]`);
            if (!row) return null;
            return {
                id: customerId,
                customer_code: row.querySelector(".customer-code")?.textContent?.trim() || "",
                name: row.querySelector('[data-field="name"]')?.textContent?.trim() || "",
                phone: row.querySelector('[data-field="phone"]')?.textContent?.trim() || "",
                id_card: row.querySelector('[data-field="id_card"]')?.textContent?.trim() || "",
                address: row.querySelector('[data-field="address"]')?.textContent?.trim() || "",
                note: row.querySelector('[data-field="note"]')?.textContent?.trim() || "",
                photo_url: row.querySelector(".customer-photo-cell img")?.src || "",
                projected_balance: 0,
                next_compound_at: null,
            };
        }

        function getCustomerInfo(customerId) {
            const id = Number(customerId);
            if (customerStore.has(id)) {
                return customerStore.get(id);
            }
            const fallback = resolveCustomerFromDom(id);
            if (fallback) {
                customerStore.set(id, fallback);
            }
            return fallback;
        }

        function initCustomerFeatures() {
            const customersRaw = parseJsonScript("customers-data");
            customersDataset = sanitizeCustomersDataset(customersRaw);
            customerStore = new Map(customersDataset.map((item) => [item.id, item]));
            refreshCustomersFromApi();

            const loansData = parseJsonScript("loans-data");
            loansStore = Array.isArray(loansData) ? loansData : [];
            const repaymentsData = parseJsonScript("repayments-data");
            repaymentsStore = Array.isArray(repaymentsData) ? repaymentsData : [];
            const summaryData = parseJsonScript("summary-data");
            summaryDataset = Array.isArray(summaryData) ? summaryData : [];
            summaryStore = new Map(summaryDataset.map((item) => [item.customer_code, item]));

            customerListPaginator = createPaginator({
                controls: document.getElementById("customers-pagination"),
                onPage: renderCustomerListRows,
            });
            refreshCustomerListView();

            customerLoansPaginator = createPaginator({
                controls: document.getElementById("customer-loans-pagination"),
                onPage: renderCustomerLoanRows,
            });
            customerRepaymentsPaginator = createPaginator({
                controls: document.getElementById("customer-repayments-pagination"),
                onPage: renderCustomerRepaymentRows,
            });
            customerLoansPaginator.setItems([]);
            customerRepaymentsPaginator.setItems([]);
            applyCustomerTransactionsFilter();

            summaryPaginator = createPaginator({
                controls: document.getElementById("summary-pagination"),
                onPage: renderSummaryRows,
            });
            refreshSummaryView();

            const customersBody = document.getElementById("customers-table-body");
            customersBody?.addEventListener("click", (event) => {
                const button = event.target.closest(".customer-action");
                if (!button) return;
                const customerId = Number(button.dataset.customerId);
                if (!Number.isFinite(customerId)) return;
                const action = button.dataset.action;
                if (action === "transactions") {
                    showCustomerTransactions(customerId);
                    return;
                }
                if (action === "balance") {
                    openBalanceModal(customerId);
                    return;
                }
                if (action === "photo") {
                    openPhotoModal(customerId);
                    return;
                }
                openCustomerModal(customerId, action || "profile");
            });
            updateTimelineButtonsState();
            const photoInput = document.querySelector("#customer-photo-form input[name='photo']");
            photoInput?.addEventListener("change", (event) => {
                const file = event.target.files?.[0];
                const preview = document.getElementById("photo-modal-preview");
                if (!preview) return;
                if (!file) {
                    preview.style.display = "none";
                    preview.src = "";
                    return;
                }
                preview.src = URL.createObjectURL(file);
                preview.style.display = "block";
            });

            const transactionsFilterSelect = document.getElementById("customer-transactions-view-filter");
            if (transactionsFilterSelect) {
                customerTransactionsViewFilter = transactionsFilterSelect.value || "all";
                transactionsFilterSelect.addEventListener("change", () => {
                    customerTransactionsViewFilter = transactionsFilterSelect.value || "all";
                    applyCustomerTransactionsFilter();
                });
            }
            initCustomerTransactionDateFilter();
            initTimelineDateFilter();

            const timelineButtons = [
                { id: "view-balance-timeline", view: "balance" },
                { id: "view-repayment-timeline", view: "repayments" },
                { id: "view-all-timeline", view: "all" },
            ];
            timelineButtons.forEach(({ id, view }) => {
                const button = document.getElementById(id);
                button?.addEventListener("click", () => openCustomerTimeline(view));
            });
            document.getElementById("customer-timeline-close")?.addEventListener("click", closeCustomerTimeline);
            document.getElementById("close-customer-transactions")?.addEventListener("click", hideCustomerTransactions);

            initCustomerSearch();
            initSummarySearch();
        }

        function initCustomerSearch() {
            const input = document.getElementById("customer-search-input");
            const clearButton = document.getElementById("customer-search-clear");
            if (!input) {
                return;
            }
            const handleInput = () => {
                customerSearchQuery = input.value || "";
                refreshCustomerListView();
            };
            input.addEventListener("input", handleInput);
            clearButton?.addEventListener("click", () => {
                if (!input.value) {
                    return;
                }
                input.value = "";
                customerSearchQuery = "";
                refreshCustomerListView();
                input.focus();
            });
        }

        function initSummarySearch() {
            const input = document.getElementById("summary-search-input");
            const clearButton = document.getElementById("summary-search-clear");
            if (!input) {
                return;
            }
            const handleInput = () => {
                summarySearchQuery = input.value || "";
                refreshSummaryView({ preservePage: true });
            };
            input.addEventListener("input", handleInput);
            clearButton?.addEventListener("click", () => {
                if (!input.value) {
                    return;
                }
                input.value = "";
                summarySearchQuery = "";
                refreshSummaryView();
                input.focus();
            });
        }

        function openCustomerModal(customerId, mode = "profile") {
            const modal = document.getElementById("customer-modal");
            if (!modal) return;
            const customer = getCustomerInfo(customerId);
            if (!customer) {
                showAlert("alert.customer_not_found");
                return;
            }
            customerModalId = customer.id;
            customerModalMode = CUSTOMER_MODAL_FIELDS[mode] ? mode : "profile";
            const modeLabel = customerModalMode === "profile" ? "顾客资料" : customerModalMode === "phone" ? "电话号码" : "地址";
            const titleKey = CUSTOMER_MODAL_TITLES[customerModalMode] || "modal.customer.profile";
            const title = document.getElementById("customer-modal-title");
            if (title) {
                const translatedLabel = translate(titleKey);
                title.textContent = `${translatedLabel} - ${customer.name || customer.customer_code}`;
            }
            const allowedFields = CUSTOMER_MODAL_FIELDS[customerModalMode] || [];
            modal.querySelectorAll("[data-field-group]").forEach((group) => {
                const field = group.getAttribute("data-field-group");
                const shouldShow = allowedFields.includes(field);
                group.classList.toggle("hidden", !shouldShow);
                const input = group.querySelector("input, textarea");
                if (input) {
                    input.value = customer[field] || "";
                    input.disabled = !shouldShow;
                }
            });
            modal.classList.add("active");
        }

        function closeCustomerModal() {
            const modal = document.getElementById("customer-modal");
            if (!modal) return;
            modal.classList.remove("active");
            customerModalId = null;
        }

        async function handleCustomerModalSubmit(event) {
            event.preventDefault();
            if (!customerModalId) {
                closeCustomerModal();
                return;
            }
            const allowedFields = CUSTOMER_MODAL_FIELDS[customerModalMode] || [];
            const form = event.target;
            const payload = {};
            let hasValue = false;
            allowedFields.forEach((field) => {
                const item = form.elements.namedItem(field);
                if (!item) return;
                const value = item.value ?? "";
                payload[field] = value;
                hasValue = true;
            });
            if (!hasValue) {
                showAlert("alert.no_changes");
                return;
            }
            try {
                const response = await fetch(`/api/customers/${customerModalId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.detail || response.statusText);
                }
                const updatedCustomer = await response.json();
                customerStore.set(updatedCustomer.id, updatedCustomer);
                updateCustomerRow(updatedCustomer);
                closeCustomerModal();
                showAlert("alert.customer_update_success");
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        function upsertCustomerDataset(customer) {
            if (!customer) return;
            const id = Number(customer.id);
            if (!Number.isFinite(id)) {
                return;
            }
            const index = customersDataset.findIndex((item) => Number(item.id) === id);
            if (index >= 0) {
                customersDataset[index] = { ...customersDataset[index], ...customer };
            } else {
                customersDataset.push(customer);
            }
            refreshCustomerListView({ preservePage: true });
        }

        function updateCustomerRow(customer) {
            upsertCustomerDataset(customer);
        }

        function openPhotoModal(customerId) {
            const modal = document.getElementById("photo-modal");
            if (!modal) return;
            const customer = getCustomerInfo(customerId);
            if (!customer) {
                showAlert("alert.customer_not_found");
                return;
            }
            photoModalCustomerId = customer.id;
            const title = document.getElementById("photo-modal-title");
            if (title) {
                const baseTitle = translate("modal.photo.title");
                title.textContent = `${baseTitle} - ${customer.name || customer.customer_code}`;
            }
            const form = document.getElementById("customer-photo-form");
            form?.reset();
            const preview = document.getElementById("photo-modal-preview");
            if (preview) {
                if (customer.photo_url) {
                    preview.src = customer.photo_url;
                    preview.style.display = "block";
                } else {
                    preview.src = "";
                    preview.style.display = "none";
                }
            }
            modal.classList.add("active");
        }

        function closePhotoModal() {
            const modal = document.getElementById("photo-modal");
            if (!modal) return;
            modal.classList.remove("active");
            photoModalCustomerId = null;
        }

        async function handleCustomerPhotoSubmit(event) {
            event.preventDefault();
            if (!photoModalCustomerId) {
                closePhotoModal();
                return;
            }
            const form = event.target;
            const fileInput = form.elements.namedItem("photo");
            if (!fileInput?.files?.length) {
                showAlert("alert.photo_required");
                return;
            }
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            try {
                const response = await fetch(`/api/customers/${photoModalCustomerId}/photo`, {
                    method: "POST",
                    body: formData,
                });
                if (!response.ok) {
                    const payload = await response.json().catch(() => ({}));
                    throw new Error(payload.detail || response.statusText);
                }
                const updatedCustomer = await response.json();
                customerStore.set(updatedCustomer.id, updatedCustomer);
                updateCustomerRow(updatedCustomer);
                closePhotoModal();
                showAlert("alert.photo_update_success");
            } catch (error) {
                showAlert("alert.upload_failed", { message: error.message });
            }
        }

        function updateBalanceModalCurrent(loanCode, fallbackBalance = 0) {
            const currentEl = document.getElementById("balance-modal-current");
            if (!currentEl) {
                return;
            }
            let amount = fallbackBalance || 0;
            if (loanCode && balanceModalLoanMap.has(loanCode)) {
                const loan = balanceModalLoanMap.get(loanCode);
                amount = Number(loan?.remaining_balance ?? 0) || 0;
            }
            currentEl.textContent = formatAmount(amount);
        }

        function openBalanceModal(customerId) {
            const modal = document.getElementById("balance-modal");
            if (!modal) return;
            const customer = getCustomerInfo(customerId);
            if (!customer) {
                showAlert("alert.customer_not_found");
                return;
            }
            const customerLoans = (loansStore || [])
                .filter((loan) => loan.customer_code === customer.customer_code)
                .sort((a, b) => new Date(b.loan_date || 0) - new Date(a.loan_date || 0));
            if (!customerLoans.length) {
                showAlert("alert.balance_no_loans");
                return;
            }
            balanceModalLoanMap = new Map();
            customerLoans.forEach((loan) => {
                if (loan.loan_code) {
                    balanceModalLoanMap.set(loan.loan_code, loan);
                }
            });
            balanceModalFallbackBalance = Number(customer.projected_balance) || 0;
            balanceModalCustomerId = customer.id;
            updateBalanceModalCurrent(null, balanceModalFallbackBalance);
            const form = document.getElementById("customer-balance-form");
            if (!form) {
                return;
            }
            form?.reset();
            const loanField = form.elements.namedItem("loan_code");
            if (loanField && loanField.tagName === "SELECT") {
                loanField.innerHTML = "";
                const shouldShowPlaceholder = customerLoans.length > 1;
                if (shouldShowPlaceholder) {
                    const placeholderOption = document.createElement("option");
                    placeholderOption.value = "";
                    placeholderOption.textContent = translate("modal.balance.loan_code_placeholder");
                    placeholderOption.disabled = true;
                    placeholderOption.selected = true;
                    loanField.appendChild(placeholderOption);
                }
                customerLoans.forEach((loan) => {
                    const option = document.createElement("option");
                    option.value = loan.loan_code;
                    const remainingLabel = formatAmount(Number(loan.remaining_balance) || 0);
                    const loanDate = isoDate(loan.loan_date || "");
                    const parts = [loan.loan_code];
                    if (remainingLabel) {
                        parts.push(`${translate("modal.balance.remaining_prefix")}${remainingLabel}`);
                    }
                    if (loanDate) {
                        parts.push(loanDate);
                    }
                    option.textContent = parts.join(" · ");
                    loanField.appendChild(option);
                });
                if (!shouldShowPlaceholder && customerLoans.length === 1) {
                    loanField.value = customerLoans[0].loan_code;
                    updateBalanceModalCurrent(customerLoans[0].loan_code, balanceModalFallbackBalance);
                } else {
                    updateBalanceModalCurrent(null, balanceModalFallbackBalance);
                }
                loanField.onchange = (event) => {
                    const selectedCode = event.target.value || null;
                    updateBalanceModalCurrent(selectedCode, balanceModalFallbackBalance);
                };
            }
            const adjustField = form?.elements?.namedItem("adjust_amount");
            if (adjustField) {
                adjustField.value = "0";
            }
            const projectedField = form?.elements?.namedItem("projected_balance");
            if (projectedField) {
                projectedField.value = "";
            }
            const nextField = form?.elements?.namedItem("next_compound_at");
            if (nextField) {
                nextField.value = toLocalInputValue(customer.next_compound_at);
            }
            const title = modal.querySelector("h3");
            if (title) {
                const baseTitle = translate("modal.balance.title");
                title.textContent = `${baseTitle} - ${customer.name || customer.customer_code}`;
            }
            modal.classList.add("active");
        }

        function closeBalanceModal() {
            const modal = document.getElementById("balance-modal");
            if (!modal) return;
            modal.classList.remove("active");
            balanceModalCustomerId = null;
        }

        async function handleBalanceSubmit(event) {
            event.preventDefault();
            if (!balanceModalCustomerId) {
                closeBalanceModal();
                return;
            }
            const form = event.target;
            const loanField = form.elements.namedItem("loan_code");
            const adjustField = form.elements.namedItem("adjust_amount");
            const projectedField = form.elements.namedItem("projected_balance");
            const nextField = form.elements.namedItem("next_compound_at");
            const payload = {};
            if (!loanField) {
                showAlert("error.balance_loan_required");
                return;
            }
            const loanCode = (loanField.value ?? "").trim();
            if (!loanCode) {
                showAlert("error.balance_loan_required");
                if (typeof loanField.focus === "function") {
                    loanField.focus();
                }
                return;
            }
            if (!balanceModalLoanMap.has(loanCode)) {
                showAlert("error.balance_loan_required");
                return;
            }
            const selectedLoan = balanceModalLoanMap.get(loanCode);
            const remainingAmount = Number(selectedLoan?.remaining_balance ?? 0);
            if (!(remainingAmount > 0)) {
                showAlert("error.balance_loan_no_remaining");
                return;
            }
            payload.loan_code = loanCode;
            const projectedRaw = projectedField?.value?.trim();
            const adjustRaw = adjustField?.value?.trim();

            if (projectedRaw) {
                const projectedValue = Number(projectedRaw);
                if (Number.isNaN(projectedValue)) {
                    showAlert("error.balance_new_numeric");
                    return;
                }
                if (projectedValue < 0) {
                    showAlert("error.balance_new_non_negative");
                    return;
                }
                payload.projected_balance = projectedValue;
            } else if (adjustRaw) {
                const adjustValue = Number(adjustRaw);
                if (Number.isNaN(adjustValue)) {
                    showAlert("error.adjust_amount_numeric");
                    return;
                }
                payload.adjust_amount = adjustValue;
            } else {
                showAlert("alert.balance_value_required");
                return;
            }

            if (nextField?.value?.trim()) {
                const isoValue = toIsoDateTime(nextField.value);
                if (!isoValue) {
                    showAlert("error.next_compound_invalid");
                    return;
                }
                payload.next_compound_at = isoValue;
            }

            try {
                const response = await fetch(`/api/customers/${balanceModalCustomerId}/balance`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.detail || response.statusText);
                }
                const updatedCustomer = await response.json();
                customerStore.set(updatedCustomer.id, updatedCustomer);
                closeBalanceModal();
                showAlert("alert.balance_update_success");
                window.location.reload();
            } catch (error) {
                showAlert("alert.update_failed", { message: error.message });
            }
        }

        function showCustomerTransactions(customerId) {
            const panel = document.getElementById("customer-transactions-panel");
            if (!panel) return;
            const customer = getCustomerInfo(customerId);
            if (!customer) {
                showAlert("alert.customer_not_found");
                return;
            }
            const title = document.getElementById("customer-transactions-title");
            if (title) {
                title.textContent = translate("customer.transactions.title", {
                    name: customer.name || "-",
                    code: customer.customer_code || "-",
                });
            }
            activeCustomerId = customer.id;
            activeCustomerInfo = customer;
            customerTimelineCache.delete(customer.id);
            closeCustomerTimeline();
            timelineDateRange.start = "";
            timelineDateRange.end = "";
            const timelineStartInput = document.getElementById("timeline-start-date");
            const timelineEndInput = document.getElementById("timeline-end-date");
            if (timelineStartInput) timelineStartInput.value = "";
            if (timelineEndInput) timelineEndInput.value = "";
            updateTimelineButtonsState();
            renderCustomerTransactions(customer.customer_code || "");
            renderCustomerTotals(customer.customer_code || "");
            panel.classList.add("active");
            panel.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        function hideCustomerTransactions() {
            document.getElementById("customer-transactions-panel")?.classList.remove("active");
            document.getElementById("customer-totals-panel")?.classList.add("hidden");
            customerLoansPaginator?.setItems([]);
            customerRepaymentsPaginator?.setItems([]);
            closeCustomerTimeline();
            activeCustomerId = null;
            activeCustomerInfo = null;
            updateTimelineButtonsState();
        }

        function renderCustomerTransactions(customerCode) {
            if (!customerCode) {
                currentCustomerLoanRows = [];
                currentCustomerRepaymentRows = [];
                refreshCustomerTransactionsTables();
                return;
            }
            const loans = (loansStore || [])
                .filter((loan) => loan.customer_code === customerCode)
                .sort((a, b) => new Date(a.loan_date || 0) - new Date(b.loan_date || 0));
            const repayments = (repaymentsStore || [])
                .filter((item) => item.customer_code === customerCode)
                .sort((a, b) => new Date(a.repayment_date || 0) - new Date(b.repayment_date || 0));
            currentCustomerLoanRows = loans;
            currentCustomerRepaymentRows = repayments;
            refreshCustomerTransactionsTables();
        }

        function renderCustomerTotals(customerCode) {
            const panel = document.getElementById("customer-totals-panel");
            if (!panel) return;
            if (!customerCode) {
                panel.classList.add("hidden");
                return;
            }
            const summary = summaryStore.get(customerCode);
            const loans = (loansStore || []).filter((loan) => loan.customer_code === customerCode);
            const repayments = (repaymentsStore || []).filter((item) => item.customer_code === customerCode);
            const totalLoan = summary?.total_loan ?? loans.reduce((sum, loan) => sum + (Number(loan.loan_amount) || 0), 0);
            const totalRepayment = summary?.total_repayment ?? repayments.reduce((sum, item) => sum + (Number(item.repayment_amount) || 0), 0);
            const totalFee = summary?.total_fee ?? loans.reduce((sum, loan) => sum + (Number(loan.processing_fee) || 0), 0);
            const projectedBalance = summary?.projected_balance ?? Math.max(totalLoan - totalRepayment, 0);
            const totalInterest = Math.max(projectedBalance + totalRepayment - totalLoan, 0);
            const interestProfit = totalInterest;
            const feeIncome = totalFee;
            const totalProfit = totalRepayment - totalLoan;

            const loanEl = document.getElementById("customer-total-loan");
            const repayEl = document.getElementById("customer-total-repayment");
            const interestProfitEl = document.getElementById("customer-interest-profit");
            const feeEl = document.getElementById("customer-fee-income");
            const profitEl = document.getElementById("customer-total-profit");
            if (loanEl) loanEl.textContent = formatAmount(totalLoan);
            if (repayEl) repayEl.textContent = formatAmount(totalRepayment);
            if (interestProfitEl) interestProfitEl.textContent = formatAmount(interestProfit);
            if (feeEl) feeEl.textContent = formatAmount(feeIncome);
            if (profitEl) profitEl.textContent = formatAmount(totalProfit);
            panel.classList.remove("hidden");
        }

        function updateTimelineButtonsState() {
            const hasCustomer = Number.isInteger(activeCustomerId) && activeCustomerId > 0;
            const repaymentBtn = document.getElementById("view-repayment-timeline");
            const balanceBtn = document.getElementById("view-balance-timeline");
            const allBtn = document.getElementById("view-all-timeline");
            [repaymentBtn, balanceBtn, allBtn].forEach((button) => {
                if (!button) return;
                button.disabled = !hasCustomer;
            });
        }

        function applyCustomerTransactionsFilter() {
            const normalized = (customerTransactionsViewFilter || "all").toLowerCase();
            const showLoans = normalized === "all" || normalized === "loans";
            const showRepayments = normalized === "all" || normalized === "repayments";
            document.getElementById("customer-loans-section")?.classList.toggle("hidden", !showLoans);
            document.getElementById("customer-loans-pagination")?.classList.toggle("hidden", !showLoans);
            document.getElementById("customer-repayments-section")?.classList.toggle("hidden", !showRepayments);
            document.getElementById("customer-repayments-pagination")?.classList.toggle("hidden", !showRepayments);
        }

        function refreshCustomerTransactionsTables({ preservePage = false } = {}) {
            const options = preservePage ? { preservePage: true } : undefined;
            const filteredLoans = filterItemsByDateRange(currentCustomerLoanRows, "loan_date", customerTransactionsDateRange);
            const filteredRepayments = filterItemsByDateRange(currentCustomerRepaymentRows, "repayment_date", customerTransactionsDateRange);
            customerLoansPaginator?.setItems(filteredLoans, options);
            customerRepaymentsPaginator?.setItems(filteredRepayments, options);
            applyCustomerTransactionsFilter();
        }

        function initCustomerTransactionDateFilter() {
            const startInput = document.getElementById("customer-transactions-start-date");
            const endInput = document.getElementById("customer-transactions-end-date");
            const resetButton = document.getElementById("customer-transactions-date-reset");
            if (!startInput || !endInput) {
                return;
            }

            const applyRange = (source) => {
                const startValue = isoDate(startInput.value);
                const endValue = isoDate(endInput.value);
                if (startValue && endValue && endValue < startValue) {
                    showAlert("alert.date_range_invalid");
                    if (source === "start") {
                        startInput.value = customerTransactionsDateRange.start || "";
                    } else if (source === "end") {
                        endInput.value = customerTransactionsDateRange.end || "";
                    }
                    return;
                }
                customerTransactionsDateRange.start = startValue;
                customerTransactionsDateRange.end = endValue;
                refreshCustomerTransactionsTables({ preservePage: true });
            };

            const quickRangeControls = setupQuickRangeControls(document.getElementById("customer-transactions-quick-range"), {
                startInput,
                endInput,
                onApplyRange: () => applyRange(),
            });

            startInput.addEventListener("change", () => {
                quickRangeControls?.clearActive();
                applyRange("start");
            });
            endInput.addEventListener("change", () => {
                quickRangeControls?.clearActive();
                applyRange("end");
            });
            resetButton?.addEventListener("click", () => {
                if (!customerTransactionsDateRange.start && !customerTransactionsDateRange.end) {
                    return;
                }
                customerTransactionsDateRange = { start: "", end: "" };
                startInput.value = "";
                endInput.value = "";
                quickRangeControls?.clearActive();
                refreshCustomerTransactionsTables();
            });
        }

        function refreshActiveTimelineView() {
            if (!currentTimelineCustomerId) return;
            const cached = customerTimelineCache.get(currentTimelineCustomerId);
            if (!cached) return;
            renderCustomerTimeline(cached, currentTimelineView || "balance");
        }

        function initTimelineDateFilter() {
            const startInput = document.getElementById("timeline-start-date");
            const endInput = document.getElementById("timeline-end-date");
            const resetButton = document.getElementById("timeline-date-reset");
            if (!startInput || !endInput) {
                return;
            }

            const applyRange = (source) => {
                const startValue = isoDate(startInput.value);
                const endValue = isoDate(endInput.value);
                if (startValue && endValue && endValue < startValue) {
                    showAlert("alert.date_range_invalid");
                    if (source === "start") {
                        startInput.value = timelineDateRange.start || "";
                    } else if (source === "end") {
                        endInput.value = timelineDateRange.end || "";
                    }
                    return;
                }
                timelineDateRange.start = startValue;
                timelineDateRange.end = endValue;
                refreshActiveTimelineView();
            };

            const quickRangeControls = setupQuickRangeControls(document.getElementById("timeline-quick-range"), {
                startInput,
                endInput,
                onApplyRange: () => applyRange(),
            });

            startInput.addEventListener("change", () => {
                quickRangeControls?.clearActive();
                applyRange("start");
            });
            endInput.addEventListener("change", () => {
                quickRangeControls?.clearActive();
                applyRange("end");
            });
            resetButton?.addEventListener("click", () => {
                if (!timelineDateRange.start && !timelineDateRange.end) {
                    return;
                }
                timelineDateRange.start = "";
                timelineDateRange.end = "";
                startInput.value = "";
                endInput.value = "";
                quickRangeControls?.clearActive();
                refreshActiveTimelineView();
            });
        }

        function formatTimelineRate(value) {
            const raw = typeof value === "string" ? value.replace(/%$/, "") : value;
            const num = Number(raw);
            if (!Number.isFinite(num)) {
                return value ?? "0";
            }
            const fixed = num.toFixed(2);
            if (fixed.endsWith(".00")) {
                return num.toFixed(0);
            }
            return fixed.replace(/0+$/, "").replace(/\.$/, "");
        }

        function formatTimelineAction(event) {
            const map = {
                loan_disbursement: "timeline.event.loan_disbursement",
                loan_adjustment: "timeline.event.loan_adjustment",
                loan_writeoff: "timeline.event.loan_writeoff",
                repayment: "timeline.event.repayment",
                repayment_adjustment: "timeline.event.repayment_adjustment",
                repayment_reversal: "timeline.event.repayment_reversal",
                compound_growth: "timeline.event.compound_growth",
                manual_adjust: "timeline.event.manual_adjust",
                manual_override: "timeline.event.manual_override",
                baseline: "timeline.event.baseline",
            };
            const key = map[event?.event_type];
            if (key) {
                return translate(key);
            }
            if (event?.description) {
                return event.description;
            }
            return event?.event_type || "-";
        }

        function formatTimelineNote(event) {
            if (!event) {
                return "-";
            }
            const metadata = event.metadata || {};
            const formatChange = (value) => formatAmount(Math.abs(Number(value) || 0));
            switch (event.event_type) {
                case "compound_growth": {
                    const base = formatAmount(metadata.base_amount ?? 0);
                    const rate = formatTimelineRate(metadata.interest_rate ?? 0);
                    const result = formatAmount(metadata.result_amount ?? event.balance_after);
                    return translate("timeline.note.compound", { base, rate, result });
                }
                case "loan_disbursement": {
                    const loan = formatAmount(metadata.loan_amount ?? event.change_amount);
                    const compounded = formatAmount(metadata.compounded_amount ?? event.balance_after);
                    return translate("timeline.note.loan_disbursement", { loan, compounded });
                }
                case "loan_adjustment": {
                    const old = formatAmount(metadata.previous_effective_amount ?? 0);
                    const newValue = formatAmount(metadata.new_effective_amount ?? 0);
                    return translate("timeline.note.loan_adjustment", { old, new: newValue });
                }
                case "loan_writeoff": {
                    const amount = formatAmount(metadata.loan_amount ?? Math.abs(event.change_amount || 0));
                    return translate("timeline.note.loan_writeoff", { amount });
                }
                case "repayment": {
                    const amount = formatChange(metadata.repayment_amount ?? event.change_amount);
                    if (metadata.previous_balance !== undefined && metadata.previous_balance !== null) {
                        const previous = formatAmount(metadata.previous_balance);
                        return translate("timeline.note.repayment_with_balance", { amount, previous });
                    }
                    return translate("timeline.note.repayment", { amount });
                }
                case "repayment_adjustment": {
                    const old = formatChange(metadata.previous_amount ?? 0);
                    const newValue = formatChange(metadata.new_amount ?? 0);
                    return translate("timeline.note.repayment_adjustment", { old, new: newValue });
                }
                case "repayment_reversal": {
                    const amount = formatChange(metadata.repayment_amount ?? event.change_amount);
                    return translate("timeline.note.repayment_reversal", { amount });
                }
                case "manual_adjust": {
                    const previous = formatAmount(metadata.previous_balance ?? 0);
                    return translate("timeline.note.manual_adjust", { previous });
                }
                case "manual_override": {
                    const target = formatAmount(metadata.target_balance ?? event.balance_after);
                    return translate("timeline.note.manual_override", { target });
                }
                case "baseline": {
                    const amount = formatAmount(event.balance_after ?? event.change_amount ?? 0);
                    return translate("timeline.note.baseline", { amount });
                }
                default: {
                    if (event.description) {
                        return event.description;
                    }
                    if (Object.keys(metadata).length) {
                        return Object.entries(metadata)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(", ");
                    }
                    return "-";
                }
            }
        }

        function setCustomerTimelineStatus(message, isError = false) {
            const statusEl = document.getElementById("customer-timeline-status");
            if (!statusEl) return;
            statusEl.textContent = message || "";
            statusEl.className = isError ? "records-status error" : "records-status";
        }

        function refreshOverallReportStatus() {
            const statusEl = document.getElementById("overall-report-status");
            if (!statusEl) return;
            const { key, replacements, isError } = overallReportStatusState || {};
            if (key) {
                statusEl.textContent = translate(key, replacements || {});
            } else {
                statusEl.textContent = "";
            }
            statusEl.className = isError ? "records-status error" : "records-status";
        }

        function setOverallReportStatus(key, replacements = {}, isError = false) {
            overallReportStatusState = { key, replacements, isError };
            refreshOverallReportStatus();
        }

        function renderOverallReportValues(data) {
            const totalLoanEl = document.getElementById("overall-report-total-loan");
            const totalRepaymentEl = document.getElementById("overall-report-total-repayment");
            const feeIncomeEl = document.getElementById("overall-report-fee-income");
            const interestProfitEl = document.getElementById("overall-report-interest-profit");
            const netProfitEl = document.getElementById("overall-report-net-profit");
            const loanCountEl = document.getElementById("overall-report-loan-count");
            const repaymentCountEl = document.getElementById("overall-report-repayment-count");
            const totalCustomersEl = document.getElementById("overall-report-total-customers");
            const newCustomersEl = document.getElementById("overall-report-new-customers");
            if (!totalLoanEl || !totalRepaymentEl) {
                return;
            }
            const payload = data || {};
            totalLoanEl.textContent = formatAmount(payload.total_loan_amount ?? 0);
            totalRepaymentEl.textContent = formatAmount(payload.total_repayment_amount ?? 0);
            if (feeIncomeEl) {
                feeIncomeEl.textContent = formatAmount(payload.fee_income ?? 0);
            }
            if (interestProfitEl) {
                interestProfitEl.textContent = formatAmount(payload.interest_profit ?? 0);
            }
            if (netProfitEl) {
                netProfitEl.textContent = formatAmount(payload.net_profit ?? 0);
            }
            if (loanCountEl) {
                loanCountEl.textContent = formatCount(payload.loan_count ?? 0);
            }
            if (repaymentCountEl) {
                repaymentCountEl.textContent = formatCount(payload.repayment_count ?? 0);
            }
            if (totalCustomersEl) {
                totalCustomersEl.textContent = formatCount(payload.total_customer_count ?? 0);
            }
            if (newCustomersEl) {
                newCustomersEl.textContent = formatCount(payload.new_customer_count ?? 0);
            }
        }

        function renderCustomerTimeline(timeline, viewMode = "balance") {
            const panel = document.getElementById("customer-timeline-panel");
            const body = document.getElementById("customer-timeline-body");
            const title = document.getElementById("customer-timeline-title");
            const heading = document.getElementById("customer-timeline-heading");
            const summary = document.getElementById("customer-timeline-summary");
            if (!body) return;
            const normalizedView = typeof viewMode === "string" ? viewMode.toLowerCase() : "";
            const view = ["balance", "repayments", "all"].includes(normalizedView) ? normalizedView : "balance";
            const events = Array.isArray(timeline?.events) ? timeline.events : [];
            const isRepaymentEvent = (event) => (event?.event_type || "").startsWith("repayment");
            let viewFiltered;
            if (view === "repayments") {
                viewFiltered = events.filter(isRepaymentEvent);
            } else if (view === "balance") {
                viewFiltered = events.filter((event) => !isRepaymentEvent(event));
            } else {
                viewFiltered = events;
            }
            const filtered = filterItemsByDateRange(viewFiltered, "event_time", timelineDateRange);
            const viewKey = view === "repayments"
                ? "timeline.view.repayments"
                : view === "all"
                    ? "timeline.view.all"
                    : "timeline.view.balance";
            const viewLabel = translate(viewKey);
            const name = timeline?.customer_name || activeCustomerInfo?.name || "-";
            const code = timeline?.customer_code || activeCustomerInfo?.customer_code || "-";
            if (heading) heading.textContent = viewLabel;
            if (title) {
                title.textContent = translate("timeline.panel.title", { name, code, view: viewLabel });
            }
            if (summary) {
                summary.textContent = translate("timeline.projected_balance", {
                    amount: formatAmount(timeline?.projected_balance ?? 0),
                });
            }
            if (!filtered.length) {
                body.innerHTML = `<tr><td colspan="6">${escapeHtml(translate("timeline.status.empty"))}</td></tr>`;
                setCustomerTimelineStatus(translate("timeline.status.empty"));
                panel?.classList.remove("hidden");
                currentTimelineCustomerId = timeline?.customer_id || activeCustomerId || null;
                currentTimelineView = view;
                return;
            }
            setCustomerTimelineStatus("");
            body.innerHTML = filtered
                .map((event) => {
                    const action = escapeHtml(formatTimelineAction(event));
                    const absValue = formatAmount(Math.abs(event.change_amount || 0));
                    const change = (event.change_amount || 0) >= 0 ? `+${absValue}` : `-${absValue}`;
                    const balance = formatAmount(event.balance_after);
                    const note = escapeHtml(formatTimelineNote(event));
                    const rawLoanCode = (event?.metadata?.loan_code ?? "").toString().trim();
                    const fallbackLoanId = event?.metadata?.loan_id ? `#${event.metadata.loan_id}` : "";
                    const loanCode = rawLoanCode || fallbackLoanId || "-";
                    return `
                        <tr>
                            <td>${escapeHtml(event.event_time ? formatMytDateTime(event.event_time) : "-")}</td>
                            <td>${action}</td>
                            <td>${escapeHtml(loanCode)}</td>
                            <td>${escapeHtml(change)}</td>
                            <td>${escapeHtml(balance)}</td>
                            <td>${note}</td>
                        </tr>`;
                })
                .join("");
            panel?.classList.remove("hidden");
            currentTimelineCustomerId = timeline?.customer_id || activeCustomerId || null;
            currentTimelineView = view;
        }

        async function fetchCustomerTimeline(customerId) {
            const response = await fetch(`/api/customers/${customerId}/balance-timeline`);
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.detail || response.statusText);
            }
            return response.json();
        }

        async function loadCustomerTimeline(customerId) {
            if (customerTimelineCache.has(customerId)) {
                return customerTimelineCache.get(customerId);
            }
            const timeline = await fetchCustomerTimeline(customerId);
            customerTimelineCache.set(customerId, timeline);
            return timeline;
        }

        async function openCustomerTimeline(viewMode = "balance") {
            const customerId = activeCustomerId;
            if (!Number.isFinite(customerId) || customerId <= 0) {
                showAlert("alert.customer_not_found");
                return;
            }
            const panel = document.getElementById("customer-timeline-panel");
            panel?.classList.remove("hidden");
            setCustomerTimelineStatus(translate("timeline.status.loading"));
            try {
                const timeline = await loadCustomerTimeline(customerId);
                renderCustomerTimeline(timeline, viewMode);
                setCustomerTimelineStatus("");
            } catch (error) {
                setCustomerTimelineStatus(translate("timeline.status.error", { message: error.message }), true);
            }
        }

        function closeCustomerTimeline() {
            currentTimelineCustomerId = null;
            currentTimelineView = null;
            const panel = document.getElementById("customer-timeline-panel");
            panel?.classList.add("hidden");
            const title = document.getElementById("customer-timeline-title");
            if (title) {
                title.textContent = "";
            }
            const heading = document.getElementById("customer-timeline-heading");
            if (heading) {
                heading.textContent = translate("timeline.view.balance");
            }
            const summary = document.getElementById("customer-timeline-summary");
            if (summary) {
                summary.textContent = "";
            }
            const body = document.getElementById("customer-timeline-body");
            if (body) {
                body.innerHTML = `<tr><td colspan="6">${escapeHtml(translate("timeline.status.empty"))}</td></tr>`;
            }
            setCustomerTimelineStatus("");
        }

        function applyPastDateLimits() {
            const now = new Date();
            const todayValue = formatDateForInput(now);
            const endOfToday = new Date(now);
            endOfToday.setHours(23, 59, 59, 999);
            const endOfDayValue = formatDateTimeForInput(endOfToday);
            if (todayValue) {
                document
                    .querySelectorAll(
                        "#records-start-date, #records-end-date, #customer-transactions-start-date, #customer-transactions-end-date, #operation-log-start-date, #operation-log-end-date, #timeline-start-date, #timeline-end-date, #overall-report-start-date, #overall-report-end-date"
                    )
                    .forEach((input) => {
                        input.setAttribute("max", todayValue);
                    });
            }
            if (endOfDayValue) {
                document.querySelectorAll('input[name="loan_date"], input[name="repayment_date"]').forEach((input) => {
                    input.setAttribute("max", endOfDayValue);
                });
            }
        }

        function initRecordsModule() {
            const startInput = document.getElementById("records-start-date");
            const endInput = document.getElementById("records-end-date");
            const loadBtn = document.getElementById("records-load-btn");
            const statusEl = document.getElementById("records-status");
            const loansBody = document.getElementById("records-loans-body");
            const repaymentsBody = document.getElementById("records-repayments-body");
            const statLoanCount = document.getElementById("stat-loan-count");
            const statLoanAmount = document.getElementById("stat-loan-amount");
            const statRepayCount = document.getElementById("stat-repay-count");
            const statRepayAmount = document.getElementById("stat-repay-amount");
            const searchInput = document.getElementById("records-search-input");
            const searchClearBtn = document.getElementById("records-search-clear");
            const viewFilterSelect = document.getElementById("records-view-filter");
            const loansContainer = document.getElementById("records-loans-container");
            const repaymentsContainer = document.getElementById("records-repayments-container");
            const loansPaginationEl = document.getElementById("records-loans-pagination");
            const repaymentsPaginationEl = document.getElementById("records-repayments-pagination");
            let recordsLoanStore = [];
            let recordsRepaymentStore = [];
            let recordsSearchQuery = "";
            let recordsViewFilter = viewFilterSelect?.value || "all";
            let recordsQuickRangeControls = null;

            if (!startInput || !endInput || !loadBtn || !loansBody || !repaymentsBody) {
                return;
            }

            const setDefaultDates = () => {
                const today = new Date();
                const past = new Date(today);
                past.setMonth(today.getMonth() - 1);
                endInput.value = formatDateForInput(today);
                startInput.value = formatDateForInput(past);
            };


            const renderLoanRows = (rows = []) => {
                if (!rows.length) {
                    const emptyText = escapeHtml(translate("records.empty.loans"));
                    loansBody.innerHTML = `<tr><td colspan="10" data-i18n="records.empty.loans">${emptyText}</td></tr>`;
                    return;
                }
                loansBody.innerHTML = rows
                    .map(
                        (loan) => {
                            const interestType = loan.interest_type || "";
                            return `
                        <tr>
                            <td>${escapeHtml(loan.loan_code || '-')}</td>
                            <td>${escapeHtml(loan.id)}</td>
                            <td>${escapeHtml(loan.customer_code || '-')}</td>
                            <td>${escapeHtml(formatMytDateTime(loan.loan_date))}</td>
                            <td>${escapeHtml(formatAmount(loan.loan_amount))}</td>
                            <td>${escapeHtml(formatAmount(loan.processing_fee))}</td>
                            <td>${escapeHtml(formatAmount(loan.interest_rate))}</td>
                            <td><span data-interest-type="${escapeHtml(interestType)}">${escapeHtml(translateInterestType(interestType))}</span></td>
                            <td>${escapeHtml(loan.note || '-')}</td>
                            <td>${escapeHtml(formatMytDateTime(loan.created_at))}</td>
                        </tr>`;
                        }
                    )
                    .join("");
                refreshInterestTypeLabels(loansBody);
            };

            const renderRepaymentRows = (rows = []) => {
                if (!rows.length) {
                    const emptyText = escapeHtml(translate("records.empty.repayments"));
                    repaymentsBody.innerHTML = `<tr><td colspan="7" data-i18n="records.empty.repayments">${emptyText}</td></tr>`;
                    return;
                }
                repaymentsBody.innerHTML = rows
                    .map(
                        (item) => `
                        <tr>
                            <td>${escapeHtml(item.id)}</td>
                            <td>${escapeHtml(item.customer_code || '-')}</td>
                            <td>${escapeHtml(item.loan_code || '-')}</td>
                            <td>${escapeHtml(formatMytDateTime(item.repayment_date))}</td>
                            <td>${escapeHtml(formatAmount(item.repayment_amount))}</td>
                            <td>${escapeHtml(item.note || '-')}</td>
                            <td>${escapeHtml(formatMytDateTime(item.created_at))}</td>
                        </tr>`
                    )
                    .join("");
            };

            recordsLoansPaginator = createPaginator({
                controls: loansPaginationEl,
                onPage: renderLoanRows,
            });
            recordsRepaymentsPaginator = createPaginator({
                controls: repaymentsPaginationEl,
                onPage: renderRepaymentRows,
            });

            const updateStats = (loans = [], repayments = []) => {
                if (statLoanCount) statLoanCount.textContent = formatCount(loans.length);
                if (statLoanAmount) {
                    const totalLoan = loans.reduce((sum, item) => sum + Number(item.loan_amount || 0), 0);
                    statLoanAmount.textContent = formatAmount(totalLoan);
                }
                if (statRepayCount) statRepayCount.textContent = formatCount(repayments.length);
                if (statRepayAmount) {
                    const totalRepay = repayments.reduce((sum, item) => sum + Number(item.repayment_amount || 0), 0);
                    statRepayAmount.textContent = formatAmount(totalRepay);
                }
            };

            const filterRecords = (items = []) => {
                const query = normalizeSearchValue(recordsSearchQuery);
                if (!query) {
                    return Array.isArray(items) ? [...items] : [];
                }
                return (Array.isArray(items) ? items : []).filter((item) => {
                    const fields = [item?.customer_code, item?.loan_code, item?.id];
                    return fields.some((value) => normalizeSearchValue(value).includes(query));
                });
            };

            const applyRecordsTypeFilter = () => {
                const normalized = (recordsViewFilter || "all").toLowerCase();
                const showLoans = normalized === "all" || normalized === "loans";
                const showRepayments = normalized === "all" || normalized === "repayments";
                loansContainer?.classList.toggle("hidden", !showLoans);
                loansPaginationEl?.classList.toggle("hidden", !showLoans);
                repaymentsContainer?.classList.toggle("hidden", !showRepayments);
                repaymentsPaginationEl?.classList.toggle("hidden", !showRepayments);
            };

            const refreshRecordsTables = (options = {}) => {
                const filteredLoans = filterRecords(recordsLoanStore);
                const filteredRepayments = filterRecords(recordsRepaymentStore);
                recordsLoansPaginator?.setItems(filteredLoans, options);
                recordsRepaymentsPaginator?.setItems(filteredRepayments, options);
                updateStats(filteredLoans, filteredRepayments);
                applyRecordsTypeFilter();
            };

            const setStatus = (message, className = "records-status") => {
                if (!statusEl) return;
                statusEl.textContent = message;
                statusEl.className = className;
            };

            const bindSearchHandlers = () => {
                if (searchInput) {
                    searchInput.addEventListener("input", () => {
                        recordsSearchQuery = searchInput.value || "";
                        refreshRecordsTables();
                    });
                }
                if (searchClearBtn) {
                    searchClearBtn.addEventListener("click", () => {
                        if (searchInput && searchInput.value) {
                            searchInput.value = "";
                        }
                        if (!recordsSearchQuery) {
                            searchInput?.focus();
                            return;
                        }
                        recordsSearchQuery = "";
                        refreshRecordsTables();
                        searchInput?.focus();
                    });
                }
                if (viewFilterSelect) {
                    viewFilterSelect.addEventListener("change", () => {
                        recordsViewFilter = viewFilterSelect.value || "all";
                        applyRecordsTypeFilter();
                    });
                }
            };

            const fetchRecords = async () => {
                const startDate = isoDate(startInput?.value);
                const endDate = isoDate(endInput?.value);
                if (!startDate || !endDate) {
                    setStatus(translate("records.status.select_range"), "records-status error");
                    return;
                }
                const todayLimit = formatDateForInput(new Date());
                if (todayLimit) {
                    if (startDate > todayLimit || endDate > todayLimit) {
                        setStatus(translate("records.status.future_not_allowed"), "records-status error");
                        return;
                    }
                }
                loadBtn.disabled = true;
                loadBtn.textContent = translate("button.loading");
                const loadingText = escapeHtml(translate("table.loading"));
                setStatus(translate("records.status.loading"), "records-status");
                loansBody.innerHTML = `<tr><td colspan="10" data-i18n="table.loading">${loadingText}</td></tr>`;
                repaymentsBody.innerHTML = `<tr><td colspan="7" data-i18n="table.loading">${loadingText}</td></tr>`;
                try {
                    const query = new URLSearchParams({ start_date: startDate, end_date: endDate });
                    const response = await fetch(`${window.location.origin}/api/records?${query.toString()}`);
                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        const detail = payload?.detail || `HTTP ${response.status}`;
                        throw new Error(detail);
                    }
                    const data = await response.json();
                    const loansData = data.loans || [];
                    const repaymentsData = data.repayments || [];
                    recordsLoanStore = Array.isArray(loansData) ? loansData : [];
                    recordsRepaymentStore = Array.isArray(repaymentsData) ? repaymentsData : [];
                    refreshRecordsTables();
                    const total = recordsLoanStore.length + recordsRepaymentStore.length;
                    if (total) {
                        const formattedTotal = formatCount(total);
                        setStatus(translate("records.status.loaded", { total: formattedTotal }), "records-status success");
                    } else {
                        setStatus(translate("records.status.none"), "records-status");
                    }
                } catch (error) {
                    recordsLoanStore = [];
                    recordsRepaymentStore = [];
                    recordsLoansPaginator?.setItems([]);
                    recordsRepaymentsPaginator?.setItems([]);
                    updateStats([], []);
                    setStatus(translate("records.status.error", { message: error.message }), "records-status error");
                } finally {
                    loadBtn.disabled = false;
                    loadBtn.textContent = translate("button.load_records");
                }
            };

            recordsQuickRangeControls = setupQuickRangeControls(document.getElementById("records-quick-range"), {
                startInput,
                endInput,
                onApplyRange: () => fetchRecords(),
            });

            startInput.addEventListener("change", () => recordsQuickRangeControls?.clearActive());
            endInput.addEventListener("change", () => recordsQuickRangeControls?.clearActive());

            bindSearchHandlers();
            setDefaultDates();
            loadBtn.addEventListener("click", fetchRecords);
            applyRecordsTypeFilter();
            fetchRecords();
        }

        function initBankLedgerModule() {
            const tableBody = document.getElementById("bank-ledger-body");
            const statusEl = document.getElementById("bank-ledger-status");
            const balanceMain = document.getElementById("bank-ledger-balance");
            const balanceChip = document.getElementById("bank-ledger-balance-chip");
            const refreshBtn = document.getElementById("bank-ledger-refresh");
            const form = document.getElementById("bank-ledger-adjust-form");
            const amountInput = document.getElementById("bank-ledger-amount");
            const directionSelect = document.getElementById("bank-ledger-direction");
            const noteInput = document.getElementById("bank-ledger-note");
            const resetBtn = document.getElementById("bank-ledger-reset");
            const formStatus = document.getElementById("bank-ledger-adjust-status");
            const startInput = document.getElementById("bank-ledger-start-date");
            const endInput = document.getElementById("bank-ledger-end-date");
            const resetDatesBtn = document.getElementById("bank-ledger-reset-dates");
            const quickRangeContainer = document.getElementById("bank-ledger-quick-range");
            const searchInput = document.getElementById("bank-ledger-search");
            const searchClearBtn = document.getElementById("bank-ledger-search-clear");
            const paginationEl = document.getElementById("bank-ledger-pagination");

            if (!tableBody || !statusEl || !balanceMain || !balanceChip) {
                return;
            }

            const PAGE_SIZE = 20;
            let isLoading = false;
            let currentPage = 1;
            let totalPages = 1;
            let quickRangeControls = null;

            const updateBalanceDisplay = (value) => {
                const formatted = formatAmount(value || 0);
                balanceMain.textContent = formatted;
                balanceChip.textContent = formatted;
            };

            const setStatus = (message, isError = false) => {
                statusEl.textContent = message || "";
                statusEl.className = isError ? "records-status error" : "records-status";
            };

            const renderRows = (rows = []) => {
                if (!rows.length) {
                    tableBody.innerHTML = `<tr><td colspan="6">${escapeHtml(translate("bank.ledger.status.empty"))}</td></tr>`;
                    return;
                }
                tableBody.innerHTML = rows
                    .map((entry) => {
                        const created = entry.created_at ? formatMytDateTime(entry.created_at) : "-";
                        const typeLabel = translateLedgerType(entry.transaction_type);
                        const reference = formatBankLedgerReference(entry);
                        const amountNumber = Number(entry.amount || 0);
                        const sign = amountNumber >= 0 ? "+" : "";
                        const amountText = `${sign}${formatAmount(amountNumber)}`;
                        const amountClass = amountNumber >= 0 ? "bank-ledger-amount-positive" : "bank-ledger-amount-negative";
                        const balanceText = formatAmount(entry.balance_after || 0);
                        const note = entry.note ? escapeHtml(entry.note) : "-";
                        return `
                            <tr>
                                <td>${escapeHtml(created)}</td>
                                <td><span class="bank-ledger-type-pill" data-ledger-type="${escapeHtml(entry.transaction_type || "")}">${escapeHtml(typeLabel)}</span></td>
                                <td>${escapeHtml(reference)}</td>
                                <td class="${amountClass}">${escapeHtml(amountText)}</td>
                                <td>${escapeHtml(balanceText)}</td>
                                <td>${note}</td>
                            </tr>`;
                    })
                    .join("");
            };

            const buildFilterParams = () => {
                const params = {};
                if (startInput) {
                    const startDate = isoDate(startInput.value);
                    if (startDate) {
                        params.start_date = startDate;
                    }
                }
                if (endInput) {
                    const endDate = isoDate(endInput.value);
                    if (endDate) {
                        params.end_date = endDate;
                    }
                }
                if (searchInput) {
                    const query = searchInput.value.trim();
                    if (query) {
                        params.search = query;
                    }
                }
                return params;
            };

            const updatePagination = (meta = {}) => {
                if (!paginationEl) {
                    return;
                }
                const total = Number(meta.total ?? 0);
                const limit = Number(meta.limit ?? PAGE_SIZE) || PAGE_SIZE;
                const offset = Number(meta.offset ?? 0);
                totalPages = Math.max(1, Math.ceil(total / limit));
                const page = total ? Math.min(totalPages, Math.floor(offset / limit) + 1) : 1;
                currentPage = page;
                const hasData = total > 0;
                const prevDisabled = !hasData || page <= 1;
                const nextDisabled = !hasData || page >= totalPages;
                const startDisplay = hasData ? offset + 1 : 0;
                const endDisplay = hasData ? Math.min(offset + limit, total) : 0;
                const statusText = hasData
                    ? translate("pagination.status", {
                        page,
                        totalPages,
                        start: startDisplay,
                        end: endDisplay,
                        total,
                    })
                    : translate("table.empty");
                const prevLabel = translate("pagination.prev");
                const nextLabel = translate("pagination.next");
                paginationEl.innerHTML = `
                    <button type="button" class="inline-btn secondary-btn" data-ledger-page="prev" ${prevDisabled ? "disabled" : ""}>${escapeHtml(prevLabel)}</button>
                    <span class="pagination-status">${escapeHtml(statusText)}</span>
                    <button type="button" class="inline-btn secondary-btn" data-ledger-page="next" ${nextDisabled ? "disabled" : ""}>${escapeHtml(nextLabel)}</button>
                `;
            };

            paginationEl?.addEventListener("click", (event) => {
                const button = event.target.closest("[data-ledger-page]");
                if (!button) return;
                const action = button.dataset.ledgerPage;
                if (action === "prev" && currentPage > 1) {
                    fetchLedger({ page: currentPage - 1 });
                }
                if (action === "next" && currentPage < totalPages) {
                    fetchLedger({ page: currentPage + 1 });
                }
            });

            const fetchLedger = async ({ page } = {}) => {
                if (isLoading) {
                    return;
                }
                if (typeof page === "number" && page >= 1) {
                    currentPage = page;
                }
                isLoading = true;
                setStatus(translate("bank.ledger.status.loading"));
                refreshBtn?.setAttribute("disabled", "true");
                try {
                    const params = new URLSearchParams();
                    params.set("limit", PAGE_SIZE.toString());
                    params.set("page", currentPage.toString());
                    const filters = buildFilterParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (value) {
                            params.set(key, value);
                        }
                    });
                    const response = await fetch(`/api/bank/transactions?${params.toString()}`);
                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        const detail = payload?.detail || response.statusText;
                        throw new Error(detail);
                    }
                    const data = await response.json();
                    updateBalanceDisplay(data.balance || 0);
                    const items = Array.isArray(data.transactions) ? data.transactions : [];
                    renderRows(items);
                    updatePagination({
                        total: data.total ?? items.length,
                        limit: data.limit ?? PAGE_SIZE,
                        offset: data.offset ?? 0,
                    });
                    if (!items.length) {
                        setStatus(translate("bank.ledger.status.empty"));
                    } else {
                        setStatus("");
                    }
                } catch (error) {
                    setStatus(translate("bank.ledger.status.error", { message: error.message }), true);
                } finally {
                    isLoading = false;
                    refreshBtn?.removeAttribute("disabled");
                }
            };

            refreshBtn?.addEventListener("click", () => fetchLedger({ page: 1 }));

            resetDatesBtn?.addEventListener("click", () => {
                if (startInput) startInput.value = "";
                if (endInput) endInput.value = "";
                quickRangeControls?.clearActive();
                fetchLedger({ page: 1 });
            });

            const handleDateChange = () => {
                quickRangeControls?.clearActive();
                if (!startInput || !endInput) {
                    fetchLedger({ page: 1 });
                    return;
                }
                const startDate = isoDate(startInput.value);
                const endDate = isoDate(endInput.value);
                if (startDate && endDate && endDate < startDate) {
                    setStatus(translate("logs.status.invalid_range"), true);
                    return;
                }
                fetchLedger({ page: 1 });
            };

            startInput?.addEventListener("change", handleDateChange);
            endInput?.addEventListener("change", handleDateChange);

            quickRangeControls = setupQuickRangeControls(quickRangeContainer, {
                startInput,
                endInput,
                onApplyRange: () => fetchLedger({ page: 1 }),
            });

            searchClearBtn?.addEventListener("click", () => {
                if (searchInput && searchInput.value) {
                    searchInput.value = "";
                }
                fetchLedger({ page: 1 });
            });

            searchInput?.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    fetchLedger({ page: 1 });
                }
            });

            searchInput?.addEventListener("input", () => {
                if (searchInput && searchInput.value === "") {
                    fetchLedger({ page: 1 });
                }
            });

            const resetForm = () => {
                if (!form) return;
                form.reset();
                if (formStatus) {
                    formStatus.textContent = "";
                    formStatus.className = "records-status";
                }
            };

            resetBtn?.addEventListener("click", (event) => {
                event.preventDefault();
                resetForm();
            });

            form?.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!amountInput || !directionSelect) {
                    return;
                }
                const rawAmount = Number(amountInput.value);
                if (!Number.isFinite(rawAmount) || rawAmount <= 0) {
                    if (formStatus) {
                        formStatus.textContent = translate("error.amount_non_negative");
                        formStatus.className = "records-status error";
                    } else {
                        showAlert("error.amount_non_negative");
                    }
                    amountInput.focus();
                    return;
                }
                const noteValue = noteInput && typeof noteInput.value === "string" ? noteInput.value.trim() : "";
                const directionValue = directionSelect?.value || "deposit";
                const payload = {
                    amount: Math.abs(rawAmount),
                    direction: directionValue,
                    note: noteValue || undefined,
                };
                if (formStatus) {
                    formStatus.textContent = translate("button.loading");
                    formStatus.className = "records-status";
                }
                const submitButton = form.querySelector("button[type='submit']");
                submitButton?.setAttribute("disabled", "true");
                try {
                    const response = await fetch("/api/bank/transactions/manual", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const detail = await response.json().catch(() => ({}));
                        throw new Error(detail?.detail || response.statusText);
                    }
                    if (formStatus) {
                        formStatus.textContent = translate("bank.ledger.form.success");
                        formStatus.className = "records-status success";
                    }
                    resetForm();
                    await fetchLedger();
                } catch (error) {
                    if (formStatus) {
                        formStatus.textContent = translate("bank.ledger.form.error", { message: error.message });
                        formStatus.className = "records-status error";
                    } else {
                        showAlert("bank.ledger.form.error", { message: error.message });
                    }
                } finally {
                    submitButton?.removeAttribute("disabled");
                }
            });

            fetchLedger({ page: 1 });
        }

        function initOverallReportModule() {
            const startInput = document.getElementById("overall-report-start-date");
            const endInput = document.getElementById("overall-report-end-date");
            const resetBtn = document.getElementById("overall-report-reset");
            const loadBtn = document.getElementById("overall-report-load");
            if (!startInput || !endInput || !loadBtn) {
                return;
            }

            let overallQuickRangeControls = null;

            const updateButtonState = (loading) => {
                if (!loadBtn) return;
                if (loading) {
                    loadBtn.disabled = true;
                    loadBtn.textContent = translate("button.loading");
                } else {
                    loadBtn.disabled = false;
                    loadBtn.textContent = translate("button.load_overall_report");
                }
            };

            const fetchReport = async () => {
                const startDate = isoDate(startInput.value);
                const endDate = isoDate(endInput.value);
                if (startDate && endDate && endDate < startDate) {
                    showAlert("alert.date_range_invalid");
                    return;
                }
                const params = new URLSearchParams();
                if (startDate) {
                    params.set("start_date", startDate);
                }
                if (endDate) {
                    params.set("end_date", endDate);
                }
                const query = params.toString();
                const url = query ? `/api/reports/overall?${query}` : "/api/reports/overall";
                try {
                    updateButtonState(true);
                    setOverallReportStatus("report.overall.status.loading");
                    const response = await fetch(url);
                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        const detail = payload?.detail || response.statusText;
                        throw new Error(detail);
                    }
                    const data = await response.json();
                    overallReportData = data;
                    renderOverallReportValues(data);
                    overallReportRenderer = () => renderOverallReportValues(overallReportData);
                    setOverallReportStatus("report.overall.status.loaded");
                } catch (error) {
                    setOverallReportStatus("report.overall.status.error", { message: error.message }, true);
                } finally {
                    updateButtonState(false);
                }
            };

            overallQuickRangeControls = setupQuickRangeControls(document.getElementById("overall-report-quick-range"), {
                startInput,
                endInput,
                onApplyRange: () => fetchReport(),
            });

            const handleReset = () => {
                startInput.value = "";
                endInput.value = "";
                overallQuickRangeControls?.clearActive();
                setOverallReportStatus("report.overall.status.ready");
            };

            resetBtn?.addEventListener("click", handleReset);
            loadBtn.addEventListener("click", fetchReport);
            startInput.addEventListener("change", () => {
                if (!startInput.value && !endInput.value) {
                    setOverallReportStatus("report.overall.status.ready");
                }
                overallQuickRangeControls?.clearActive();
            });
            endInput.addEventListener("change", () => {
                if (!startInput.value && !endInput.value) {
                    setOverallReportStatus("report.overall.status.ready");
                }
                overallQuickRangeControls?.clearActive();
            });

            overallReportRenderer = () => renderOverallReportValues(overallReportData);
            renderOverallReportValues(overallReportData);
            setOverallReportStatus("report.overall.status.ready");
            overallQuickRangeControls?.applyRangeByKey("last_month", { triggerCallback: false });
            fetchReport();
        }

        function initOperationLogsModule() {
            const body = document.getElementById("operation-log-body");
            const statusEl = document.getElementById("operation-log-status");
            const refreshBtn = document.getElementById("operation-log-refresh");
            const limitSelect = document.getElementById("operation-log-limit");
            const typeSelect = document.getElementById("operation-log-entity-type");
            const startInput = document.getElementById("operation-log-start-date");
            const endInput = document.getElementById("operation-log-end-date");
            const dateResetBtn = document.getElementById("operation-log-date-reset");
            let logQuickRangeControls = null;

            const setStatus = (message, isError = false) => {
                if (!statusEl) return;
                statusEl.textContent = message;
                statusEl.className = isError ? "records-status error" : "records-status";
            };

            dateResetBtn?.addEventListener("click", () => {
                if (startInput) startInput.value = "";
                if (endInput) endInput.value = "";
                logQuickRangeControls?.clearActive();
            });

            startInput?.addEventListener("change", () => logQuickRangeControls?.clearActive());
            endInput?.addEventListener("change", () => logQuickRangeControls?.clearActive());

            const renderRows = (rows) => {
                if (!body) return;
                if (!rows.length) {
                    const emptyText = escapeHtml(translate("logs.status.empty"));
                    body.innerHTML = `<tr><td colspan="7" data-i18n="logs.status.empty">${emptyText}</td></tr>`;
                    return;
                }
                body.innerHTML = rows
                    .map((log) => {
                        const actionClass = resolveLogActionClass(log.action);
                        const timestamp = escapeHtml(formatMytDateTime(log.created_at));
                        const entityLabel = escapeHtml(translateEntityType(log.entity_type));
                        const customerCode = escapeHtml(log.customer_code || "-");
                        const entityId = escapeHtml(log.entity_id ?? "-");
                        const actionText = escapeHtml(log.action || "-");
                        const description = formatLogDescription(log);
                        const metadataHtml = formatMetadataLines(log.metadata);
                        const entityTypeAttr = escapeHtml(log.entity_type || "");
                        return `
                        <tr>
                            <td>${timestamp}</td>
                            <td data-entity-type="${entityTypeAttr}">${entityLabel}</td>
                            <td>${customerCode}</td>
                            <td>${entityId}</td>
                            <td><span class="log-action ${actionClass}">${actionText}</span></td>
                            <td>${description}</td>
                            <td class="log-metadata">${metadataHtml}</td>
                        </tr>`;
                    })
                    .join("");
            };
            operationLogsPaginator = createPaginator({
                controls: document.getElementById("operation-log-pagination"),
                onPage: renderRows,
            });
            operationLogsRenderer = () => operationLogsPaginator?.refresh();

            const fetchLogs = async () => {
                if (!refreshBtn) return;
                const startDate = startInput ? isoDate(startInput.value) : "";
                const endDate = endInput ? isoDate(endInput.value) : "";
                if (startDate && endDate && endDate < startDate) {
                    setStatus(translate("logs.status.invalid_range"), true);
                    return;
                }
                const params = new URLSearchParams();
                const limit = Number(limitSelect?.value) || 100;
                params.set("limit", Math.max(1, Math.min(limit, 500)));
                const entityType = typeSelect?.value?.trim();
                if (entityType) {
                    params.set("entity_type", entityType);
                }
                if (startDate) {
                    params.set("start_date", startDate);
                }
                if (endDate) {
                    params.set("end_date", endDate);
                }
                try {
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = translate("button.refreshing");
                    setStatus(translate("logs.status.loading"));
                    if (body) {
                        const loadingText = escapeHtml(translate("table.loading"));
                        body.innerHTML = `<tr><td colspan="7" data-i18n="table.loading">${loadingText}</td></tr>`;
                    }
                    const response = await fetch(`/api/operation-logs?${params.toString()}`);
                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        const detail = payload?.detail || response.statusText;
                        throw new Error(detail);
                    }
                    const data = await response.json();
                    operationLogsStore = Array.isArray(data) ? data : [];
                    operationLogsPaginator?.setItems(operationLogsStore);
                    const total = operationLogsStore.length;
                    if (total) {
                        setStatus(translate("logs.status.showing", { total }));
                    } else {
                        setStatus(translate("logs.status.empty"));
                    }
                } catch (error) {
                    operationLogsPaginator?.setItems(operationLogsStore, { preservePage: true });
                    setStatus(translate("logs.status.error", { message: error.message }), true);
                } finally {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = translate("button.refresh_logs");
                }
            };

            logQuickRangeControls = setupQuickRangeControls(document.getElementById("operation-log-quick-range"), {
                startInput,
                endInput,
                onApplyRange: () => fetchLogs(),
            });

            operationLogsStore = parseJsonScript("operation-logs-data");
            if (!Array.isArray(operationLogsStore)) {
                operationLogsStore = [];
            }
            operationLogsPaginator?.setItems(operationLogsStore);
            if (operationLogsStore.length) {
                setStatus(translate("logs.status.showing", { total: operationLogsStore.length }));
            } else {
                setStatus(translate("logs.status.empty"));
            }
            refreshBtn?.addEventListener("click", fetchLogs);
        }

        function initAdminAccessModule() {
            const section = document.getElementById("section-admin-access");
            if (!section) {
                return;
            }
            const usersDataEl = document.getElementById("admin-users-data");
            const permissionsDataEl = document.getElementById("admin-permissions-data");
            if (!permissionsDataEl) {
                return;
            }
            let users = [];
            let permissionCatalog = [];
            try {
                users = JSON.parse((usersDataEl && usersDataEl.textContent) || "[]");
            } catch (error) {
                users = [];
            }
            try {
                permissionCatalog = JSON.parse((permissionsDataEl && permissionsDataEl.textContent) || "[]");
            } catch (error) {
                permissionCatalog = [];
            }
            if (!permissionCatalog.length) {
                return;
            }
            const createForm = document.getElementById("admin-create-form");
            const editForm = document.getElementById("admin-edit-form");
            if (!createForm || !editForm) {
                return;
            }
            const createStatus = document.getElementById("admin-create-status");
            const editStatus = document.getElementById("admin-edit-status");
            const userList = document.getElementById("admin-user-list");
            const userEmpty = document.getElementById("admin-user-empty");
            const resetCreateBtn = document.getElementById("admin-reset-create");
            const resetPasswordBtn = document.getElementById("admin-reset-password");
            const removeSelectionBtn = document.getElementById("admin-remove-selection");
            const createRoleSelect = document.getElementById("admin-create-role");
            const editRoleSelect = document.getElementById("admin-edit-role");
            const createRoleNote = document.getElementById("admin-create-role-note");
            const editActiveField = editForm.querySelector('select[name="is_active"]');
            const createGrid = section.querySelector('[data-permission-grid="create"]');
            const editGrid = section.querySelector('[data-permission-grid="edit"]');
            if (!createGrid || !editGrid) {
                return;
            }

            const permissionGroups = (() => {
                const grouped = new Map();
                permissionCatalog.forEach((perm) => {
                    if (!grouped.has(perm.category)) {
                        grouped.set(perm.category, []);
                    }
                    grouped.get(perm.category).push(perm);
                });
                return grouped;
            })();

            let selectedUserId = null;

            const renderPermissionGrid = (container, selections = {}) => {
                container.innerHTML = "";
                permissionGroups.forEach((items, category) => {
                    const wrapper = document.createElement("div");
                    wrapper.className = "admin-permission-group";
                    const title = document.createElement("h4");
                    title.textContent = category;
                    wrapper.appendChild(title);
                    items.forEach((perm) => {
                        const row = document.createElement("div");
                        row.className = "admin-permission-item";
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.dataset.permissionKey = perm.key;
                        checkbox.checked = Boolean(selections[perm.key]);
                        const label = document.createElement("label");
                        label.innerHTML = `${perm.label} <small>${perm.action === "view" ? "可见" : "可操作"} · ${perm.description || ""}</small>`;
                        row.appendChild(checkbox);
                        row.appendChild(label);
                        wrapper.appendChild(row);
                    });
                    container.appendChild(wrapper);
                });
            };

            const setGridRoleState = (container, role, selections = {}) => {
                container.dataset.role = role;
                const isAdmin = role === "admin";
                container.querySelectorAll('input[type="checkbox"]').forEach((input) => {
                    const key = input.dataset.permissionKey;
                    if (!key) return;
                    if (isAdmin) {
                        input.checked = true;
                        input.disabled = true;
                    } else {
                        input.disabled = false;
                        input.checked = Boolean(selections[key]);
                    }
                });
            };

            const getPermissionsFromGrid = (container) => {
                const selections = {};
                container.querySelectorAll('input[type="checkbox"]').forEach((input) => {
                    const key = input.dataset.permissionKey;
                    if (!key) return;
                    if (input.checked && !input.disabled) {
                        selections[key] = true;
                    }
                });
                return selections;
            };

            const showStatus = (target, message, isError = false) => {
                if (!target) return;
                target.textContent = message;
                target.className = "admin-status" + (isError ? " error" : " success");
            };

            const clearStatus = (target) => {
                if (!target) return;
                target.textContent = "";
                target.className = "admin-status";
            };

            const renderUserList = () => {
                if (!userList) return;
                userList.innerHTML = "";
                if (!users.length) {
                    userEmpty.hidden = false;
                    return;
                }
                userEmpty.hidden = true;
                users
                    .slice()
                    .sort((a, b) => a.id - b.id)
                    .forEach((user) => {
                        const pill = document.createElement("div");
                        pill.className = "admin-user-pill" + (user.id === selectedUserId ? " active" : "");
                        pill.dataset.userId = user.id;
                        const meta = document.createElement("div");
                        meta.className = "admin-user-meta";
                        const name = document.createElement("strong");
                        name.textContent = user.username;
                        const role = document.createElement("span");
                        role.className = "admin-tag" + (user.is_active ? "" : " inactive");
                        role.textContent = `${user.role}${user.is_active ? "" : " · 禁用"}`;
                        meta.appendChild(name);
                        meta.appendChild(role);
                        const arrow = document.createElement("span");
                        arrow.className = "admin-user-arrow";
                        arrow.textContent = "编辑 →";
                        pill.appendChild(meta);
                        pill.appendChild(arrow);
                        pill.addEventListener("click", () => selectUser(user.id));
                        userList.appendChild(pill);
                    });
            };

            const selectUser = (userId) => {
                selectedUserId = userId;
                const user = users.find((item) => item.id === userId);
                if (!user) {
                    return;
                }
                editForm.username.value = user.username;
                if (editRoleSelect) {
                    editRoleSelect.value = user.role;
                }
                if (editActiveField) {
                    editActiveField.value = String(user.is_active);
                }
                renderPermissionGrid(editGrid, user.permissions || {});
                setGridRoleState(editGrid, user.role, user.permissions || {});
                showStatus(editStatus, `正在编辑：${user.username}`);
                renderUserList();
            };

            const resetCreateForm = () => {
                createForm.reset();
                renderPermissionGrid(createGrid);
                if (createRoleSelect) {
                    setGridRoleState(createGrid, createRoleSelect.value);
                    updateCreateRoleMessage(createRoleSelect.value);
                }
                clearStatus(createStatus);
            };

            const updateCreateRoleMessage = (role) => {
                if (!createRoleNote) return;
                createRoleNote.textContent = role === "admin"
                    ? "管理员拥有全部权限并忽略下方勾选。"
                    : "勾选可见/可操作权限，未勾选的内容将对该账号隐藏。";
            };

            const createUser = async (event) => {
                event.preventDefault();
                const formData = new FormData(createForm);
                const role = formData.get("role");
                const payload = {
                    username: formData.get("username"),
                    password: formData.get("password"),
                    role,
                    permissions: role === "admin" ? {} : getPermissionsFromGrid(createGrid),
                };
                if (createStatus) {
                    createStatus.textContent = "创建中…";
                    createStatus.className = "admin-status";
                }
                try {
                    const response = await fetch("/api/admin/users", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const detail = await response.json().catch(() => ({}));
                        throw new Error(detail.detail || `HTTP ${response.status}`);
                    }
                    const user = await response.json();
                    users.push(user);
                    renderUserList();
                    resetCreateForm();
                    showStatus(createStatus, "账号创建成功");
                } catch (error) {
                    showStatus(createStatus, `创建失败：${error.message}`, true);
                }
            };

            const updateSelectedUser = async (event) => {
                event.preventDefault();
                if (!selectedUserId) {
                    showStatus(editStatus, "请先选择账号", true);
                    return;
                }
                const formData = new FormData(editForm);
                const role = formData.get("role");
                const payload = {
                    username: formData.get("username"),
                    role,
                    is_active: formData.get("is_active") === "true",
                    permissions: role === "admin" ? {} : getPermissionsFromGrid(editGrid),
                };
                if (editStatus) {
                    editStatus.textContent = "保存中…";
                    editStatus.className = "admin-status";
                }
                try {
                    const response = await fetch(`/api/admin/users/${selectedUserId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const detail = await response.json().catch(() => ({}));
                        throw new Error(detail.detail || `HTTP ${response.status}`);
                    }
                    const user = await response.json();
                    users = users.map((item) => (item.id === user.id ? user : item));
                    renderUserList();
                    selectUser(user.id);
                    showStatus(editStatus, "已保存");
                } catch (error) {
                    showStatus(editStatus, `保存失败：${error.message}`, true);
                }
            };

            const resetPassword = async () => {
                if (!selectedUserId) {
                    showStatus(editStatus, "请选择账号后再重置密码", true);
                    return;
                }
                const password = window.prompt("输入新的密码：");
                if (!password) {
                    return;
                }
                if (editStatus) {
                    editStatus.textContent = "正在重置密码…";
                    editStatus.className = "admin-status";
                }
                try {
                    const response = await fetch(`/api/admin/users/${selectedUserId}/reset-password`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ password }),
                    });
                    if (!response.ok) {
                        const detail = await response.json().catch(() => ({}));
                        throw new Error(detail.detail || `HTTP ${response.status}`);
                    }
                    showStatus(editStatus, "密码已更新");
                } catch (error) {
                    showStatus(editStatus, `重置失败：${error.message}`, true);
                }
            };

            const removeSelection = () => {
                selectedUserId = null;
                editForm.reset();
                renderPermissionGrid(editGrid);
                if (editRoleSelect) {
                    setGridRoleState(editGrid, editRoleSelect.value);
                }
                showStatus(editStatus, "已取消选择");
                renderUserList();
            };

            renderPermissionGrid(createGrid);
            renderPermissionGrid(editGrid);
            if (createRoleSelect) {
                setGridRoleState(createGrid, createRoleSelect.value);
                updateCreateRoleMessage(createRoleSelect.value);
                createRoleSelect.addEventListener("change", () => {
                    setGridRoleState(createGrid, createRoleSelect.value);
                    updateCreateRoleMessage(createRoleSelect.value);
                });
            }
            if (editRoleSelect) {
                editRoleSelect.addEventListener("change", () => {
                    const user = users.find((item) => item.id === selectedUserId);
                    const selections = user ? user.permissions || {} : {};
                    setGridRoleState(editGrid, editRoleSelect.value, selections);
                });
            }

            createForm.addEventListener("submit", createUser);
            editForm.addEventListener("submit", updateSelectedUser);
            resetCreateBtn?.addEventListener("click", resetCreateForm);
            resetPasswordBtn?.addEventListener("click", resetPassword);
            removeSelectionBtn?.addEventListener("click", removeSelection);

            renderUserList();
            if (users.length) {
                selectUser(users[0].id);
            } else {
                setGridRoleState(editGrid, editRoleSelect ? editRoleSelect.value : "admin");
                clearStatus(editStatus);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            try {
                APP_PERMISSIONS = JSON.parse(document.body.dataset.permissions || "{}");
            } catch (error) {
                APP_PERMISSIONS = {};
            }
            const permissionMap = APP_PERMISSIONS || {};
            document.querySelectorAll("[data-permission]").forEach((section) => {
                const key = section.dataset.permission;
                if (key && !permissionMap[key]) {
                    section.classList.add("hidden");
                }
            });
            const menuButtons = document.querySelectorAll(".menu-btn");
            const sections = document.querySelectorAll(".content-section");

            const showSection = (targetId) => {
                if (!targetId) return;
                sections.forEach((section) => section.classList.toggle("active", section.id === targetId));
                menuButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.target === targetId));
            };

            menuButtons.forEach((btn) => {
                btn.addEventListener("click", () => showSection(btn.dataset.target));
            });

            const quickNavButtons = document.querySelectorAll("[data-section-target]");
            quickNavButtons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const targetId = btn.dataset.sectionTarget;
                    if (!targetId) return;
                    showSection(targetId);
                    const targetSection = document.getElementById(targetId);
                    targetSection?.scrollIntoView({ behavior: "smooth", block: "start" });
                });
            });

            let initial = document.querySelector(".menu-btn.active");
            if (!initial) {
                initial = document.querySelector(".menu-btn");
                if (initial) {
                    initial.classList.add("active");
                }
            }
            if (initial) {
                showSection(initial.dataset.target);
            }

            initLanguageSwitcher();
            applyPastDateLimits();
            initRecordsModule();
            initBankLedgerModule();
            initPhotoPreview();
            initCustomerFeatures();
            initOverallReportModule();
            initOperationLogsModule();
            initAdminAccessModule();
            const balanceForm = document.getElementById("customer-balance-form");
            balanceForm?.addEventListener("submit", handleBalanceSubmit);
            document.getElementById("balance-modal-cancel")?.addEventListener("click", () => {
                closeBalanceModal();
            });
            document.getElementById("customer-modal-cancel")?.addEventListener("click", () => {
                closeCustomerModal();
            });
            document.getElementById("photo-modal-cancel")?.addEventListener("click", () => {
                closePhotoModal();
            });
        });
    </script>
</head>
<body data-permissions='{{ permissions | tojson | e }}'>
    <div class="layout">
        <aside class="sidebar">
            <div class="language-switcher">
                <label for="language-select" data-i18n="language.label">界面语言</label>
                <select id="language-select">
                    <option value="zh" data-i18n="language.option.zh">华语</option>
                    <option value="en" data-i18n="language.option.en">英文</option>
                    <option value="ms" data-i18n="language.option.ms">马来语</option>
                </select>
            </div>
            <h2 data-i18n="menu.title">功能菜单</h2>
            {% if permissions.get('reports.view') %}
                <button class="menu-btn active" data-target="section-overall-report" data-i18n="menu.overall_report">报表总览</button>
            {% endif %}
            {% if permissions.get('customer.manage') %}
                <button class="menu-btn" data-target="section-add-customer" data-i18n="menu.add_customer">添加顾客</button>
            {% endif %}
            {% if permissions.get('customer.view') %}
                <button class="menu-btn" data-target="section-customer-list" data-i18n="menu.customer_list">顾客列表</button>
            {% endif %}
            {% if permissions.get('loan.manage') %}
                <button class="menu-btn" data-target="section-add-loan" data-i18n="menu.add_loan">添加借贷</button>
            {% endif %}
            {% if permissions.get('repayment.manage') %}
                <button class="menu-btn" data-target="section-add-repayment" data-i18n="menu.add_repayment">添加还款</button>
            {% endif %}
            {% if permissions.get('records.view') %}
                <button class="menu-btn" data-target="section-records" data-i18n="menu.records">借/还贷记录</button>
            {% endif %}
            {% if permissions.get('records.view') %}
                <button class="menu-btn" data-target="section-bank-ledger" data-i18n="menu.bank_ledger">银行进出款</button>
            {% endif %}
            {% if permissions.get('operationlog.view') %}
                <button class="menu-btn" data-target="section-operation-logs" data-i18n="menu.operation_logs">操作日志</button>
            {% endif %}
            {% if permissions.get('summary.view') %}
                <button class="menu-btn" data-target="section-summary" data-i18n="menu.summary">顾客总览</button>
            {% endif %}
            {% if permissions.get('admin.manage') or current_user.role.value == 'admin' %}
                <button class="menu-btn" data-target="section-admin-access" data-i18n="menu.admin_access">管理员管理</button>
            {% endif %}
        </aside>
        <main class="content">
            <div class="top-bar">
                <div class="top-bar-user">
                    <span class="top-bar-prefix" data-i18n="topbar.current_user_prefix">当前登录：</span>
                    <strong>{{ current_user.username }}</strong>
                    <span class="role-tag">{{ current_user.role.value }}</span>
                </div>
                <div class="top-bar-actions">
                    <form method="post" action="/auth/logout">
                        <button type="submit" data-i18n="topbar.logout">退出登录</button>
                    </form>
                </div>
            </div>
            <section class="page-hero">
                <div>
                    <h1 data-i18n="page.title">放贷记录管理后台</h1>
                    <p class="hero-subtitle" data-i18n="page.hero.subtitle">集中查看借出与还款概况，并一键跳转到常用操作。</p>
                    <div class="hero-tags">
                        <span class="chip" data-i18n="page.hero.timezone">基于马来西亚时区 (UTC+8)</span>
                    </div>
                    <div class="hero-metrics">
                        <div class="metric-card">
                            <span data-i18n="hero.metric.customers">顾客总数</span>
                            <strong>{{ customers|length }}</strong>
                        </div>
                        <div class="metric-card">
                            <span data-i18n="hero.metric.loans">借贷次数</span>
                            <strong>{{ loans|length }}</strong>
                        </div>
                        <div class="metric-card">
                            <span data-i18n="hero.metric.repayments">还款次数</span>
                            <strong>{{ repayments|length }}</strong>
                        </div>
                    </div>
                </div>
                <div class="hero-actions">
                    <span class="quick-nav-label" data-i18n="page.hero.quick_nav">快速导航</span>
                    <div class="quick-nav">
                        <button type="button" class="quick-pill" data-section-target="section-overall-report" data-i18n="menu.overall_report">报表总览</button>
                        <button type="button" class="quick-pill" data-section-target="section-records" data-i18n="menu.records">借/还贷记录</button>
                        <button type="button" class="quick-pill" data-section-target="section-operation-logs" data-i18n="menu.operation_logs">操作日志</button>
                        <button type="button" class="quick-pill" data-section-target="section-summary" data-i18n="menu.summary">顾客总览</button>
                    </div>
                    <div class="hero-btn-group">
                        <button type="button" class="hero-btn" data-section-target="section-records" data-i18n="page.hero.primary_action">查看最新借还记录</button>
                        <button type="button" class="hero-btn" data-section-target="section-add-loan" data-i18n="page.hero.secondary_action">快速添加借贷</button>
                    </div>
                </div>
            </section>

            <section id="section-add-customer" class="content-section" data-permission="customer.manage">
                <h2 data-i18n="section.add_customer">添加顾客</h2>
                <form onsubmit="handleCustomerSubmit(event)">
                    <label>
                        <span data-i18n="form.customer.customer_code">顾客编号</span>
                        <input name="customer_code" id="customer-code-input" data-i18n-placeholder="placeholder.customer_code" placeholder="如 CUST-XXXXXX">
                    </label>
                    <label>
                        <span data-i18n="form.customer.name">姓名</span>
                        <input name="name" required>
                    </label>
                    <label>
                        <span data-i18n="form.customer.phone">电话</span>
                        <input name="phone" required>
                    </label>
                    <label>
                        <span data-i18n="form.customer.id_card">身份证</span>
                        <input name="id_card" data-i18n-placeholder="placeholder.customer_id_card" placeholder="例如 880101-14-5678">
                    </label>
                    <label>
                        <span data-i18n="form.customer.address">地址</span>
                        <input name="address">
                    </label>
                    <label>
                        <span data-i18n="form.customer.note">备注</span>
                        <textarea name="note"></textarea>
                    </label>
                    <label>
                        <span data-i18n="form.customer.photo">顾客照片</span>
                        <input type="file" name="photo" id="customer-photo-input" accept="image/*">
                    </label>
                    <div class="photo-preview">
                        <span data-i18n="label.photo_preview">照片预览</span>
                        <img id="customer-photo-preview" alt="顾客照片预览">
                    </div>
                    <button type="submit" data-i18n="button.save_customer">保存顾客</button>
                </form>
            </section>

            <section id="section-customer-list" class="content-section" data-permission="customer.view">
                <h2 data-i18n="section.customer_list">顾客列表</h2>
                <div class="customer-search">
                    <label for="customer-search-input">
                        <span data-i18n="customer.search.label">搜索顾客</span>
                        <input type="text" id="customer-search-input" data-i18n-placeholder="customer.search.placeholder" placeholder="输入顾客编号、姓名、电话、身份证、备注或地址">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="customer-search-clear" data-i18n="button.clear">清除</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="table.customers.no">No.</th>
                            <th data-i18n="table.customers.code">顾客编号</th>
                            <th data-i18n="table.customers.name">姓名</th>
                            <th data-i18n="table.customers.phone">电话</th>
                            <th data-i18n="table.customers.id_card">身份证</th>
                            <th data-i18n="table.customers.address">地址</th>
                            <th data-i18n="table.customers.note">备注</th>
                            <th data-i18n="table.customers.photo">照片</th>
                            <th data-i18n="table.customers.created">添加时间</th>
                            <th data-i18n="table.customers.actions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table-body">
                    {% for customer in customers %}
                        <tr data-customer-row="{{ customer.id }}">
                            <td>{{ loop.index }}</td>
                            <td class="customer-code">{{ customer.customer_code }}</td>
                            <td data-field="name">{{ customer.name }}</td>
                            <td data-field="phone">{{ customer.phone }}</td>
                            <td data-field="id_card">{{ customer.id_card or '-' }}</td>
                            <td data-field="address">{{ customer.address or '-' }}</td>
                            <td data-field="note">{{ customer.note or '-' }}</td>
                            <td class="customer-photo-cell">
                                {% if customer.photo_url %}
                                    <img src="{{ customer.photo_url }}" alt="{{ customer.name }}">
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ customer.created_at|myt }}</td>
                            <td class="customer-actions">
                                <button type="button" class="inline-btn customer-action" data-action="profile" data-customer-id="{{ customer.id }}" data-i18n="button.profile">资料</button>
                                <button type="button" class="inline-btn customer-action" data-action="phone" data-customer-id="{{ customer.id }}" data-i18n="button.phone">电话</button>
                                <button type="button" class="inline-btn customer-action" data-action="address" data-customer-id="{{ customer.id }}" data-i18n="button.address">地址</button>
                                <button type="button" class="inline-btn customer-action" data-action="balance" data-customer-id="{{ customer.id }}" data-i18n="button.balance">余额</button>
                                <button type="button" class="inline-btn customer-action" data-action="photo" data-customer-id="{{ customer.id }}" data-i18n="button.photo">照片</button>
                                <button type="button" class="inline-btn customer-action" data-action="transactions" data-customer-id="{{ customer.id }}" data-i18n="button.transactions">交易</button>
                            </td>
                        </tr>
                    {% endfor %}
                    {% if not customers %}
                        <tr><td colspan="10" data-i18n="table.empty">暂无数据</td></tr>
                    {% endif %}
                    </tbody>
                </table>
                <div class="pagination-controls" id="customers-pagination"></div>
            </section>

            <section id="customer-transactions-panel" class="content-section customer-transactions">
                <div class="transactions-header">
                    <h2 data-i18n="section.customer_transactions">顾客借还记录</h2>
                    <button type="button" class="inline-btn secondary-btn" id="close-customer-transactions" data-i18n="button.close">关闭</button>
                </div>
                <p id="customer-transactions-title" data-i18n="customer.transactions.placeholder">请选择顾客查看借还记录。</p>
                <div class="customer-transactions-filter">
                    <label for="customer-transactions-view-filter">
                        <span data-i18n="records.view_filter.label">记录类型</span>
                        <select id="customer-transactions-view-filter">
                            <option value="all" data-i18n="records.view_filter.option.all">全部记录</option>
                            <option value="loans" data-i18n="records.view_filter.option.loans">只看借贷记录</option>
                            <option value="repayments" data-i18n="records.view_filter.option.repayments">只看还贷记录</option>
                        </select>
                    </label>
                </div>
                <div class="customer-transactions-date-filter">
                    <label>
                        <span data-i18n="customer.transactions.date_filter.start">开始日期</span>
                        <input type="date" id="customer-transactions-start-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <label>
                        <span data-i18n="customer.transactions.date_filter.end">结束日期</span>
                        <input type="date" id="customer-transactions-end-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="customer-transactions-date-reset" data-i18n="customer.transactions.date_filter.reset">清除日期</button>
                    <div class="report-quick-range" id="customer-transactions-quick-range">
                        <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                        <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                        <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                        <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                        <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                    </div>
                </div>
                <div class="customer-totals hidden" id="customer-totals-panel">
                    <div class="total-card">
                        <h4 data-i18n="totals.total_loan">总借出</h4>
                        <p id="customer-total-loan">0.00</p>
                    </div>
                    <div class="total-card">
                        <h4 data-i18n="totals.total_repayment">总还款</h4>
                        <p id="customer-total-repayment">0.00</p>
                    </div>
                    <div class="total-card">
                        <h4 data-i18n="totals.interest_profit">利息总盈利</h4>
                        <p id="customer-interest-profit">0.00</p>
                    </div>
                    <div class="total-card">
                        <h4 data-i18n="totals.fee_income">手续费总收入</h4>
                        <p id="customer-fee-income">0.00</p>
                    </div>
                    <div class="total-card">
                        <h4 data-i18n="totals.total_profit">总盈利 (总还款 - 总借出)</h4>
                        <p id="customer-total-profit">0.00</p>
                    </div>
                </div>
                <div class="timeline-actions">
                    <button type="button" class="inline-btn secondary-btn" id="view-repayment-timeline" data-i18n="button.view_repayment_timeline" disabled>查看所有还款流水</button>
                    <button type="button" class="inline-btn secondary-btn" id="view-balance-timeline" data-i18n="button.view_balance_timeline" disabled>查看复利余额流水</button>
                    <button type="button" class="inline-btn secondary-btn" id="view-all-timeline" data-i18n="button.view_all_timeline" disabled>查看全部流水</button>
                </div>
                <div class="records-grid">
                    <div id="customer-loans-section">
                        <h3 data-i18n="customer.transactions.loan_table">借贷记录</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="table.customer_loans.index">记录No.</th>
                                    <th data-i18n="table.customer_loans.code">借贷编号</th>
                                    <th data-i18n="table.customer_loans.amount">借贷金额</th>
                                    <th data-i18n="table.customer_loans.fee">手续费</th>
                                    <th data-i18n="table.customer_loans.date">借出日期</th>
                                    <th data-i18n="table.customer_loans.note">备注</th>
                                    <th data-i18n="table.customer_loans.actions">操作</th>
                                </tr>
                            </thead>
                            <tbody id="customer-loans-body">
                                <tr><td colspan="7" data-i18n="table.empty">暂无数据</td></tr>
                            </tbody>
                        </table>
                        <div class="pagination-controls" id="customer-loans-pagination"></div>
                    </div>
                    <div id="customer-repayments-section">
                        <h3 data-i18n="customer.transactions.repayment_table">还款记录</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="table.customer_repayments.index">记录No.</th>
                                    <th data-i18n="table.customer_repayments.loan_code">借贷编号</th>
                                    <th data-i18n="table.customer_repayments.amount">还款金额</th>
                                    <th data-i18n="table.customer_repayments.date">还款日期</th>
                                    <th data-i18n="table.customer_repayments.note">备注</th>
                                    <th data-i18n="table.customer_repayments.actions">操作</th>
                                </tr>
                            </thead>
                            <tbody id="customer-repayments-body">
                                <tr><td colspan="6" data-i18n="table.empty">暂无数据</td></tr>
                            </tbody>
                        </table>
                        <div class="pagination-controls" id="customer-repayments-pagination"></div>
                    </div>
                </div>
                <div id="customer-timeline-panel" class="loan-timeline-panel hidden">
                    <div class="loan-timeline-header">
                        <h3 id="customer-timeline-heading" data-i18n="timeline.view.balance">复利余额流水</h3>
                        <button type="button" class="inline-btn secondary-btn" id="customer-timeline-close" data-i18n="loan.timeline.close">关闭流水</button>
                    </div>
                    <p id="customer-timeline-title" class="loan-timeline-note"></p>
                    <p id="customer-timeline-summary" class="loan-timeline-note"></p>
                    <div class="timeline-date-filter">
                        <label>
                            <span data-i18n="customer.transactions.date_filter.start">开始日期</span>
                            <input type="date" id="timeline-start-date" lang="en-CA" placeholder="YYYY-MM-DD">
                        </label>
                        <label>
                            <span data-i18n="customer.transactions.date_filter.end">结束日期</span>
                            <input type="date" id="timeline-end-date" lang="en-CA" placeholder="YYYY-MM-DD">
                        </label>
                        <button type="button" class="inline-btn secondary-btn" id="timeline-date-reset" data-i18n="customer.transactions.date_filter.reset">清除日期</button>
                        <div class="report-quick-range" id="timeline-quick-range">
                            <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                            <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                            <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                            <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                            <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                        </div>
                    </div>
                    <div id="customer-timeline-status" class="records-status"></div>
                    <table class="loan-timeline-table">
                        <thead>
                            <tr>
                                <th data-i18n="timeline.table.time">时间</th>
                                <th data-i18n="timeline.table.type">事件</th>
                                <th data-i18n="timeline.table.loan_code">借贷编号</th>
                                <th data-i18n="timeline.table.change">变动金额</th>
                                <th data-i18n="timeline.table.balance">复利余额</th>
                                <th data-i18n="timeline.table.note">说明</th>
                            </tr>
                        </thead>
                        <tbody id="customer-timeline-body">
                            <tr><td colspan="6" data-i18n="timeline.status.empty">暂无流水记录</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-add-loan" class="content-section" data-permission="loan.manage">
                <h2 data-i18n="section.add_loan">添加借贷</h2>
                <form onsubmit="handleSubmit(event, '/api/loans')">
                    <label>
                        <span data-i18n="form.loan.customer_code">顾客编号</span>
                        <input name="customer_code" placeholder="例如 CUST-AB12CD" required>
                    </label>
                    <label>
                        <span data-i18n="form.loan.amount">金额</span>
                        <input name="loan_amount" type="number" step="0.01" required>
                    </label>
                    <label>
                        <span data-i18n="form.loan.fee">借贷手续费</span>
                        <input name="processing_fee" type="number" step="0.01" value="0">
                    </label>
                    <label>
                        <span data-i18n="form.loan.date">借出日期时间</span>
                        <input name="loan_date" type="datetime-local" data-datetime="true" lang="en-CA" required>
                    </label>
                    <label>
                        <span data-i18n="form.loan.rate">利率(%)</span>
                        <input name="interest_rate" type="number" step="0.01" value="0">
                    </label>
                    <label>
                        <span data-i18n="form.loan.type">计息方式</span>
                        <select name="interest_type" id="interest-type-select">
                            <option value="月息" data-i18n="option.interest_type.monthly">月息</option>
                            <option value="日息" data-i18n="option.interest_type.daily">日息</option>
                        </select>
                    </label>
                    <label>
                        <span data-i18n="form.loan.note">备注</span>
                        <textarea name="note"></textarea>
                    </label>
                    <button type="submit" data-i18n="button.save_loan">保存借贷</button>
                </form>
            </section>

            <section id="section-records" class="content-section" data-permission="records.view">
                <h2 data-i18n="section.records">借/还贷记录</h2>
                <div class="records-filter">
                    <label>
                        <span data-i18n="records.start_date">开始日期</span>
                        <input type="date" id="records-start-date" lang="en-CA" placeholder="YYYY-MM-DD" />
                    </label>
                    <label>
                        <span data-i18n="records.end_date">结束日期</span>
                        <input type="date" id="records-end-date" lang="en-CA" placeholder="YYYY-MM-DD" />
                    </label>
                    <button type="button" id="records-load-btn" data-i18n="button.load_records">加载记录</button>
                    <div class="report-quick-range" id="records-quick-range">
                        <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                        <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                        <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                        <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                        <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                    </div>
                </div>
                <div class="records-search">
                    <label for="records-search-input">
                        <span data-i18n="records.search.label">记录搜索</span>
                        <input type="text" id="records-search-input" data-i18n-placeholder="records.search.placeholder" placeholder="输入顾客编号或借贷编号">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="records-search-clear" data-i18n="button.clear">清除</button>
                </div>
                <div class="records-view-filter">
                    <label for="records-view-filter">
                        <span data-i18n="records.view_filter.label">记录类型</span>
                        <select id="records-view-filter">
                            <option value="all" data-i18n="records.view_filter.option.all">全部记录</option>
                            <option value="loans" data-i18n="records.view_filter.option.loans">只看借贷记录</option>
                            <option value="repayments" data-i18n="records.view_filter.option.repayments">只看还贷记录</option>
                        </select>
                    </label>
                </div>
                <div id="records-status" class="records-status" aria-live="polite"></div>
                <div class="records-overview">
                    <div class="stat-card">
                        <h4 data-i18n="stat.loan_count">借贷笔数</h4>
                        <p id="stat-loan-count">{{ (loans|length)|format_number(0) }}</p>
                    </div>
                    <div class="stat-card">
                        <h4 data-i18n="stat.loan_amount">借贷总额</h4>
                        <p id="stat-loan-amount">{{ (loans|sum(attribute='loan_amount') if loans else 0)|format_number }}</p>
                    </div>
                    <div class="stat-card">
                        <h4 data-i18n="stat.repay_count">还款笔数</h4>
                        <p id="stat-repay-count">{{ (repayments|length)|format_number(0) }}</p>
                    </div>
                    <div class="stat-card">
                        <h4 data-i18n="stat.repay_amount">还款总额</h4>
                        <p id="stat-repay-amount">{{ (repayments|sum(attribute='repayment_amount') if repayments else 0)|format_number }}</p>
                    </div>
                </div>
                <div class="records-grid">
                    <div id="records-loans-container">
                        <h3 data-i18n="records.loan_table_title">借贷记录</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="table.loans.code">借贷编号</th>
                                    <th data-i18n="table.loans.id">记录ID</th>
                                    <th data-i18n="table.loans.customer_code">顾客编号</th>
                                    <th data-i18n="table.loans.date">借出日期</th>
                                    <th data-i18n="table.loans.amount">金额</th>
                                    <th data-i18n="table.loans.fee">手续费</th>
                                    <th data-i18n="table.loans.rate">利率(%)</th>
                                    <th data-i18n="table.loans.type">计息方式</th>
                                    <th data-i18n="table.loans.note">备注</th>
                                    <th data-i18n="table.loans.created">录入时间</th>
                                </tr>
                            </thead>
                            <tbody id="records-loans-body">
                            {% for loan in loans %}
                                <tr>
                                    <td>{{ loan.loan_code or '-' }}</td>
                                    <td>{{ loan.id }}</td>
                                    <td>{{ loan.customer_code or '-' }}</td>
                                    <td>{{ loan.loan_date|myt }}</td>
                                    <td>{{ loan.loan_amount|format_number }}</td>
                                    <td>{{ loan.processing_fee|format_number }}</td>
                                    <td>{{ loan.interest_rate|format_number }}</td>
                                    <td><span data-interest-type="{{ loan.interest_type or '' }}">{{ loan.interest_type }}</span></td>
                                    <td>{{ loan.note or '-' }}</td>
                                    <td>{{ loan.created_at|myt }}</td>
                                </tr>
                            {% endfor %}
                            {% if not loans %}
                                <tr><td colspan="10" data-i18n="records.empty.loans">暂无借贷记录</td></tr>
                            {% endif %}
                            </tbody>
                        </table>
                        <div class="pagination-controls" id="records-loans-pagination"></div>
                    </div>
                    <div id="records-repayments-container">
                        <h3 data-i18n="records.repayment_table_title">还贷记录</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="table.repayments.id">ID</th>
                                    <th data-i18n="table.repayments.customer_code">顾客编号</th>
                                    <th data-i18n="table.repayments.loan_code">借贷编号</th>
                                    <th data-i18n="table.repayments.date">还款日期</th>
                                    <th data-i18n="table.repayments.amount">金额</th>
                                    <th data-i18n="table.repayments.note">备注</th>
                                    <th data-i18n="table.repayments.created">录入时间</th>
                                </tr>
                            </thead>
                            <tbody id="records-repayments-body">
                            {% for repayment in repayments %}
                                <tr>
                                    <td>{{ repayment.id }}</td>
                                    <td>{{ repayment.customer_code or '-' }}</td>
                                    <td>{{ repayment.loan_code or '-' }}</td>
                                    <td>{{ repayment.repayment_date|myt }}</td>
                                    <td>{{ repayment.repayment_amount|format_number }}</td>
                                    <td>{{ repayment.note or '-' }}</td>
                                    <td>{{ repayment.created_at|myt }}</td>
                                </tr>
                            {% endfor %}
                            {% if not repayments %}
                                <tr><td colspan="7" data-i18n="records.empty.repayments">暂无还贷记录</td></tr>
                            {% endif %}
                            </tbody>
                        </table>
                        <div class="pagination-controls" id="records-repayments-pagination"></div>
                    </div>
                </div>
            </section>

            <section id="section-bank-ledger" class="content-section" data-permission="records.view">
                <div class="section-heading">
                    <div>
                        <h2 data-i18n="section.bank_ledger">银行进出款记录</h2>
                        <p data-i18n="section.bank_ledger_desc">集中查看银行余额，并支持手动调整或追踪每一条借出/回款流水。</p>
                    </div>
                    <div class="bank-ledger-chip">
                        <span data-i18n="bank.ledger.current_balance">当前余额</span>
                        <strong id="bank-ledger-balance-chip">0.00</strong>
                    </div>
                </div>
                <div class="bank-ledger-grid">
                    <div class="bank-ledger-summary">
                        <p class="bank-ledger-summary-label" data-i18n="bank.ledger.summary.title">账户总览</p>
                        <h3 id="bank-ledger-balance" class="bank-ledger-balance">0.00</h3>
                        <p class="bank-ledger-summary-note" data-i18n="bank.ledger.summary.note">借贷发放会自动扣减，回款会自动入账。</p>
                        <div class="bank-ledger-badges">
                            <span data-i18n="bank.ledger.badge.auto">自动同步</span>
                            <span data-i18n="bank.ledger.badge.manual">支持手动调整</span>
                        </div>
                    </div>
                    <form id="bank-ledger-adjust-form" class="bank-ledger-form" data-permission="loan.manage">
                        <label>
                            <span data-i18n="bank.ledger.form.amount">调整金额</span>
                            <input type="number" step="0.01" id="bank-ledger-amount" placeholder="0.00" required>
                        </label>
                        <label>
                            <span data-i18n="bank.ledger.form.direction">调整方向</span>
                            <select id="bank-ledger-direction">
                                <option value="deposit" data-i18n="bank.ledger.form.direction.deposit">手动入账 (+)</option>
                                <option value="withdrawal" data-i18n="bank.ledger.form.direction.withdrawal">手动扣除 (-)</option>
                            </select>
                        </label>
                        <label class="bank-ledger-note-field">
                            <span data-i18n="bank.ledger.form.note">备注 (可选)</span>
                            <input type="text" id="bank-ledger-note" placeholder="例如：现金补入或手续费支出">
                        </label>
                        <div class="bank-ledger-form-actions">
                            <button type="submit" id="bank-ledger-submit" data-i18n="bank.ledger.form.submit">保存调整</button>
                            <button type="button" class="secondary-btn" id="bank-ledger-reset" data-i18n="button.clear">清除</button>
                        </div>
                        <p id="bank-ledger-adjust-status" class="records-status" aria-live="polite"></p>
                    </form>
                </div>
                <div class="bank-ledger-controls">
                    <label>
                        <span data-i18n="customer.transactions.date_filter.start">开始日期</span>
                        <input type="date" id="bank-ledger-start-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <label>
                        <span data-i18n="customer.transactions.date_filter.end">结束日期</span>
                        <input type="date" id="bank-ledger-end-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="bank-ledger-reset-dates" data-i18n="customer.transactions.date_filter.reset">清除日期</button>
                    <div class="bank-ledger-quick-range report-quick-range" id="bank-ledger-quick-range">
                        <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                        <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                        <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                        <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                        <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                    </div>
                    <label class="bank-ledger-search-field">
                        <span data-i18n="bank.ledger.filter.search">搜索银行流水</span>
                        <input type="search" id="bank-ledger-search" data-i18n-placeholder="bank.ledger.filter.search_placeholder" placeholder="输入类型、备注、顾客编号或ID">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="bank-ledger-search-clear" data-i18n="button.clear">清除</button>
                    <button type="button" id="bank-ledger-refresh" data-i18n="button.refresh">刷新</button>
                </div>
                <div id="bank-ledger-status" class="records-status" aria-live="polite"></div>
                <div class="table-scroll">
                    <table class="bank-ledger-table">
                        <thead>
                            <tr>
                                <th data-i18n="bank.ledger.table.time">时间</th>
                                <th data-i18n="bank.ledger.table.type">类型</th>
                                <th data-i18n="bank.ledger.table.reference">关联对象</th>
                                <th data-i18n="bank.ledger.table.amount">金额</th>
                                <th data-i18n="bank.ledger.table.balance">余额</th>
                                <th data-i18n="bank.ledger.table.note">备注</th>
                            </tr>
                        </thead>
                        <tbody id="bank-ledger-body">
                            <tr><td colspan="6" data-i18n="table.empty">暂无数据</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="bank-ledger-pagination"></div>
            </section>

            <section id="section-operation-logs" class="content-section" data-permission="operationlog.view">
                <h2 data-i18n="section.operation_logs">操作日志</h2>
                <p style="margin-top:0.25rem;color:#51657d;font-size:0.9rem;" data-i18n="section.operation_logs_note">记录所有顾客、借贷、还款等操作，方便追踪每次调整。</p>
                <div class="records-filter">
                    <label>
                        <span data-i18n="logs.type">对象类型</span>
                        <select id="operation-log-entity-type">
                            <option value="" data-i18n="logs.type.all">全部</option>
                            <option value="loan" data-i18n="logs.type.loan">借贷</option>
                            <option value="repayment" data-i18n="logs.type.repayment">还款</option>
                            <option value="customer" data-i18n="logs.type.customer">顾客</option>
                        </select>
                    </label>
                    <label>
                        <span data-i18n="logs.limit">显示数量</span>
                        <select id="operation-log-limit">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </label>
                    <label>
                        <span data-i18n="logs.date_filter.start">开始日期</span>
                        <input type="date" id="operation-log-start-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <label>
                        <span data-i18n="logs.date_filter.end">结束日期</span>
                        <input type="date" id="operation-log-end-date" lang="en-CA" placeholder="YYYY-MM-DD">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="operation-log-date-reset" data-i18n="customer.transactions.date_filter.reset">清除日期</button>
                    <div class="report-quick-range" id="operation-log-quick-range">
                        <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                        <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                        <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                        <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                        <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                    </div>
                    <button type="button" id="operation-log-refresh" data-i18n="button.refresh_logs">刷新</button>
                </div>
                <div id="operation-log-status" class="records-status" aria-live="polite"></div>
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="logs.table.time">时间</th>
                            <th data-i18n="logs.table.entity">对象</th>
                            <th data-i18n="logs.table.customer_code">顾客编号</th>
                            <th data-i18n="logs.table.entity_id">记录ID</th>
                            <th data-i18n="logs.table.action">动作</th>
                            <th data-i18n="logs.table.description">说明</th>
                            <th data-i18n="logs.table.metadata">详情</th>
                        </tr>
                    </thead>
                    <tbody id="operation-log-body">
                    {% for log in operation_logs %}
                        <tr>
                            <td>{{ log.created_at|myt }}</td>
                            <td data-entity-type="{{ log.entity_type or '' }}">
                                {% if log.entity_type == 'loan' %}借贷{% elif log.entity_type == 'repayment' %}还款{% elif log.entity_type == 'customer' %}顾客{% else %}{{ log.entity_type }}{% endif %}
                            </td>
                            <td>{{ log.customer_code or '-' }}</td>
                            <td>{{ log.entity_id or '-' }}</td>
                            <td>
                                {% set action_class = 'default' %}
                                {% if log.action %}
                                    {% set lower = log.action|lower %}
                                    {% if lower in ['create', 'update', 'delete'] %}
                                        {% set action_class = lower %}
                                    {% endif %}
                                {% endif %}
                                <span class="log-action {{ action_class }}">{{ log.action or '-' }}</span>
                            </td>
                            <td>{{ log.description or '-' }}</td>
                            <td class="log-metadata">
                                {% if log.metadata %}
                                    {% for key, value in log.metadata.items() %}
                                        <div><strong>{{ key }}:</strong> {{ value }}</div>
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    {% if not operation_logs %}
                        <tr><td colspan="7" data-i18n="logs.status.empty">暂无日志记录</td></tr>
                    {% endif %}
                    </tbody>
                </table>
                <div class="pagination-controls" id="operation-log-pagination"></div>
            </section>

            <section id="section-overall-report" class="content-section active overall-report-section" data-permission="reports.view">
                <div class="section-heading">
                    <div>
                        <h2 data-i18n="section.overall_report">报表总览</h2>
                        <p data-i18n="report.overall.description">按日期汇总借出/还款与盈利情况。</p>
                    </div>
                </div>
                <div class="overall-report-shell">
                    <div class="overall-filter-grid">
                        <label>
                            <span data-i18n="report.overall.start_date">开始日期</span>
                            <input type="date" id="overall-report-start-date" lang="en-CA" placeholder="YYYY-MM-DD">
                        </label>
                        <label>
                            <span data-i18n="report.overall.end_date">结束日期</span>
                            <input type="date" id="overall-report-end-date" lang="en-CA" placeholder="YYYY-MM-DD">
                        </label>
                    </div>
                    <div class="overall-filter-actions">
                        <button type="button" class="inline-btn secondary-btn" id="overall-report-reset" data-i18n="customer.transactions.date_filter.reset">清除日期</button>
                        <button type="button" id="overall-report-load" data-i18n="button.load_overall_report">加载报表</button>
                    </div>
                    <div class="overall-quick-row report-quick-range" id="overall-report-quick-range">
                        <button type="button" class="range-btn" data-range-key="today" data-i18n="date.range.today">今天</button>
                        <button type="button" class="range-btn" data-range-key="this_week" data-i18n="date.range.this_week">本周</button>
                        <button type="button" class="range-btn" data-range-key="this_month" data-i18n="date.range.this_month">本月</button>
                        <button type="button" class="range-btn" data-range-key="last_week" data-i18n="date.range.last_week">上周</button>
                        <button type="button" class="range-btn" data-range-key="last_month" data-i18n="date.range.last_month">上月</button>
                    </div>
                    <div id="overall-report-status" class="overall-status-bar records-status" data-i18n="report.overall.status.ready">请选择日期后点击“加载报表”。</div>
                    <div class="overall-report-cards" id="overall-report-cards">
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.total_customers">总用户</h4>
                            <p id="overall-report-total-customers">0</p>
                            <p class="stat-subtext"><span data-i18n="report.overall.new_customers">新增用户</span>：<span id="overall-report-new-customers">0</span></p>
                        </div>
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.total_loan_amount">总借出</h4>
                            <p id="overall-report-total-loan">0.00</p>
                            <p class="stat-subtext"><span data-i18n="report.overall.loan_count">总借出笔数</span>：<span id="overall-report-loan-count">0</span></p>
                        </div>
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.total_repayment_amount">总还款</h4>
                            <p id="overall-report-total-repayment">0.00</p>
                            <p class="stat-subtext"><span data-i18n="report.overall.repayment_count">总还款笔数</span>：<span id="overall-report-repayment-count">0</span></p>
                        </div>
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.fee_income">手续费总收入</h4>
                            <p id="overall-report-fee-income">0.00</p>
                        </div>
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.interest_profit">利息总盈利</h4>
                            <p id="overall-report-interest-profit">0.00</p>
                        </div>
                        <div class="stat-card">
                            <h4 data-i18n="report.overall.net_profit">总盈利 (总还款 - 总借出)</h4>
                            <p id="overall-report-net-profit">0.00</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-add-repayment" class="content-section" data-permission="repayment.manage">
                <h2 data-i18n="section.add_repayment">添加还款</h2>
                <form onsubmit="handleSubmit(event, '/api/repayments')">
                    <label>
                        <span data-i18n="form.repayment.customer_code">顾客编号</span>
                        <input name="customer_code" placeholder="例如 CUST-AB12CD" required>
                    </label>
                    <label>
                        <span data-i18n="form.repayment.loan_code">借贷编号</span>
                        <input name="loan_code" placeholder="例如 LN-1234-202501010101">
                    </label>
                    <label>
                        <span data-i18n="form.repayment.amount">金额</span>
                        <input name="repayment_amount" type="number" step="0.01" required>
                    </label>
                    <label>
                        <span data-i18n="form.repayment.date">还款日期时间</span>
                        <input name="repayment_date" type="datetime-local" data-datetime="true" lang="en-CA" required>
                    </label>
                    <label>
                        <span data-i18n="form.repayment.note">备注</span>
                        <textarea name="note"></textarea>
                    </label>
                    <button type="submit" data-i18n="button.save_repayment">保存还款</button>
                </form>
            </section>

            <section id="section-summary" class="content-section" data-permission="summary.view">
                <h2 data-i18n="section.summary">顾客总览</h2>
                <div class="summary-search">
                    <label for="summary-search-input">
                        <span data-i18n="summary.search.label">概览搜索</span>
                        <input type="text" id="summary-search-input" data-i18n-placeholder="summary.search.placeholder" placeholder="输入顾客编号、姓名、电话、身份证、备注或地址">
                    </label>
                    <button type="button" class="inline-btn secondary-btn" id="summary-search-clear" data-i18n="button.clear">清除</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="table.summary.customer_code">顾客编号</th>
                            <th data-i18n="table.summary.name">姓名</th>
                            <th data-i18n="table.summary.phone">电话</th>
                            <th data-i18n="table.summary.loan_total">总借出</th>
                            <th data-i18n="table.summary.repayment_total">总还款</th>
                            <th data-i18n="table.summary.fee_total">手续费</th>
                            <th data-i18n="table.summary.projected">复利余额</th>
                            <th data-i18n="table.summary.next_compound">下次结息</th>
                            <th data-i18n="table.summary.last_update">最后更新</th>
                            <th data-i18n="table.summary.created">顾客添加时间</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body">
                    {% for row in summary %}
                        <tr>
                            <td>{{ row.customer_code }}</td>
                            <td>{{ row.name }}</td>
                            <td>{{ row.phone }}</td>
                            <td>{{ row.total_loan|format_number }}</td>
                            <td>{{ row.total_repayment|format_number }}</td>
                            <td>{{ row.total_fee|format_number }}</td>
                            <td>{{ row.projected_balance|format_number }}</td>
                            <td>{{ row.next_compound_at|myt }}</td>
                            <td>{{ row.last_update|myt }}</td>
                            <td>{{ row.customer_created_at|myt }}</td>
                        </tr>
                    {% endfor %}
                    {% if not summary %}
                        <tr><td colspan="11" data-i18n="summary.empty">暂无记录</td></tr>
                    {% endif %}
                    </tbody>
                </table>
                <div class="pagination-controls" id="summary-pagination"></div>
            </section>
            {% if admin_module_enabled %}
            <section id="section-admin-access" class="content-section" data-permission="admin.manage">
                <div class="section-heading">
                    <div>
                        <h2>管理员管理</h2>
                        <p class="hero-subtitle">在此直接创建后台账号、配置权限、重置密码或切换启用状态。</p>
                    </div>
                </div>
                <div class="admin-access-grid">
                    <div class="admin-card">
                        <h3>创建后台账号</h3>
                        <form id="admin-create-form">
                            <div class="admin-form-stack">
                                <div class="admin-form-grid">
                                    <label>用户名
                                        <input name="username" required autocomplete="off" placeholder="输入邮箱或独立账号">
                                    </label>
                                    <label>初始密码
                                        <input name="password" type="password" required autocomplete="new-password">
                                    </label>
                                    <label>角色
                                        <select name="role" required id="admin-create-role">
                                            {% for role in admin_staff_roles %}
                                                <option value="{{ role.value }}">{{ role.value }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                </div>
                                <p class="admin-role-note" id="admin-create-role-note">非 admin 账号可自定义权限，admin 自动拥有全部权限。</p>
                                <div class="admin-permission-grid" data-permission-grid="create"></div>
                            </div>
                            <p class="admin-status" id="admin-create-status" aria-live="polite"></p>
                            <div class="admin-button-row">
                                <button type="submit">创建账号</button>
                                <button type="button" class="secondary-btn" id="admin-reset-create">重置表单</button>
                            </div>
                        </form>
                    </div>
                    <div class="admin-card">
                        <h3>现有账号</h3>
                        <div class="admin-user-list" id="admin-user-list"></div>
                        <div class="admin-empty" id="admin-user-empty" hidden>尚未创建后台账号。</div>
                    </div>
                    <div class="admin-card">
                        <h3>账号详情</h3>
                        <form id="admin-edit-form">
                            <div class="admin-form-stack">
                                <p class="admin-role-note">选择左侧账号后可修改信息与权限。</p>
                                <div class="admin-form-grid">
                                    <label>用户名
                                        <input name="username" required autocomplete="off">
                                    </label>
                                    <label>角色
                                        <select name="role" required id="admin-edit-role">
                                            {% for role in admin_staff_roles %}
                                                <option value="{{ role.value }}">{{ role.value }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    <label>启用状态
                                        <select name="is_active">
                                            <option value="true">启用</option>
                                            <option value="false">禁用</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="admin-permission-grid" data-permission-grid="edit"></div>
                            </div>
                            <p class="admin-status" id="admin-edit-status" aria-live="polite"></p>
                            <div class="admin-button-row">
                                <button type="submit">保存变更</button>
                                <button type="button" class="secondary-btn" id="admin-reset-password">重置密码</button>
                                <button type="button" class="danger-btn" id="admin-remove-selection">取消选择</button>
                            </div>
                        </form>
                    </div>
                </div>
                <script id="admin-users-data" type="application/json">{{ admin_users_payload | tojson }}</script>
                <script id="admin-permissions-data" type="application/json">{{ admin_permissions_payload | tojson }}</script>
            </section>
            {% endif %}
        </main>
    </div>

    <div id="customer-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-card">
            <h3 id="customer-modal-title">编辑顾客</h3>
            <form id="customer-modal-form" class="modal-grid">
                <label data-field-group="name">
                    <span data-i18n="form.customer.name">姓名</span>
                    <input type="text" name="name" />
                </label>
                <label data-field-group="phone">
                    <span data-i18n="form.customer.phone">电话</span>
                    <input type="text" name="phone" />
                </label>
                <label data-field-group="address">
                    <span data-i18n="form.customer.address">地址</span>
                    <input type="text" name="address" />
                </label>
                <label data-field-group="id_card">
                    <span data-i18n="form.customer.id_card">身份证</span>
                    <input type="text" name="id_card" />
                </label>
                <label data-field-group="note" class="full-width">
                    <span data-i18n="form.customer.note">备注</span>
                    <textarea name="note"></textarea>
                </label>
            </form>
            <div class="modal-actions">
                <button type="button" class="inline-btn secondary-btn" id="customer-modal-cancel" data-i18n="button.cancel">取消</button>
                <button type="submit" class="inline-btn" form="customer-modal-form" data-i18n="button.save">保存</button>
            </div>
        </div>
    </div>

    <div id="balance-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-card">
            <h3 data-i18n="modal.balance.title">手动调整复利余额</h3>
            <form id="customer-balance-form" class="modal-grid">
                <p class="full-width"><span data-i18n="modal.balance.current">当前复利余额：</span><strong id="balance-modal-current">0.00</strong></p>
                <label class="full-width">
                    <span data-i18n="modal.balance.loan_code">关联借贷（必填）</span>
                    <select name="loan_code" required>
                        <option value="" data-i18n="modal.balance.loan_code_placeholder">请选择借贷编号</option>
                    </select>
                </label>
                <label class="full-width">
                    <span data-i18n="modal.balance.adjust_amount">调整金额 (可为负数)</span>
                    <input type="number" name="adjust_amount" step="0.01" value="0">
                </label>
                <label class="full-width">
                    <span data-i18n="modal.balance.new_balance">或设置新的复利余额</span>
                    <input type="number" name="projected_balance" step="0.01" data-i18n-placeholder="placeholder.balance_new" placeholder="留空则使用调整金额">
                </label>
                <label class="full-width">
                    <span data-i18n="modal.balance.next_compound">下次结息时间 (可选)</span>
                    <input type="datetime-local" name="next_compound_at">
                </label>
                <small class="full-width" data-i18n="modal.balance.tip">若填写“新的复利余额”，系统将直接使用该值；否则会在当前复利余额基础上加上“调整金额”。</small>
            </form>
            <div class="modal-actions">
                <button type="button" class="inline-btn secondary-btn" id="balance-modal-cancel" data-i18n="button.cancel">取消</button>
                <button type="submit" class="inline-btn" form="customer-balance-form" data-i18n="button.save_balance">保存</button>
            </div>
        </div>
    </div>

    <div id="photo-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-card">
            <h3 id="photo-modal-title" data-i18n="modal.photo.title">上传顾客照片</h3>
            <form id="customer-photo-form" class="modal-grid">
                <label class="full-width">
                    <span data-i18n="modal.photo.select_image">选择图片</span>
                    <input type="file" name="photo" accept="image/*" required>
                </label>
                <div class="photo-modal-preview full-width">
                    <img id="photo-modal-preview" data-i18n-alt="label.photo_modal_preview" alt="预览" style="display:none;">
                </div>
            </form>
            <div class="modal-actions">
                <button type="button" class="inline-btn secondary-btn" id="photo-modal-cancel" data-i18n="button.cancel">取消</button>
                <button type="submit" class="inline-btn" form="customer-photo-form" data-i18n="button.upload">上传</button>
            </div>
        </div>
    </div>

    <script id="customers-data" type="application/json">{{ customers_payload|tojson }}</script>
    <script id="summary-data" type="application/json">{{ summary_payload|tojson }}</script>
    <script id="loans-data" type="application/json">{{ loans_payload|tojson }}</script>
    <script id="repayments-data" type="application/json">{{ repayments_payload|tojson }}</script>
    <script id="operation-logs-data" type="application/json">{{ operation_logs_payload|tojson }}</script>
</body>
</html>
